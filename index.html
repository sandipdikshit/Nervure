<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NERVURE — CPG Financial Operating System · Veridian Hedging Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   NERVURE v2 — Premium CPG Financial Operating System
   Design System: Refined Obsidian × Teal × Gold
   ═══════════════════════════════════════════════════════════════════════════ */

:root {
  --teal: #0D9488;
  --teal-l: #14B8A6;
  --teal-xl: #5EEAD4;
  --teal-dim: #CCFBF1;
  --teal-bg: #F0FDFA;
  --teal-glow: rgba(13,148,136,.08);
  --teal-glow-s: rgba(13,148,136,.04);

  --gold: #D4AF37;
  --gold-light: #F4E5B0;
  --gold-dark: #B8941F;
  --gold-glow: rgba(212,175,55,.12);

  --ink: #0A1A18;
  --ink-mid: #1E3A36;
  --ink-soft: #4A6B67;
  --ink-faint: #8FADA9;
  --ink-ghost: #C5DAD8;
  --surface: #FFFFFF;
  --surface-alt: #F8FFFE;
  --surface-raised: #FFFFFF;
  --border: rgba(13,148,136,.12);
  --border-m: rgba(13,148,136,.22);
  --border-s: rgba(13,148,136,.07);

  --green: #10B981;
  --green-bg: rgba(16,185,129,.08);
  --amber: #F59E0B;
  --amber-bg: rgba(245,158,11,.08);
  --red: #EF4444;
  --red-bg: rgba(239,68,68,.08);
  --blue: #3B82F6;
  --blue-bg: rgba(59,130,246,.08);
  --purple: #8B5CF6;
  --purple-bg: rgba(139,92,246,.08);

  --shadow-xs: 0 1px 2px rgba(0,0,0,.04);
  --shadow-s: 0 1px 3px rgba(0,0,0,.04), 0 4px 12px rgba(13,148,136,.06);
  --shadow-m: 0 2px 8px rgba(0,0,0,.06), 0 12px 32px rgba(13,148,136,.09);
  --shadow-l: 0 4px 24px rgba(0,0,0,.08), 0 20px 60px rgba(13,148,136,.12);
  --shadow-card: 0 0 0 1px rgba(13,148,136,.08), 0 2px 8px rgba(0,0,0,.05);

  --r6: 6px;
  --r8: 8px;
  --r10: 10px;
  --r12: 12px;
  --r14: 14px;
  --r16: 16px;
  --r20: 20px;
  --r24: 24px;

  --sidebar-w: 268px;
  --sidebar-collapsed-w: 70px;
  --topbar-h: 60px;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
  --transition-slow: 0.35s cubic-bezier(0.4,0,0.2,1);
  --sb-expand-ease: cubic-bezier(0.4,0,0.2,1);

  /* ── PRICEOS ACCENT — only used on pricing actions ── */
  --pink: #ff2d78;
  --pink-l: #ff6b9d;
  --pink-bg: rgba(255,45,120,0.08);
  --pink-glow: rgba(255,45,120,0.15);
  --pink-border: rgba(255,45,120,0.25);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; width: 100%; overflow: hidden; }

body {
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
  background: var(--surface-alt);
  color: var(--ink);
  font-size: 13.5px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.55;
  font-feature-settings: 'kern' 1, 'liga' 1;
}

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--teal-dim); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--ink-ghost); }

/* ── ANIMATIONS ─────────────────────────────────────────────────────────── */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-16px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(16px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.96); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes pulse-dot {
  0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,.5); }
  50% { box-shadow: 0 0 0 5px rgba(16,185,129,0); }
}
@keyframes shimmer {
  from { background-position: -200% 0; }
  to { background-position: 200% 0; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes progressIn {
  from { width: 0; }
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
@keyframes numberCountUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes glowPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.animate-in { animation: fadeUp 0.38s cubic-bezier(0.4,0,0.2,1) both; will-change: transform, opacity; }
.animate-in-delay-1 { animation: fadeUp 0.38s cubic-bezier(0.4,0,0.2,1) 0.06s both; }
.animate-in-delay-2 { animation: fadeUp 0.38s cubic-bezier(0.4,0,0.2,1) 0.12s both; }
.animate-in-delay-3 { animation: fadeUp 0.38s cubic-bezier(0.4,0,0.2,1) 0.18s both; }
.animate-in-delay-4 { animation: fadeUp 0.38s cubic-bezier(0.4,0,0.2,1) 0.24s both; }

/* ── LAYOUT ─────────────────────────────────────────────────────────────── */
#app { display: flex; height: 100vh; overflow: hidden; position: relative; }

/* ── SIDEBAR ────────────────────────────────────────────────────────────── */
#sidebar {
  width: var(--sidebar-collapsed-w);
  min-width: var(--sidebar-collapsed-w);
  background: var(--ink);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  z-index: 30;
  transition: width 0.35s var(--sb-expand-ease), min-width 0.35s var(--sb-expand-ease);
  border-right: 1px solid rgba(13,148,136,0.15);
  flex-shrink: 0;
}

#sidebar.sb-expanded {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  border-right-color: transparent;
}

/* Sidebar collapse: shared transition base for all text/label elements */
.sb-brand-text,
.nav-label,
.nav-badge,
.pricing-os-badge,
.sb-user-info,
.sb-settings-btn,
.sb-copy-text,
.sb-new-badge,
.comm-mini-name,
.comm-mini-val {
  opacity: 0;
  max-width: 0;
  overflow: hidden;
  white-space: nowrap;
  transform: translateX(-6px);
  transition:
    opacity 0.28s var(--sb-expand-ease),
    max-width 0.35s var(--sb-expand-ease),
    transform 0.28s var(--sb-expand-ease);
  pointer-events: none;
  flex-shrink: 0;
}

#sidebar.sb-expanded .sb-brand-text,
#sidebar.sb-expanded .nav-label,
#sidebar.sb-expanded .nav-badge,
#sidebar.sb-expanded .pricing-os-badge,
#sidebar.sb-expanded .sb-user-info,
#sidebar.sb-expanded .sb-settings-btn,
#sidebar.sb-expanded .sb-copy-text,
#sidebar.sb-expanded .sb-new-badge,
#sidebar.sb-expanded .comm-mini-name,
#sidebar.sb-expanded .comm-mini-val {
  opacity: 1;
  max-width: 220px;
  transform: translateX(0);
  pointer-events: auto;
  transition:
    opacity 0.32s var(--sb-expand-ease) 0.05s,
    max-width 0.35s var(--sb-expand-ease),
    transform 0.3s var(--sb-expand-ease) 0.05s;
}

/* Section labels: height + opacity collapse only */
.sb-section-label {
  max-height: 0;
  opacity: 0;
  padding-top: 0;
  padding-bottom: 0;
  overflow: hidden;
  font-size: 0; /* collapse text during animation to prevent reflow pop */
  transition:
    opacity 0.3s var(--sb-expand-ease),
    max-height 0.35s var(--sb-expand-ease),
    padding 0.3s var(--sb-expand-ease),
    font-size 0s var(--sb-expand-ease) 0.35s; /* delay until fully hidden */
}

#sidebar.sb-expanded .sb-section-label {
  max-height: 48px;
  opacity: 1;
  padding-top: 14px;
  padding-bottom: 6px;
  transition:
    opacity 0.32s var(--sb-expand-ease) 0.04s,
    max-height 0.32s var(--sb-expand-ease),
    padding 0.32s var(--sb-expand-ease);
}

#sidebar::before {
  content: '';
  position: absolute;
  top: -60px; right: -60px;
  width: 200px; height: 200px;
  background: radial-gradient(circle, rgba(13,148,136,.14) 0%, transparent 70%);
  pointer-events: none;
  animation: glowPulse 4s ease-in-out infinite;
}

#sidebar::after {
  content: '';
  position: absolute;
  bottom: 60px; left: -40px;
  width: 160px; height: 160px;
  background: radial-gradient(circle, rgba(212,175,55,.07) 0%, transparent 70%);
  pointer-events: none;
}

/* Sidebar Logo */
.sb-logo {
  padding: 18px 16px 14px;
  border-bottom: 1px solid rgba(255,255,255,.05);
  position: relative;
  z-index: 1;
  display: flex;
  align-items: center;
  gap: 0;
  cursor: pointer;
  transition: padding var(--transition-slow), gap var(--transition-slow);
  overflow: hidden;
  min-height: 72px;
  justify-content: center;
}

#sidebar.sb-expanded .sb-logo {
  gap: 12px;
  padding: 20px 18px 16px;
  justify-content: flex-start;
}

.sb-logo-mark {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--teal) 0%, #0FA89D 50%, #14B8A6 100%);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 800; color: #fff;
  letter-spacing: -0.03em;
  box-shadow: 0 4px 14px rgba(13,148,136,.4), inset 0 1px 0 rgba(255,255,255,.2);
  flex-shrink: 0;
  transition: var(--transition);
}

.sb-logo:hover .sb-logo-mark { transform: scale(1.04); }

.sb-brand-name {
  font-size: 18px; font-weight: 800;
  background: linear-gradient(130deg, var(--teal-xl) 0%, #FFFFFF 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.04em;
}
.sb-brand-tagline {
  font-size: 9.5px; color: rgba(255,255,255,.28);
  letter-spacing: 0.14em; text-transform: uppercase;
  margin-top: 1px;
}

/* Sidebar nav */
.sb-nav { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 10px 0; }

.sb-section-label {
  font-size: 9.5px; font-weight: 700;
  color: rgba(255,255,255,.2);
  letter-spacing: 0.14em; text-transform: uppercase;
  padding: 14px 18px 6px;
  position: relative;
  z-index: 1;
}

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 0;
  margin: 1px 8px;
  border-radius: var(--r10);
  cursor: pointer;
  transition: background var(--transition), color var(--transition), padding var(--transition-slow), border-color var(--transition), gap var(--transition-slow);
  color: rgba(255,255,255,.36);
  font-size: 13.5px; font-weight: 500;
  position: relative;
  user-select: none;
  border: 1px solid transparent;
  justify-content: center;
}

#sidebar.sb-expanded .nav-item {
  padding: 9px 14px;
  justify-content: flex-start;
  margin: 1px 10px;
}

.nav-item:hover {
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.6);
  border-color: rgba(255,255,255,.04);
}

/* Collapsed hover: teal icon glow */
#sidebar:not(.sb-expanded) .nav-item:hover {
  background: rgba(13,148,136,.12);
  border-color: rgba(13,148,136,.18);
  color: var(--teal-xl);
  box-shadow: 0 0 12px rgba(13,148,136,.1);
}

.nav-item.active {
  background: linear-gradient(90deg, rgba(13,148,136,.18), rgba(13,148,136,.08));
  color: var(--teal-xl);
  font-weight: 600;
  border-color: rgba(13,148,136,.2);
}

/* Collapsed active: brighter teal indicator */
#sidebar:not(.sb-expanded) .nav-item.active {
  background: rgba(13,148,136,.2);
  box-shadow: 0 0 14px rgba(13,148,136,.15);
}

.nav-item.active::before {
  content: '';
  position: absolute; left: -8px; top: 50%;
  transform: translateY(-50%);
  width: 3px; height: 20px;
  background: var(--teal);
  border-radius: 0 2px 2px 0;
  transition: left var(--transition-slow), height var(--transition-slow);
}

#sidebar.sb-expanded .nav-item.active::before {
  left: -10px;
}

.nav-icon {
  font-size: 16px; width: 22px; text-align: center; flex-shrink: 0;
  transition: transform var(--transition);
}

#sidebar:not(.sb-expanded) .nav-item:hover .nav-icon {
  transform: scale(1.15);
}

.nav-label { flex: 1; flex-shrink: 0; }

.nav-badge {
  font-size: 9px; font-weight: 700;
  padding: 2px 6px; border-radius: 20px;
  background: var(--red); color: #fff;
  letter-spacing: 0.04em;
  animation: pulse-dot 2.5s ease-in-out infinite;
  flex-shrink: 0;
}
.nav-badge.amber { background: var(--amber); color: var(--ink); animation: none; }
.nav-badge.green { background: var(--green); animation: none; }
.nav-badge.teal { background: var(--teal); animation: none; }

/* Sidebar commodity list */
.sb-comm-section { border-top: 1px solid rgba(255,255,255,.04); margin-top: 4px; }
.comm-mini {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 18px;
  cursor: pointer;
  transition: background var(--transition), padding var(--transition-slow), justify-content var(--transition-slow);
  justify-content: center;
}
#sidebar.sb-expanded .comm-mini { justify-content: flex-start; padding: 6px 18px; }
.comm-mini:hover { background: rgba(255,255,255,.03); }
.comm-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.comm-mini-name { font-size: 11.5px; color: rgba(255,255,255,.35); flex: 1; flex-shrink: 0; }
.comm-mini-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10.5px; font-weight: 600;
  flex-shrink: 0;
}

/* Sidebar bottom */
.sb-bottom {
  padding: 14px 8px;
  border-top: 1px solid rgba(255,255,255,.05);
  display: flex; align-items: center; gap: 0;
  position: relative; z-index: 1;
  cursor: pointer;
  transition: background var(--transition), padding var(--transition-slow), gap var(--transition-slow);
  justify-content: center;
  overflow: hidden;
}
#sidebar.sb-expanded .sb-bottom {
  padding: 14px 18px;
  gap: 10px;
  justify-content: flex-start;
}
.sb-bottom:hover { background: rgba(255,255,255,.03); }

.avatar {
  width: 34px; height: 34px; border-radius: 50%;
  background: linear-gradient(135deg, var(--teal), var(--teal-l));
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(13,148,136,.3);
  transition: transform var(--transition), box-shadow var(--transition);
}
#sidebar:not(.sb-expanded) .sb-bottom:hover .avatar {
  transform: scale(1.08);
  box-shadow: 0 0 16px rgba(13,148,136,.45);
}

.sb-user-info { display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
.sb-user-name { font-size: 13px; color: rgba(255,255,255,.85); font-weight: 600; white-space: nowrap; }
.sb-user-role { font-size: 10.5px; color: rgba(255,255,255,.35); margin-top: 1px; white-space: nowrap; }
.sb-settings-btn {
  margin-left: auto; font-size: 16px; color: rgba(255,255,255,.25);
  cursor: pointer; transition: color var(--transition), background var(--transition);
  padding: 4px; border-radius: 6px; flex-shrink: 0;
}
.sb-settings-btn:hover { color: rgba(255,255,255,.6); background: rgba(255,255,255,.05); }

/* ── Copyright footer ── */
.sb-copyright {
  padding: 8px 10px 12px;
  border-top: 1px solid rgba(255,255,255,.04);
  text-align: center;
  position: relative; z-index: 1;
  overflow: hidden;
}
.sb-copy-fixed {
  font-size: 9px;
  color: rgba(255,255,255,.22);
  letter-spacing: 0.08em;
  line-height: 1.7;
  white-space: nowrap;
}
.sb-copy-text {
  font-size: 8.5px;
  color: rgba(255,255,255,.14);
  letter-spacing: 0.06em;
  line-height: 1.6;
}

/* Tooltip for collapsed nav items */
.nav-tooltip {
  position: fixed;
  left: calc(var(--sidebar-collapsed-w) + 8px);
  background: var(--ink-mid);
  color: rgba(255,255,255,.9);
  font-size: 12px; font-weight: 600;
  padding: 5px 10px;
  border-radius: var(--r8);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 4px 16px rgba(0,0,0,.3);
  pointer-events: none;
  z-index: 200;
  white-space: nowrap;
  opacity: 0;
  transform: translateX(-4px);
  transition: opacity 0.15s, transform 0.15s;
}
.nav-tooltip.visible {
  opacity: 1;
  transform: translateX(0);
}

/* ── MAIN ───────────────────────────────────────────────────────────────── */
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; transition: none; }

/* ── TOPBAR ─────────────────────────────────────────────────────────────── */
#topbar {
  height: var(--topbar-h);
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 24px; gap: 12px;
  z-index: 20; flex-shrink: 0;
  position: relative;
}

.topbar-breadcrumb {
  display: flex; align-items: center; gap: 6px;
  font-size: 13px; color: var(--ink-soft);
}
.topbar-breadcrumb strong { color: var(--ink); font-weight: 600; }
.topbar-breadcrumb span { color: var(--ink-ghost); }

.search-trigger {
  flex: 1; max-width: 340px;
  display: flex; align-items: center; gap: 8px;
  background: var(--teal-glow-s);
  border: 1px solid var(--border);
  border-radius: var(--r10);
  padding: 8px 14px;
  cursor: pointer;
  transition: var(--transition);
  margin: 0 4px;
}
.search-trigger:hover { border-color: var(--border-m); background: var(--teal-glow); }
.search-icon { font-size: 14px; color: var(--teal); }
.search-placeholder { font-size: 12.5px; color: var(--ink-faint); flex: 1; }
.search-kbd {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; color: var(--ink-ghost);
  background: var(--surface-alt); border: 1px solid var(--border);
  padding: 2px 5px; border-radius: 4px;
}

.tb-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }

.live-pill {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 12px;
  background: rgba(16,185,129,.07);
  border: 1px solid rgba(16,185,129,.18);
  border-radius: var(--r8);
  cursor: default;
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green);
  animation: pulse-dot 2s ease-in-out infinite;
}
.live-txt { font-size: 12px; color: var(--green); font-weight: 700; letter-spacing: 0.02em; }

.topbar-chip {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r8);
  font-size: 11.5px; color: var(--ink-soft);
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  cursor: default;
  transition: var(--transition);
}

.topbar-chip.teal { color: var(--teal); background: var(--teal-glow); border-color: var(--border-m); }

.topbar-icon-btn {
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  border-radius: var(--r8);
  cursor: pointer;
  transition: var(--transition);
  font-size: 16px;
  color: var(--ink-soft);
  position: relative;
  border: 1px solid transparent;
}
.topbar-icon-btn:hover { background: var(--teal-glow); border-color: var(--border); color: var(--teal); }

.notif-badge {
  position: absolute; top: 3px; right: 3px;
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--red);
  border: 1.5px solid var(--surface);
}

/* ── CONTENT ─────────────────────────────────────────────────────────────── */
#content {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  padding: 24px 24px 16px;
  scroll-behavior: smooth;
}

/* ── CARDS ──────────────────────────────────────────────────────────────── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r16);
  box-shadow: var(--shadow-card);
  transition: box-shadow var(--transition), border-color var(--transition), transform var(--transition);
  will-change: transform;
}
.card:hover { box-shadow: var(--shadow-m); border-color: var(--border-m); }
.card-hover-lift:hover { transform: translateY(-2px); }

.card-header {
  padding: 18px 22px 14px;
  border-bottom: 1px solid var(--border-s);
}
.card-title { font-size: 15.5px; color: var(--ink); font-weight: 700; line-height: 1.2; letter-spacing: -0.01em; }
.card-sub { font-size: 12px; color: var(--ink-soft); margin-top: 3px; }

/* ── GRIDS ──────────────────────────────────────────────────────────────── */
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.g4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
.g5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; }
.g-main { display: grid; grid-template-columns: 1fr 330px; gap: 16px; }
.g-main-l { display: grid; grid-template-columns: 260px 1fr; gap: 16px; }
.g-content { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* ── KPI CARDS ──────────────────────────────────────────────────────────── */
.kpi {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r14);
  padding: 18px 20px;
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.07),
    0 2px 10px rgba(13,148,136,0.06),
    inset 0 1px 0 rgba(255,255,255,0.92);
  transition: box-shadow 0.3s cubic-bezier(0.23,1,0.32,1), transform 0.3s cubic-bezier(0.23,1,0.32,1);
  cursor: default;
  position: relative;
  overflow: hidden;
}
.kpi::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--kpi-accent, var(--teal));
  border-radius: 2px 2px 0 0;
  opacity: 0.7;
}
.kpi:hover {
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.14),
    0 6px 24px rgba(13,148,136,0.11),
    inset 0 1px 0 rgba(255,255,255,1);
  transform: translateY(-1.5px);
}

.kpi-label {
  font-size: 10.5px; color: var(--ink-faint);
  font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
  margin-bottom: 10px;
}
.kpi-val {
  font-size: 26px; color: var(--ink);
  font-weight: 800; line-height: 1;
  letter-spacing: -0.01em;
}
.kpi-delta {
  display: inline-flex; align-items: center; gap: 3px;
  font-size: 12px; font-weight: 700;
  padding: 3px 7px; border-radius: 5px;
  margin-top: 8px;
}
.kpi-delta.up { background: var(--green-bg); color: var(--green); }
.kpi-delta.down { background: var(--red-bg); color: var(--red); }
.kpi-delta.neutral { background: var(--teal-glow); color: var(--teal); }
.kpi-sub { font-size: 11px; color: var(--ink-faint); margin-top: 6px; }

/* ── BUTTONS ─────────────────────────────────────────────────────────────── */
.btn {
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
  font-size: 13px; font-weight: 700;
  padding: 9px 18px;
  border-radius: var(--r10);
  border: none; cursor: pointer;
  transition: var(--transition);
  letter-spacing: 0.02em;
  display: inline-flex; align-items: center; gap: 6px;
  white-space: nowrap;
}
.btn:active { transform: scale(0.97); }

.btn-primary {
  background: linear-gradient(135deg, var(--teal) 0%, var(--teal-l) 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(13,148,136,.3);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(13,148,136,.4); }

.btn-gold {
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  color: var(--ink);
  box-shadow: 0 2px 8px rgba(212,175,55,.25);
}
.btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(212,175,55,.4); }

.btn-ghost {
  background: transparent;
  color: var(--teal);
  border: 1px solid var(--border-m);
}
.btn-ghost:hover { background: var(--teal-glow); border-color: var(--teal); }

.btn-dark {
  background: rgba(255,255,255,.1);
  color: rgba(255,255,255,.7);
  border: 1px solid rgba(255,255,255,.12);
}
.btn-dark:hover { background: rgba(255,255,255,.15); color: rgba(255,255,255,.9); }

.btn-sm { padding: 6px 13px; font-size: 12px; border-radius: var(--r8); }
.btn-xs { padding: 4px 10px; font-size: 11px; border-radius: 6px; }

/* ── BADGES ──────────────────────────────────────────────────────────────── */
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 3px 8px; border-radius: 5px;
  font-size: 11px; font-weight: 700;
  letter-spacing: 0.04em; white-space: nowrap;
}
.badge-buy   { background: var(--green-bg); color: var(--green); border: 1px solid rgba(16,185,129,.2); }
.badge-hold  { background: var(--amber-bg); color: var(--amber); border: 1px solid rgba(245,158,11,.2); }
.badge-sell  { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,.2); }
.badge-teal  { background: var(--teal-glow); color: var(--teal); border: 1px solid rgba(13,148,136,.2); }
.badge-blue  { background: var(--blue-bg); color: var(--blue); border: 1px solid rgba(59,130,246,.2); }
.badge-purple{ background: var(--purple-bg); color: var(--purple); border: 1px solid rgba(139,92,246,.2); }
.badge-amber { background: var(--amber-bg); color: var(--amber); border: 1px solid rgba(245,158,11,.2); }
.badge-red   { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,.2); }
.badge-gold  { background: var(--gold-glow); color: var(--gold-dark); border: 1px solid rgba(212,175,55,.3); }
.badge-dark  { background: rgba(10,26,24,.8); color: rgba(255,255,255,.7); border: 1px solid rgba(255,255,255,.1); }

/* ══════════════════════════════════════════════════════════════════════════
   GLASS-LIQUID SYSTEM — Obsidian depth layer
   RULE: Only applied to elements on dark surfaces. On light surfaces we
   use --glass-lift (elevation via shadow) instead of backdrop-filter.
   ══════════════════════════════════════════════════════════════════════════ */

/* 3D context required for translateZ to work */
.glass-stage { perspective: 900px; transform-style: preserve-3d; }

/* Core glass — for dark hero panels and dark-background widgets */
.glass-liquid {
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
  border: 1px solid rgba(255,255,255,0.13);
  box-shadow:
    0 8px 32px rgba(0,0,0,0.35),
    inset 0 1px 0 rgba(255,255,255,0.18),
    inset 0 -1px 0 rgba(0,0,0,0.18);
  border-radius: var(--r14);
  transition: transform 0.4s cubic-bezier(0.23,1,0.32,1), box-shadow 0.4s cubic-bezier(0.23,1,0.32,1);
}

/* Profit state — floats forward, green glow */
.glass-liquid.profit {
  transform: translateZ(10px) scale(1.01);
  box-shadow:
    0 20px 56px rgba(16,185,129,0.22),
    inset 0 2px 0 rgba(255,255,255,0.28),
    inset 0 -1px 0 rgba(0,0,0,0.15);
  border-color: rgba(16,185,129,0.35);
}

/* Loss state — recedes */
.glass-liquid.loss {
  transform: translateZ(-4px) scale(0.995);
  box-shadow:
    0 4px 16px rgba(239,68,68,0.15),
    inset 0 1px 0 rgba(255,255,255,0.08);
  border-color: rgba(239,68,68,0.25);
}

/* Neutral glass hover */
.glass-liquid:hover:not(.profit):not(.loss) {
  transform: translateZ(6px);
  box-shadow:
    0 12px 40px rgba(0,0,0,0.4),
    inset 0 1.5px 0 rgba(255,255,255,0.22),
    inset 0 -1px 0 rgba(0,0,0,0.2);
}

/* Light-surface lift — for white cards that want premium depth without blur */
.glass-lift {
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.1),
    0 4px 16px rgba(13,148,136,0.08),
    0 1px 3px rgba(0,0,0,0.04),
    inset 0 1px 0 rgba(255,255,255,0.9);
  transition: box-shadow 0.3s cubic-bezier(0.23,1,0.32,1), transform 0.3s cubic-bezier(0.23,1,0.32,1);
}
.glass-lift:hover {
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.18),
    0 8px 28px rgba(13,148,136,0.13),
    0 2px 8px rgba(0,0,0,0.06),
    inset 0 1px 0 rgba(255,255,255,1);
  transform: translateY(-2px);
}
.glass-lift.profit-lift {
  box-shadow:
    0 0 0 1px rgba(16,185,129,0.2),
    0 6px 24px rgba(16,185,129,0.14),
    inset 0 1px 0 rgba(255,255,255,1);
}

/* ── PRICE REFLECTION CANVAS ─────────────────────────────────────────────── */
#hero-reflection {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 80px;
  pointer-events: none;
  opacity: 0.18;
  mask-image: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
  -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
  z-index: 0;
}

/* ── WATCH CYCLE PANEL ───────────────────────────────────────────────────── */
.watch-cycle-bar {
  background: rgba(10,26,24,0.97);
  border: 1px solid rgba(13,148,136,0.2);
  border-radius: var(--r14);
  padding: 14px 20px;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 0;
  overflow: hidden;
  position: relative;
}
.watch-cycle-bar::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(90deg, rgba(13,148,136,0.04) 0%, transparent 60%);
  pointer-events: none;
}
.wc-label {
  font-size: 10px; font-weight: 800; color: var(--teal-xl);
  letter-spacing: .12em; text-transform: uppercase;
  flex-shrink: 0; margin-right: 20px;
  display: flex; align-items: center; gap: 6px;
}
.wc-pulse {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--teal-xl);
  box-shadow: 0 0 0 0 rgba(94,234,212,0.5);
  animation: wc-ping 2s ease-in-out infinite;
}
@keyframes wc-ping {
  0%   { box-shadow: 0 0 0 0 rgba(94,234,212,0.6); }
  70%  { box-shadow: 0 0 0 7px rgba(94,234,212,0); }
  100% { box-shadow: 0 0 0 0 rgba(94,234,212,0); }
}
.wc-agents {
  display: flex; align-items: center; gap: 0; flex: 1;
}
.wc-agent {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  border-radius: var(--r8);
  font-size: 11.5px; font-weight: 600;
  color: rgba(255,255,255,0.35);
  transition: var(--transition);
  position: relative; flex-shrink: 0;
}
.wc-agent.done   { color: var(--teal-xl); }
.wc-agent.active { color: white; background: rgba(13,148,136,0.18); border: 1px solid rgba(13,148,136,0.3); }
.wc-agent.pending{ color: rgba(255,255,255,0.2); }
.wc-agent-icon { font-size: 15px; }
.wc-check { color: var(--teal); font-size: 11px; font-weight: 900; }
.wc-arrow {
  color: rgba(255,255,255,0.12); font-size: 14px; margin: 0 2px; flex-shrink: 0;
}
.wc-timer {
  flex-shrink: 0; margin-left: 20px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; color: rgba(255,255,255,0.3);
  display: flex; align-items: center; gap: 6px;
}
.wc-timer strong { color: rgba(255,255,255,0.6); }
.wc-autopilot-btn {
  flex-shrink: 0; margin-left: 12px;
  padding: 5px 13px; border-radius: var(--r8);
  background: rgba(13,148,136,0.2); border: 1px solid rgba(13,148,136,0.35);
  color: var(--teal-xl); font-size: 11px; font-weight: 700;
  cursor: pointer; transition: var(--transition); letter-spacing: .04em;
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
}
.wc-autopilot-btn.on  { background: var(--teal); color: white; border-color: var(--teal); }
.wc-autopilot-btn:hover { opacity: 0.85; }

/* ── HERO BANNER ─────────────────────────────────────────────────────────── */
.hero {
  background: linear-gradient(135deg, var(--ink) 0%, #1A3835 60%, #0D2E2B 100%);
  border-radius: var(--r20);
  padding: 28px 32px;
  margin-bottom: 20px;
  position: relative; overflow: hidden;
  animation: fadeUp 0.4s ease both;
}

.hero::after {
  content: '';
  position: absolute; top: -60px; right: -60px;
  width: 260px; height: 260px;
  background: radial-gradient(circle, rgba(13,148,136,.2) 0%, transparent 70%);
  pointer-events: none; animation: glowPulse 5s ease-in-out infinite;
}

.hero::before {
  content: '';
  position: absolute; bottom: -30px; left: 40%;
  width: 180px; height: 180px;
  background: radial-gradient(circle, rgba(212,175,55,.12) 0%, transparent 70%);
  pointer-events: none;
}

.hero-content { position: relative; z-index: 1; }
.hero-eyebrow {
  font-size: 11.5px; color: var(--teal-xl); font-weight: 700;
  letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 8px;
}
.hero-title {
  font-size: 30px; font-weight: 800; color: white;
  line-height: 1.15; margin-bottom: 10px; letter-spacing: -0.01em;
}
.hero-title em { color: var(--teal-xl); font-style: normal; }
.hero-sub { font-size: 13.5px; color: rgba(255,255,255,.62); line-height: 1.65; max-width: 520px; }

.hero-actions { display: flex; gap: 10px; margin-top: 20px; }

.hero-stat {
  background: rgba(255,255,255,.07);
  backdrop-filter: blur(20px) saturate(160%);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: var(--r12);
  padding: 14px 18px; min-width: 130px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.16), 0 6px 20px rgba(0,0,0,0.2);
  transition: var(--transition);
}
.hero-stat:hover { background: rgba(255,255,255,.1); }
.hero-stat-val { font-size: 26px; font-weight: 800; color: white; letter-spacing: -0.02em; margin-bottom: 4px; }
.hero-stat-lbl { font-size: 11px; color: rgba(255,255,255,.5); font-weight: 600; letter-spacing: 0.04em; }

/* ── PAGE HEADERS ────────────────────────────────────────────────────────── */
.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 20px;
  animation: fadeUp 0.3s ease both;
}
.page-title { font-size: 24px; color: var(--ink); font-weight: 800; letter-spacing: -0.01em; line-height: 1.1; }
.page-sub { font-size: 13px; color: var(--ink-soft); margin-top: 3px; }

/* ── TABS ────────────────────────────────────────────────────────────────── */
.tab-bar {
  display: flex; gap: 2px; padding: 4px;
  background: var(--surface-alt);
  border: 1px solid var(--border);
  border-radius: var(--r12); margin-bottom: 18px;
  width: fit-content;
}
.tab {
  padding: 7px 16px; border-radius: var(--r8);
  font-size: 13px; font-weight: 600; color: var(--ink-soft);
  cursor: pointer; transition: var(--transition);
}
.tab.active {
  background: var(--surface); color: var(--ink);
  box-shadow: var(--shadow-xs);
  border: 1px solid var(--border);
}
.tab:not(.active):hover { color: var(--ink); background: rgba(0,0,0,.03); }

/* ── TABLE ───────────────────────────────────────────────────────────────── */
.tbl-wrap { overflow: hidden; border-radius: var(--r16); }
.tbl-head {
  display: grid; align-items: center;
  padding: 10px 20px;
  background: var(--surface-alt);
  border-bottom: 1px solid var(--border);
}
.tbl-head span {
  font-size: 10.5px; color: var(--ink-faint);
  letter-spacing: 0.07em; text-transform: uppercase; font-weight: 700;
}
.tbl-row {
  display: grid; align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-s);
  cursor: pointer;
  transition: var(--transition);
}
.tbl-row:hover { background: var(--teal-glow-s); }
.tbl-row:last-child { border-bottom: none; }
.tbl-row.highlighted { background: rgba(13,148,136,.04); }

/* ── PROGRESS ────────────────────────────────────────────────────────────── */
.prog-bar {
  height: 4px; background: var(--border);
  border-radius: 2px; overflow: hidden;
}
.prog-fill {
  height: 100%; border-radius: 2px;
  animation: progressIn 1s cubic-bezier(0.4,0,0.2,1) both;
  transition: width var(--transition-slow);
}

.prog-row { display: flex; align-items: center; gap: 10px; }
.prog-label { font-size: 12px; color: var(--ink-soft); min-width: 120px; font-weight: 500; }
.prog-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px; font-weight: 700; min-width: 34px; text-align: right;
}

/* ── SIGNAL ITEMS ─────────────────────────────────────────────────────────── */
.signal-item {
  padding: 13px 20px;
  border-bottom: 1px solid var(--border-s);
  cursor: pointer;
  transition: var(--transition);
  display: flex; align-items: flex-start; gap: 10px;
}
.signal-item:hover { background: var(--teal-glow-s); }
.signal-item:last-child { border-bottom: none; }
.signal-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.signal-type {
  font-size: 10px; font-weight: 800;
  letter-spacing: 0.08em; text-transform: uppercase;
  margin-bottom: 3px;
}
.signal-text { font-size: 12.5px; color: var(--ink-mid); line-height: 1.55; }
.signal-meta { font-size: 10.5px; color: var(--ink-faint); margin-top: 4px; display: flex; gap: 10px; }

/* ── EXECUTION WINDOWS ────────────────────────────────────────────────────── */
.window-card {
  padding: 14px 18px; border-radius: var(--r12); margin-bottom: 10px;
  border: 1px solid var(--border); transition: var(--transition);
}
.window-card:hover { transform: translateY(-1px); box-shadow: var(--shadow-s); }
.window-open { background: rgba(16,185,129,.04); border-color: rgba(16,185,129,.22); }
.window-closed { background: rgba(239,68,68,.03); border-color: rgba(239,68,68,.14); }

/* ══════════════════════════════════════════════════════════════════════════════
   PRICEOS MODULE STYLES — pink accent ONLY for pricing money-making actions
   ══════════════════════════════════════════════════════════════════════════════ */
.btn-pink {
  background: linear-gradient(135deg, var(--pink) 0%, var(--pink-l) 100%);
  color: #fff; border: none;
  box-shadow: 0 2px 12px rgba(255,45,120,.32);
}
.btn-pink:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255,45,120,.40); }
.dm-serif { font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; letter-spacing: -0.03em; }

/* EU AI Act topbar badge */
.eu-ai-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 11px;
  background: rgba(59,130,246,.07); border: 1px solid rgba(59,130,246,.22);
  border-radius: var(--r8); font-size: 11px; font-weight: 700;
  color: var(--blue); white-space: nowrap;
}
#eu-ai-badge-wrap { display: none; }
#eu-ai-badge-wrap.visible { display: flex; }

/* Sidebar sub-item */
.nav-sub-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0; margin: 1px 8px;
  border-radius: var(--r10); cursor: pointer;
  transition: background var(--transition), color var(--transition), padding var(--transition-slow), border-color var(--transition);
  color: rgba(255,255,255,.3);
  font-size: 12.5px; font-weight: 500;
  position: relative; border: 1px solid transparent;
  justify-content: center;
  overflow: hidden;
}
#sidebar.sb-expanded .nav-sub-item {
  padding: 7px 12px 7px 36px;
  justify-content: flex-start;
  margin: 1px 10px;
}
.nav-sub-item:hover { background: rgba(255,255,255,.04); color: rgba(255,255,255,.55); }
#sidebar:not(.sb-expanded) .nav-sub-item:hover {
  background: rgba(255,45,120,.08);
  border-color: rgba(255,45,120,.12);
  color: var(--pink-l);
}
.nav-sub-item.active { background: rgba(255,45,120,.12); color: #ff6b9d; border-color: rgba(255,45,120,.22); }
.nav-sub-item.active::before {
  content: ''; position: absolute; left: -8px; top: 50%;
  transform: translateY(-50%); width: 3px; height: 14px;
  background: var(--pink); border-radius: 0 2px 2px 0;
}
#sidebar.sb-expanded .nav-sub-item.active::before { left: -10px; }
.pricing-os-badge {
  font-size: 8px; font-weight: 800; padding: 1px 5px;
  border-radius: 4px; background: var(--pink); color: white;
  letter-spacing: .06em; margin-left: auto; flex-shrink: 0;
}

/* Count-up animation */
@keyframes countUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
.count-up { animation: countUp 0.55s cubic-bezier(0.22,1,0.36,1) both; }

/* Live pulsing number */
@keyframes liveNumPulse { 0%,100%{opacity:1} 50%{opacity:.65} }
.live-num { animation: liveNumPulse 3.5s ease-in-out infinite; color: var(--green) !important; }

/* PriceOS dashboard widget */
.priceos-widget {
  background: linear-gradient(135deg, #0c0c0c 0%, #1a0d14 60%, #0d0a14 100%);
  backdrop-filter: blur(32px) saturate(180%);
  -webkit-backdrop-filter: blur(32px) saturate(180%);
  border: 1px solid rgba(255,45,120,0.25);
  border-radius: var(--r16);
  padding: 22px 26px; position: relative; overflow: hidden;
  cursor: pointer;
  box-shadow:
    0 8px 32px rgba(0,0,0,0.4),
    inset 0 1px 0 rgba(255,255,255,0.12),
    inset 0 -1px 0 rgba(0,0,0,0.2);
  transition: transform 0.4s cubic-bezier(0.23,1,0.32,1), box-shadow 0.4s cubic-bezier(0.23,1,0.32,1), border-color 0.3s;
}
.priceos-widget::before {
  content: ''; position: absolute; top:-50px; right:-50px;
  width:200px; height:200px;
  background: radial-gradient(circle, rgba(255,45,120,.14) 0%, transparent 70%);
  pointer-events: none;
}
.priceos-widget:hover {
  border-color: var(--pink);
  transform: translateZ(10px) scale(1.01);
  box-shadow:
    0 20px 60px rgba(255,45,120,0.25),
    inset 0 2px 0 rgba(255,255,255,0.2),
    inset 0 -1px 0 rgba(0,0,0,0.15);
}
.priceos-widget-tag {
  font-size: 9.5px; font-weight: 700; color: #ff6b9d;
  letter-spacing: .12em; text-transform: uppercase; margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.priceos-widget-val {
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
  font-size: 38px; color: white; line-height: 1; letter-spacing: -0.02em;
  margin-bottom: 6px;
}
.priceos-widget-val em { color: var(--pink-l); font-style: normal; }
.priceos-widget-sub { font-size: 12.5px; color: rgba(255,255,255,.42); line-height: 1.55; }
.priceos-widget-btn {
  display: inline-flex; align-items: center; gap: 6px; margin-top: 16px;
  padding: 9px 18px; background: var(--pink); color: white;
  border-radius: var(--r10); font-size: 12.5px; font-weight: 700;
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; border: none; cursor: pointer; transition: var(--transition);
}
.priceos-widget-btn:hover { opacity: .88; transform: scale(.98); }

/* PriceOS tab bar */
.pos-tab-bar {
  display: flex; gap: 2px; padding: 4px;
  background: var(--surface-alt); border: 1px solid var(--border);
  border-radius: var(--r12); margin-bottom: 20px; width: fit-content;
}
.pos-tab {
  padding: 8px 18px; border-radius: var(--r8);
  font-size: 13px; font-weight: 600; color: var(--ink-soft);
  cursor: pointer; transition: var(--transition);
}
.pos-tab.active { background: white; color: var(--ink); box-shadow: var(--shadow-xs); border: 1px solid var(--border); }
.pos-tab.active.pink-tab { color: var(--pink); border-color: var(--pink-border); }
.pos-tab:not(.active):hover { background: rgba(0,0,0,.03); color: var(--ink); }

/* Live 3-number strip */
.live-strip { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 20px; }
.live-card {
  background: white; border: 1px solid var(--border);
  border-radius: var(--r12); padding: 18px 20px;
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.08),
    0 4px 16px rgba(13,148,136,0.08),
    inset 0 1px 0 rgba(255,255,255,0.95);
  position: relative; overflow: hidden;
  transition: transform 0.3s cubic-bezier(0.23,1,0.32,1), box-shadow 0.3s cubic-bezier(0.23,1,0.32,1);
}
.live-card:hover {
  transform: translateY(-2px);
  box-shadow:
    0 0 0 1px rgba(13,148,136,0.14),
    0 8px 28px rgba(13,148,136,0.13),
    inset 0 1px 0 rgba(255,255,255,1);
}
.live-card.profit-state {
  box-shadow:
    0 0 0 1px rgba(16,185,129,0.22),
    0 6px 24px rgba(16,185,129,0.16),
    inset 0 1px 0 rgba(255,255,255,1);
}
.live-card::before {
  content: ''; position: absolute; top:0; left:0; right:0; height:2.5px;
  background: var(--lc-color, var(--teal)); border-radius: 2px 2px 0 0;
}
.live-card-label {
  font-size: 10px; font-weight: 700; color: var(--ink-faint);
  text-transform: uppercase; letter-spacing: .08em; margin-bottom: 8px;
  display: flex; align-items: center; gap: 5px;
}
.live-card-val {
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
  font-size: 30px; font-weight: 400; line-height: 1; letter-spacing: -0.02em;
}
.live-card-delta { font-size: 12px; font-weight: 700; margin-top: 6px; }

/* PriceOS copilot full-bleed */
.pos-copilot-panel {
  background: white; border: 1px solid var(--border);
  border-radius: var(--r16); box-shadow: var(--shadow-m);
  display: flex; flex-direction: column; height: 540px; overflow: hidden;
}
.pos-copilot-header {
  padding: 16px 22px; border-bottom: 1px solid rgba(255,255,255,.06);
  background: linear-gradient(90deg, #0d0d0d 0%, #1a0d14 100%);
  display: flex; align-items: center; gap: 10px;
}
.pos-copilot-title { font-size: 14px; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px; }
.pos-chat-msgs {
  flex: 1; overflow-y: auto; padding: 20px 22px;
  display: flex; flex-direction: column; gap: 14px;
}
.pos-msg { display: flex; gap: 10px; align-items: flex-start; }
.pos-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800; flex-shrink: 0;
}
.pos-avatar-ai { background: var(--pink); color: white; }
.pos-avatar-user { background: var(--surface-alt); border: 1px solid var(--border); color: var(--ink-soft); }
.pos-bubble {
  background: var(--surface-alt); border: 1px solid var(--border);
  border-radius: 12px; border-top-left-radius: 4px;
  padding: 10px 14px; font-size: 13px; color: var(--ink-soft);
  line-height: 1.6; max-width: 86%;
}
.pos-bubble.user {
  background: rgba(255,45,120,.05); border-color: var(--pink-border);
  border-top-left-radius: 12px; border-top-right-radius: 4px;
  color: var(--ink); margin-left: auto;
}
.pos-bubble strong { color: var(--ink); }
.pos-bubble .p-green { color: var(--green); font-weight: 700; }
.pos-bubble .p-pink { color: var(--pink); font-weight: 700; }
.pos-input-row {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; background: white;
}
.pos-input {
  flex: 1; background: var(--surface-alt); border: 1px solid var(--border);
  border-radius: var(--r10); padding: 10px 14px; font-size: 13px;
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; color: var(--ink); outline: none; transition: var(--transition);
}
.pos-input:focus { border-color: var(--pink); box-shadow: 0 0 0 3px rgba(255,45,120,.10); }
.pos-send-btn {
  background: var(--pink); color: white; border: none; border-radius: var(--r10);
  padding: 10px 18px; font-size: 13px; font-weight: 700;
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; cursor: pointer; transition: var(--transition); flex-shrink: 0;
}
.pos-send-btn:hover { opacity:.88; }
.pos-send-btn:disabled { opacity:.4; cursor:not-allowed; }
.pos-typing { display:flex; gap:4px; align-items:center; padding:3px 0; }
.pos-typing-dot {
  width:6px; height:6px; border-radius:50%; background:var(--ink-ghost);
  animation: posTyping 1.2s ease-in-out infinite;
}
.pos-typing-dot:nth-child(2){animation-delay:.2s}
.pos-typing-dot:nth-child(3){animation-delay:.4s}
@keyframes posTyping{0%,100%{opacity:.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-3px)}}

/* Autopilot toggle */
.pos-toggle {
  width: 42px; height: 24px; border-radius: 12px;
  position: relative; cursor: pointer; transition: background .2s; background: #e0e0e0;
}
.pos-toggle.on { background: var(--pink); }
.pos-toggle::after {
  content:''; position:absolute; width:20px; height:20px; border-radius:50%;
  background:white; top:2px; left:2px; transition:transform .2s; box-shadow:0 1px 4px rgba(0,0,0,.2);
}
.pos-toggle.on::after { transform:translateX(18px); }

/* Scenario rows */
.pos-sc-row {
  display: grid;
  grid-template-columns: 32px 1fr 72px 100px 80px 80px 110px;
  align-items: center; padding: 13px 20px;
  border-bottom: 1px solid var(--border-s);
  cursor: pointer; transition: var(--transition); font-size: 13px;
}
.pos-sc-row:hover { background: var(--teal-glow-s); }
.pos-sc-row:last-child { border-bottom: none; }
.pos-rank { width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800; }
.pos-rank-1 { background:var(--pink);color:white; }
.pos-rank-n { background:var(--surface-alt);color:var(--ink-soft);border:1px solid var(--border); }

/* ── DIFF BANNERS ─────────────────────────────────────────────────────────── */
.diff-banner {
  background: linear-gradient(90deg, var(--teal-glow), var(--teal-glow-s));
  border: 1px solid var(--border-m);
  border-radius: var(--r10); padding: 12px 16px;
  display: flex; align-items: flex-start; gap: 10px; margin-top: 14px;
}
.diff-icon { font-size: 16px; flex-shrink: 0; }
.diff-title { font-size: 12.5px; font-weight: 700; color: var(--teal); margin-bottom: 3px; }
.diff-text { font-size: 11.5px; color: var(--ink-soft); line-height: 1.55; }

/* ── SPARKLINES ──────────────────────────────────────────────────────────── */
.sparkline-canvas { display: block; }

/* ── SCORE CARDS ─────────────────────────────────────────────────────────── */
.score-grade {
  display: inline-block; padding: 3px 8px; border-radius: 5px;
  font-size: 11px; font-weight: 800; letter-spacing: 0.04em;
}
.grade-a { background: var(--green-bg); color: var(--green); }
.grade-b { background: var(--blue-bg); color: var(--blue); }
.grade-c { background: var(--amber-bg); color: var(--amber); }

/* ── ORACLE STYLES ────────────────────────────────────────────────────────── */
.oracle-loading { text-align: center; padding: 48px 24px; }
.oracle-step {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 0; font-size: 12.5px; opacity: 0.25;
  transition: opacity 0.3s ease;
}
.oracle-step.active { opacity: 1; }
.oracle-step.done { opacity: 0.7; }
.step-icon { width: 20px; text-align: center; font-size: 14px; font-weight: 700; }
.step-bar { flex: 1; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
.step-fill { height: 100%; background: var(--teal); width: 0; transition: width 0.7s ease; }

/* ── GENOME STYLES ────────────────────────────────────────────────────────── */
.gene-product {
  padding: 14px 16px; border: 1px solid var(--border);
  border-radius: var(--r12); margin-bottom: 10px;
  cursor: pointer; transition: var(--transition);
}
.gene-product:hover { background: var(--teal-glow-s); border-color: var(--border-m); }
.gene-product.open { background: var(--surface-alt); }
.gene-ingredients { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1); }
.gene-ingredients.open { max-height: 600px; margin-top: 12px; }
.gene-ing {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: var(--r10);
  background: var(--surface); border: 1px solid var(--border-s);
  margin-bottom: 6px;
}

/* ── BENCHMARK ROWS ───────────────────────────────────────────────────────── */
.bench-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.bench-label { font-size: 12px; color: var(--ink-soft); font-weight: 600; min-width: 130px; }
.bench-bar-wrap { position: relative; height: 24px; background: var(--surface-alt); border-radius: 5px; overflow: hidden; }
.bench-bar-peer { position: absolute; top: 0; left: 0; height: 100%; background: var(--ink-ghost); border-radius: 5px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }
.bench-bar-you { position: absolute; top: 0; left: 0; height: 100%; background: var(--teal); border-radius: 5px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }
.bench-marker { position: absolute; top: 0; height: 100%; width: 2px; background: var(--ink); opacity: 0.4; transform: translateX(-1px); }
.bench-you-val { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; color: var(--teal); min-width: 44px; text-align: right; }
.bench-peer-val { font-size: 10.5px; color: var(--ink-faint); min-width: 70px; text-align: right; }

/* ── DECISION ROWS ────────────────────────────────────────────────────────── */
.decision-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 14px; border: 1px solid var(--border);
  border-radius: var(--r12); margin-bottom: 10px;
  transition: var(--transition);
}
.decision-row:hover { border-color: var(--border-m); }
.decision-icon {
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; flex-shrink: 0;
}
.decision-win { background: var(--green-bg); color: var(--green); }
.decision-loss { background: var(--red-bg); color: var(--red); }
.regret-amount { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 700; }

/* ── CARBON CHIPS ─────────────────────────────────────────────────────────── */
.carbon-chip {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px; border: 1px solid var(--border);
  border-radius: var(--r10); margin-bottom: 8px;
  transition: var(--transition);
}
.carbon-chip:hover { border-color: var(--border-m); }
.carbon-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 700; }
.carbon-impact { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 3px; }

/* ── SCENARIO OPTION ────────────────────────────────────────────────────── */
.scenario-opt {
  padding: 12px 14px; border: 1px solid var(--border);
  border-radius: var(--r10); margin-bottom: 8px;
  cursor: pointer; transition: var(--transition);
}
.scenario-opt:hover { border-color: var(--border-m); background: var(--teal-glow-s); }
.scenario-opt.selected { background: var(--teal-glow); border-color: var(--teal); }

/* ── NOTIFICATION PANEL ───────────────────────────────────────────────────── */
#notif-panel {
  position: fixed; top: 68px; right: 20px;
  width: 360px; max-height: 480px;
  background: var(--surface);
  border: 1px solid var(--border-m);
  border-radius: var(--r16);
  box-shadow: var(--shadow-l);
  z-index: 100;
  display: none;
  overflow: hidden;
  animation: slideInRight 0.2s ease both;
}
#notif-panel.open { display: flex; flex-direction: column; }

/* ── COMMAND PALETTE ──────────────────────────────────────────────────────── */
#cmd-overlay {
  position: fixed; inset: 0;
  background: rgba(10,26,24,.5);
  backdrop-filter: blur(4px);
  z-index: 200; display: none;
  align-items: flex-start; justify-content: center;
  padding-top: 120px;
}
#cmd-overlay.open { display: flex; animation: fadeIn 0.15s ease both; }

#cmd-palette {
  width: 580px; background: var(--surface);
  border: 1px solid var(--border-m);
  border-radius: var(--r20);
  box-shadow: var(--shadow-l);
  overflow: hidden;
  animation: scaleIn 0.18s cubic-bezier(0.4,0,0.2,1) both;
}

#cmd-input {
  width: 100%; padding: 18px 20px;
  font-size: 16px; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-weight: 500;
  border: none; outline: none; color: var(--ink);
  border-bottom: 1px solid var(--border);
  background: transparent;
}

.cmd-result {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 20px; cursor: pointer;
  transition: var(--transition);
}
.cmd-result:hover, .cmd-result.selected { background: var(--teal-glow); }
.cmd-result-icon { font-size: 18px; width: 28px; text-align: center; }
.cmd-result-label { font-size: 14px; font-weight: 600; color: var(--ink); }
.cmd-result-desc { font-size: 12px; color: var(--ink-soft); margin-top: 1px; }
.cmd-result-kbd { margin-left: auto; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--ink-ghost); }

/* ── TRIGGER OPEN / CLOSED ────────────────────────────────────────────────── */
.trigger-open, .trigger-closed { /* replaced by window-card classes */ }

/* ── METRIC SPARKLINE ROWS ───────────────────────────────────────────────── */
.metric-row {
  display: flex; align-items: center; gap: 14px;
  padding: 12px 0; border-bottom: 1px solid var(--border-s);
}
.metric-row:last-child { border-bottom: none; }
.metric-name { flex: 1; font-size: 13px; color: var(--ink); font-weight: 600; }
.metric-sub { font-size: 11px; color: var(--ink-faint); font-weight: 400; margin-top: 1px; }
.metric-val { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 700; }
.metric-delta { font-size: 11px; font-weight: 700; }
.up-text { color: var(--green); }
.down-text { color: var(--red); }
.neutral-text { color: var(--teal); }

/* ── FORMS ───────────────────────────────────────────────────────────────── */
input[type="text"], input[type="email"], textarea, select {
  font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
  font-size: 13.5px; color: var(--ink);
  background: var(--surface-alt);
  border: 1px solid var(--border-m);
  border-radius: var(--r10); padding: 10px 14px;
  outline: none; transition: var(--transition);
  width: 100%;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 3px rgba(13,148,136,.12);
}

input[type="range"] {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 4px;
  background: var(--teal-dim); border-radius: 2px;
  outline: none; cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--teal); cursor: pointer;
  box-shadow: 0 2px 8px rgba(13,148,136,.4);
  border: 2px solid white;
  transition: var(--transition);
}
input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }

/* ── TOGGLE ──────────────────────────────────────────────────────────────── */
.toggle-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.toggle {
  width: 38px; height: 22px; border-radius: 11px;
  background: var(--border-m); position: relative;
  transition: var(--transition); flex-shrink: 0;
}
.toggle.on { background: var(--teal); }
.toggle::after {
  content: ''; position: absolute; top: 3px; left: 3px;
  width: 16px; height: 16px; border-radius: 50%;
  background: white; transition: var(--transition);
  box-shadow: 0 1px 4px rgba(0,0,0,.15);
}
.toggle.on::after { transform: translateX(16px); }

/* ── LOADING SKELETON ─────────────────────────────────────────────────────── */
.skeleton {
  background: linear-gradient(90deg, var(--surface-alt) 25%, var(--border-s) 50%, var(--surface-alt) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.8s ease-in-out infinite;
  border-radius: 4px;
}

/* ── SUPPLY CHAIN NODES ───────────────────────────────────────────────────── */
.supply-node {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r12); padding: 12px 16px;
  transition: var(--transition);
}
.supply-node:hover { border-color: var(--teal); box-shadow: var(--shadow-s); }

/* ── REPORT CARDS ─────────────────────────────────────────────────────────── */
.report-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r14); padding: 18px 20px;
  transition: var(--transition); cursor: pointer;
}
.report-card:hover { border-color: var(--border-m); box-shadow: var(--shadow-m); transform: translateY(-2px); }
.report-icon { font-size: 28px; margin-bottom: 10px; }

/* ── INTEGRATION ITEM ─────────────────────────────────────────────────────── */
.integration-item {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 18px; border: 1px solid var(--border);
  border-radius: var(--r12); transition: var(--transition);
}
.integration-item:hover { border-color: var(--border-m); background: var(--teal-glow-s); }
.integration-icon {
  width: 42px; height: 42px; border-radius: var(--r10);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}

/* ── RESPONSIVE TWEAKS ────────────────────────────────────────────────────── */
@media (max-width: 1280px) {
  .g4 { grid-template-columns: repeat(2, 1fr); }
  .g-main { grid-template-columns: 1fr 290px; }
}
/* ══════════════════════════════════════════════════════════════════
   NERVURE v5 — NEW MODULE STYLES
   Agentic loops · Hedging Engine · Elasticity Backbone · Promo Uplift
   ════════════════════════════════════════════════════════════════ */

/* ── AGENTIC TRACE ─────────────────────────────────────────────── */
.agent-trace {
  background: var(--ink);
  border: 1px solid rgba(13,148,136,.2);
  border-radius: var(--r12);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11.5px;
  overflow: hidden;
}
.agent-trace-header {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 16px;
  background: rgba(13,148,136,.08);
  border-bottom: 1px solid rgba(13,148,136,.15);
}
.agent-trace-title { color: var(--teal-xl); font-weight: 700; font-size: 11px; letter-spacing: .08em; }
.agent-pulse { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse-dot 1.8s ease-in-out infinite; flex-shrink: 0; }
.agent-step {
  display: flex; gap: 10px; align-items: flex-start;
  padding: 7px 16px;
  border-bottom: 1px solid rgba(255,255,255,.03);
  color: rgba(255,255,255,.45);
  transition: background .15s;
}
.agent-step.active { color: var(--teal-xl); background: rgba(13,148,136,.06); }
.agent-step.done { color: rgba(255,255,255,.3); }
.agent-step.done .ast-icon { color: var(--green); }
.agent-step.error { color: var(--red); }
.ast-icon { width: 14px; flex-shrink: 0; text-align: center; margin-top: 1px; }
.ast-text { flex: 1; line-height: 1.5; }
.ast-conf {
  font-size: 10px; padding: 2px 6px; border-radius: 3px;
  background: rgba(13,148,136,.15); color: var(--teal-xl);
  align-self: center; flex-shrink: 0;
}

/* ── APPROVAL GATE ─────────────────────────────────────────────── */
.approval-gate {
  border: 2px solid var(--amber);
  border-radius: var(--r14);
  background: rgba(245,158,11,.04);
  padding: 16px 20px;
  position: relative;
  overflow: hidden;
}
.approval-gate::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--amber), transparent);
}
.approval-gate-title {
  font-size: 13px; font-weight: 800; color: var(--amber);
  display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
}
.approval-gate-sub { font-size: 12px; color: var(--ink-soft); margin-bottom: 14px; }

.approval-gate.approved {
  border-color: var(--green);
  background: rgba(16,185,129,.04);
}
.approval-gate.approved::before { background: linear-gradient(90deg, var(--green), transparent); }
.approval-gate-title.approved { color: var(--green); }

.approval-gate.blocked {
  border-color: var(--red);
  background: rgba(239,68,68,.04);
}
.approval-gate.blocked::before { background: linear-gradient(90deg, var(--red), transparent); }

/* ── HEDGE DECISION CARD ───────────────────────────────────────── */
.hedge-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r14);
  padding: 18px 20px;
  transition: var(--transition);
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.hedge-card:hover { border-color: var(--teal); box-shadow: var(--shadow-m); }
.hedge-card.selected {
  border-color: var(--teal);
  background: var(--teal-glow-s);
  box-shadow: 0 0 0 3px rgba(13,148,136,.1);
}
.hedge-action {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 800; letter-spacing: .08em;
  padding: 4px 10px; border-radius: 6px;
  text-transform: uppercase;
}
.hedge-action.buy { background: rgba(16,185,129,.12); color: var(--green); border: 1px solid rgba(16,185,129,.25); }
.hedge-action.hold { background: rgba(245,158,11,.12); color: var(--amber); border: 1px solid rgba(245,158,11,.25); }
.hedge-action.reduce { background: rgba(239,68,68,.12); color: var(--red); border: 1px solid rgba(239,68,68,.25); }
.hedge-action.approved { background: rgba(16,185,129,.2); color: var(--green); border: 1px solid rgba(16,185,129,.4); }

.hedge-horizon {
  display: flex; gap: 4px; margin: 12px 0;
}
.horizon-month {
  flex: 1; height: 32px; border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 700;
  background: var(--surface-alt); border: 1px solid var(--border);
  color: var(--ink-faint);
  transition: var(--transition);
  cursor: pointer;
}
.horizon-month.active { background: var(--teal); color: #fff; border-color: var(--teal); }
.horizon-month:hover { border-color: var(--teal); color: var(--teal); }

/* ── ELASTICITY GRID ───────────────────────────────────────────── */
.elasticity-cell {
  padding: 10px 14px;
  border-radius: var(--r10);
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
}
.elasticity-cell:hover { transform: scale(1.04); box-shadow: var(--shadow-s); border-color: var(--border-m); }
.elasticity-cell.inelastic { background: rgba(16,185,129,.08); }
.elasticity-cell.moderate { background: rgba(245,158,11,.08); }
.elasticity-cell.elastic { background: rgba(239,68,68,.08); }
.e-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 800; }
.e-sku { font-size: 10.5px; color: var(--ink-soft); margin-top: 3px; line-height: 1.3; }
.e-method { font-size: 9px; color: var(--ink-faint); margin-top: 4px; letter-spacing: .06em; text-transform: uppercase; }

/* ── PROMO DECOMPOSITION ───────────────────────────────────────── */
.promo-bar-wrap {
  position: relative; height: 28px; border-radius: 6px; overflow: hidden;
  background: var(--border);
}
.promo-bar-base { position: absolute; left: 0; top: 0; height: 100%; background: var(--teal); border-radius: 6px 0 0 6px; transition: width .8s ease; }
.promo-bar-lift { position: absolute; top: 0; height: 100%; background: var(--pink); transition: left .8s ease, width .8s ease; border-radius: 0; }
.promo-bar-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,.5); }

/* ── AUDIT TRAIL ITEMS ─────────────────────────────────────────── */
.audit-item {
  display: flex; gap: 12px; padding: 11px 16px;
  border-bottom: 1px solid var(--border-s);
  align-items: flex-start;
  transition: background .15s;
}
.audit-item:hover { background: var(--teal-glow-s); }
.audit-dot {
  width: 8px; height: 8px; border-radius: 50%;
  flex-shrink: 0; margin-top: 4px;
}
.audit-time { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--ink-faint); flex-shrink: 0; min-width: 70px; }
.audit-action { font-size: 12.5px; font-weight: 600; color: var(--ink); }
.audit-detail { font-size: 11.5px; color: var(--ink-soft); margin-top: 2px; }

/* ── CONFIDENCE METER ──────────────────────────────────────────── */
.conf-ring-wrap {
  position: relative; display: inline-flex;
  align-items: center; justify-content: center;
}
.conf-ring-label {
  position: absolute; text-align: center; pointer-events: none;
}

/* ── AGENTIC STATUS BAR ────────────────────────────────────────── */
.agent-status-bar {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
  background: var(--ink);
  border: 1px solid rgba(13,148,136,.3);
  border-radius: 40px;
  padding: 10px 20px;
  display: flex; align-items: center; gap: 12px;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  color: rgba(255,255,255,.75);
  box-shadow: 0 8px 32px rgba(0,0,0,.3);
  z-index: 200;
  opacity: 0; transform: translateX(-50%) translateY(20px);
  transition: opacity .3s ease, transform .3s ease;
  white-space: nowrap;
  pointer-events: none;
}
.agent-status-bar.visible {
  opacity: 1; transform: translateX(-50%) translateY(0);
}
.agent-status-bar .asb-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--teal); animation: pulse-dot 1.5s ease-in-out infinite; }

/* ── DATA LINEAGE TOOLTIP ──────────────────────────────────────── */
.lineage-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 9.5px; font-weight: 700; letter-spacing: .06em;
  padding: 2px 7px; border-radius: 4px;
  background: rgba(13,148,136,.1); color: var(--teal);
  border: 1px solid rgba(13,148,136,.2);
  cursor: help;
  position: relative;
}
.lineage-badge:hover::after {
  content: attr(data-source);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%);
  background: var(--ink); color: rgba(255,255,255,.85);
  font-size: 11px; padding: 6px 10px; border-radius: 8px;
  white-space: nowrap; pointer-events: none;
  box-shadow: 0 4px 16px rgba(0,0,0,.3);
  z-index: 100;
}

/* ── WATERFALL CONNECTED ───────────────────────────────────────── */
.connected-flow {
  display: flex; align-items: stretch; gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r14);
  overflow: hidden;
  margin-bottom: 16px;
}
.flow-stage {
  flex: 1; padding: 16px 18px;
  border-right: 1px solid var(--border);
  position: relative;
  transition: background .2s;
}
.flow-stage:last-child { border-right: none; }
.flow-stage:hover { background: var(--teal-glow-s); }
.flow-stage.active { background: var(--teal-glow); }
.flow-arrow {
  position: absolute; right: -10px; top: 50%;
  transform: translateY(-50%);
  width: 20px; height: 20px;
  background: var(--teal); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 10px; font-weight: 800;
  z-index: 2; box-shadow: 0 2px 8px rgba(13,148,136,.4);
}
.flow-stage-label {
  font-size: 9.5px; font-weight: 800; letter-spacing: .1em;
  text-transform: uppercase; color: var(--ink-faint); margin-bottom: 6px;
}
.flow-stage-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px; font-weight: 800; color: var(--ink);
  margin-bottom: 3px;
}
.flow-stage-sub { font-size: 11px; color: var(--ink-soft); }

/* ── SCENARIO IMPACT COMPARISON ─────────────────────────────────── */
.scenario-comparison {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
}
.sc-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r12); padding: 14px 16px;
  cursor: pointer; transition: var(--transition);
}
.sc-card:hover { border-color: var(--teal); transform: translateY(-2px); box-shadow: var(--shadow-s); }
.sc-card.selected { border-color: var(--teal); background: var(--teal-glow-s); }

/* ── HUMAN APPROVAL MODAL ──────────────────────────────────────── */
.approval-modal-overlay {
  position: fixed; inset: 0; background: rgba(10,26,24,.7);
  backdrop-filter: blur(6px); z-index: 500;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.approval-modal-overlay.open { opacity: 1; pointer-events: auto; }
.approval-modal {
  background: var(--surface); border-radius: var(--r20);
  border: 1px solid var(--border-m);
  box-shadow: var(--shadow-l);
  max-width: 520px; width: 92%;
  transform: scale(.95); transition: transform .25s;
  overflow: hidden;
}
.approval-modal-overlay.open .approval-modal { transform: scale(1); }
.approval-modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, rgba(245,158,11,.06) 0%, transparent 60%);
}
.approval-modal-body { padding: 20px 24px; }
.approval-modal-footer {
  padding: 14px 24px; border-top: 1px solid var(--border);
  display: flex; gap: 10px; justify-content: flex-end;
  background: var(--surface-alt);
}
</style>
</head>
<body>
<div id="app">
  <!-- ═══════ SIDEBAR ═══════ -->
  <nav id="sidebar">
    <div class="sb-logo" onclick="showModule('dashboard')">
      <div class="sb-logo-mark" style="background:none;box-shadow:none;padding:0;overflow:visible">
        <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="nvGrad" x1="0" y1="0" x2="38" y2="38" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#0D9488"/>
              <stop offset="55%" stop-color="#14B8A6"/>
              <stop offset="100%" stop-color="#5EEAD4"/>
            </linearGradient>
            <linearGradient id="nvGold" x1="0" y1="0" x2="38" y2="38" gradientUnits="userSpaceOnUse">
              <stop offset="0%" stop-color="#D4AF37"/>
              <stop offset="100%" stop-color="#F4E5B0"/>
            </linearGradient>
            <filter id="nvGlow" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="2" result="blur"/>
              <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          <!-- Rounded square base -->
          <rect width="38" height="38" rx="10" fill="url(#nvGrad)" opacity="0.12"/>
          <rect x="1" y="1" width="36" height="36" rx="9" stroke="url(#nvGrad)" stroke-width="1" fill="none" opacity="0.4"/>
          <!-- Leaf/nerve vein network — like an organic circuit -->
          <!-- Central spine (main vein) -->
          <path d="M19 7 C19 7 19 18 19 31" stroke="url(#nvGold)" stroke-width="1.5" stroke-linecap="round" opacity="0.9"/>
          <!-- Primary veins radiating like a leaf -->
          <path d="M19 13 C15 13 10 11 8 8" stroke="url(#nvGrad)" stroke-width="1.4" stroke-linecap="round" filter="url(#nvGlow)"/>
          <path d="M19 13 C23 13 28 11 30 8" stroke="url(#nvGrad)" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M19 19 C15 19 9 18 7 16" stroke="url(#nvGrad)" stroke-width="1.2" stroke-linecap="round"/>
          <path d="M19 19 C23 19 29 18 31 16" stroke="url(#nvGrad)" stroke-width="1.2" stroke-linecap="round"/>
          <path d="M19 25 C16 25 11 25 9 23" stroke="#5EEAD4" stroke-width="1" stroke-linecap="round" opacity="0.7"/>
          <path d="M19 25 C22 25 27 25 29 23" stroke="#5EEAD4" stroke-width="1" stroke-linecap="round" opacity="0.7"/>
          <!-- Central node -->
          <circle cx="19" cy="19" r="3" fill="url(#nvGold)" filter="url(#nvGlow)"/>
          <circle cx="19" cy="19" r="1.5" fill="#FFFFFF" opacity="0.9"/>
          <!-- Accent nodes on veins -->
          <circle cx="13.5" cy="11" r="1.2" fill="#14B8A6" opacity="0.8"/>
          <circle cx="24.5" cy="11" r="1.2" fill="#14B8A6" opacity="0.8"/>
          <circle cx="19" cy="7" r="1.5" fill="url(#nvGold)" opacity="0.9"/>
          <circle cx="19" cy="31" r="1.2" fill="#5EEAD4" opacity="0.6"/>
        </svg>
      </div>
      <div class="sb-brand-text">
        <div class="sb-brand-name">NERVURE</div>
        <div class="sb-brand-tagline">CPG Financial OS</div>
      </div>
    </div>

    <div class="sb-nav">
      <!-- CORE MODULES -->
      <div class="sb-section-label">Command</div>

      <div class="nav-item active" id="nav-dashboard" onclick="showModule('dashboard',this)">
        <span class="nav-icon">◎</span>
        <span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" id="nav-oracle" onclick="showModule('oracle',this)">
        <span class="nav-icon">⚡</span>
        <span class="nav-label">AI Oracle</span>
        <span class="nav-badge">3</span>
      </div>

      <div class="sb-section-label">Commodity Intelligence</div>

      <div class="nav-item" id="nav-commodity" onclick="showModule('commodity',this)">
        <span class="nav-icon">📈</span>
        <span class="nav-label">Commodity Desk</span>
        <span class="nav-badge amber">!</span>
      </div>
      <div class="nav-item" id="nav-profiles" onclick="showModule('profiles',this)">
        <span class="nav-icon">◎</span>
        <span class="nav-label">Scoring Profiles</span>
      </div>
      <div class="nav-item" id="nav-genome" onclick="showModule('genome',this)">
        <span class="nav-icon">🧬</span>
        <span class="nav-label">Product Genome</span>
      </div>
      <div class="nav-item" id="nav-scenarios" onclick="showModule('scenarios',this)">
        <span class="nav-icon">◈</span>
        <span class="nav-label">Scenario Engine</span>
      </div>
      <div class="nav-item" id="nav-signals" onclick="showModule('signals',this)">
        <span class="nav-icon">🛰</span>
        <span class="nav-label">Signal Lab</span>
        <span class="nav-badge green">50</span>
      </div>

      <div class="sb-section-label">Financial Planning</div>

      <div class="nav-item" id="nav-revenue" onclick="showModule('revenue',this)">
        <span class="nav-icon">💰</span>
        <span class="nav-label">Revenue Engine</span>
      </div>
      <!-- Pricing OS: PriceOS sub-module under Revenue Engine -->
      <div class="nav-sub-item" id="nav-pricing-os" onclick="showModule('pricing-os',this)">
        <span class="nav-icon" style="font-size:13px">🎯</span>
        <span class="nav-label">Pricing OS</span>
        <span class="pricing-os-badge">LIVE</span>
      </div>
      <div class="nav-item" id="nav-demand" onclick="showModule('demand',this)">
        <span class="nav-icon">📊</span>
        <span class="nav-label">Demand Forecast</span>
      </div>
      <div class="nav-item" id="nav-profitability" onclick="showModule('profitability',this)">
        <span class="nav-icon">💡</span>
        <span class="nav-label">Profitability</span>
      </div>

      <div class="sb-section-label" style="display:flex;align-items:center;gap:6px">
        <span class="sb-section-inner">Integration</span>
        <span class="sb-new-badge" style="background:var(--teal);color:white;font-size:8px;padding:1px 6px;border-radius:3px;letter-spacing:.04em;font-weight:800">NEW</span>
      </div>
      <div class="nav-item" id="nav-marginbridge" onclick="showModule('marginbridge',this)">
        <span class="nav-icon">🔗</span>
        <span class="nav-label">Margin Bridge</span>
        <span class="nav-badge amber">!</span>
      </div>

      <div class="sb-section-label">Operations</div>

      <div class="nav-item" id="nav-supply" onclick="showModule('supply',this)">
        <span class="nav-icon">🚛</span>
        <span class="nav-label">Supply Chain</span>
      </div>
      <div class="nav-item" id="nav-reports" onclick="showModule('reports',this)">
        <span class="nav-icon">📑</span>
        <span class="nav-label">Reports</span>
      </div>
      <div class="nav-item" id="nav-gst" onclick="showModule('gst',this)">
        <span class="nav-icon">🇮🇳</span>
        <span class="nav-label">GST Engine</span>
        <span class="nav-badge amber" style="animation:none">₹</span>
      </div>
      <div class="nav-item" id="nav-settings" onclick="showModule('settings',this)">
        <span class="nav-icon">⚙</span>
        <span class="nav-label">Settings</span>
      </div>

      <!-- Commodity Watchlist -->
      <div class="sb-section-label" style="margin-top:6px">Watchlist</div>
      <div class="sb-comm-section" id="sb-comm-list"></div>
    </div>

    <div class="sb-bottom" onclick="showModule('settings',document.getElementById('nav-settings'))">
      <div class="avatar">S</div>
      <div class="sb-user-info">
        <div class="sb-user-name">Sandip Gupta</div>
        <div class="sb-user-role">Head of Commodity Risk · RB Group</div>
      </div>
      <div class="sb-settings-btn">⚙</div>
    </div>

    <!-- Copyright — always visible, centered -->
    <div class="sb-copyright">
      <div class="sb-copy-fixed">© Sandip Dixit</div>
      <div class="sb-copy-text">Designed &amp; Made by Ayesha</div>
    </div>
  </nav>

  <!-- ═══════ MAIN ═══════ -->
  <div id="main">
    <!-- TOPBAR -->
    <div id="topbar">
      <div class="topbar-breadcrumb" id="topbar-breadcrumb">
        <span>Dashboard</span>
      </div>

      <div class="search-trigger" onclick="openCmd()">
        <span class="search-icon">⌕</span>
        <span class="search-placeholder">Search, ask AI, or navigate…</span>
        <span class="search-kbd">⌘K</span>
      </div>

      <div class="tb-right">
      <!-- EU AI Act badge: only visible on Pricing OS module -->
      <div id="eu-ai-badge-wrap">
        <div class="eu-ai-badge">
          <span class="shield">⚖️</span> EU AI Act ✓ Guardrails Active
        </div>
      </div>
        <div class="live-pill">
          <div class="live-dot"></div>
          <span class="live-txt">50 Signals</span>
        </div>
        <div class="topbar-chip">🕐 23 Feb 2026</div>
        <div class="topbar-chip teal">IFRS 9 ✓</div>
        <div class="topbar-icon-btn" onclick="toggleNotif()" title="Notifications">
          🔔
          <div class="notif-badge"></div>
        </div>
        <div class="topbar-icon-btn" title="Help">?</div>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="content"></div>

    <!-- FOOTER -->
    <div id="footer" style="
      height:32px; flex-shrink:0;
      display:flex; align-items:center; justify-content:center;
      border-top:1px solid var(--border-s);
      background:rgba(255,255,255,.6);
      backdrop-filter:blur(8px);
    ">
      <span style="font-size:11px; color:var(--ink-ghost); letter-spacing:0.06em; font-weight:500; user-select:none;">
        © 2026 Sandip Dixit · NERVURE CPG Financial OS · Veridian Hedging Intelligence · All Rights Reserved · Patent Pending
      </span>
    </div>
  </div>
</div>

<!-- ═══════ NOTIFICATION PANEL ═══════ -->
<div id="notif-panel">
  <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
    <div style="font-size:14px;font-weight:700">Notifications</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-ghost btn-xs" onclick="markAllRead()">Mark all read</button>
      <span onclick="closeNotif()" style="cursor:pointer;color:var(--ink-faint);font-size:18px;padding:2px 4px">×</span>
    </div>
  </div>
  <div style="overflow-y:auto;flex:1">
    <div id="notif-list"></div>
  </div>
</div>

<!-- ═══════ COMMAND PALETTE ═══════ -->
<div id="cmd-overlay" onclick="closeCmd(event)">
  <div id="cmd-palette" onclick="event.stopPropagation()">
    <input id="cmd-input" placeholder="Search pages, commodities, or ask AI…" oninput="cmdFilter(this.value)" onkeydown="cmdKeydown(event)" autofocus />
    <div id="cmd-results" style="max-height:320px;overflow-y:auto"></div>
    <div style="padding:10px 20px;border-top:1px solid var(--border);display:flex;gap:14px">
      <span style="font-size:11px;color:var(--ink-faint)">↑↓ Navigate</span>
      <span style="font-size:11px;color:var(--ink-faint)">↩ Select</span>
      <span style="font-size:11px;color:var(--ink-faint)">ESC Close</span>
    </div>
  </div>
</div>

<!-- ═══════ AGENT STATUS BAR ═══════ -->
<div class="agent-status-bar" id="agent-status-bar">
  <div class="asb-dot"></div>
  <span id="agent-status-text">Nervure Agent thinking…</span>
</div>

<!-- ═══════ APPROVAL MODAL ═══════ -->
<div class="approval-modal-overlay" id="approval-modal-overlay" onclick="closeApprovalModal(event)">
  <div class="approval-modal" onclick="event.stopPropagation()">
    <div class="approval-modal-header">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <span style="font-size:22px">⚠️</span>
        <div>
          <div style="font-size:16px;font-weight:800;color:var(--amber)">Human Approval Required</div>
          <div style="font-size:11.5px;color:var(--ink-soft)">Impact exceeds £750K threshold · Guardrail activated</div>
        </div>
      </div>
      <div id="approval-modal-content"></div>
    </div>
    <div class="approval-modal-body" id="approval-modal-body"></div>
    <div class="approval-modal-footer">
      <button class="btn btn-ghost" onclick="closeApprovalModal()">Cancel</button>
      <button class="btn" style="background:var(--red);color:#fff" onclick="rejectApproval()">⛔ Reject</button>
      <button class="btn btn-primary" onclick="approveAction()">✓ Approve &amp; Execute</button>
    </div>
  </div>
</div>
<script>
'use strict';
// ══════════════════════════════════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════════════════════════════════
const COMMODITIES = [
  {id:'eth',name:'Ethylene',region:'EU',price:1175,unit:'USD/ton',cov:78,signal:'BUY',chg:+2.3,m2m:+1.07,conf:87,spend:28.4,cat:'Petrochem',priority:9.2,spark:[1050,1080,1095,1120,1160,1140,1175]},
  {id:'nfdm',name:'NFDM',region:'US',price:1.19,unit:'USD/lb',cov:82,signal:'BUY',chg:-1.1,m2m:+0.78,conf:91,spend:26.0,cat:'Dairy',priority:8.1,spark:[1.05,1.09,1.12,1.15,1.18,1.17,1.19]},
  {id:'wmp',name:'WMP',region:'EU',price:3230,unit:'USD/MT',cov:65,signal:'HOLD',chg:+0.4,m2m:+0.96,conf:74,spend:22.8,cat:'Dairy',priority:7.4,spark:[2900,2980,3050,3100,3180,3210,3230]},
  {id:'smp',name:'SMP',region:'NZ',price:2787,unit:'USD/MT',cov:54,signal:'BUY',chg:+5.2,m2m:+0.47,conf:68,spend:6.2,cat:'Dairy',priority:6.8,spark:[2400,2550,2620,2700,2750,2760,2787]},
  {id:'palm',name:'Palm Oil',region:'MY',price:4120,unit:'USD/MT',cov:71,signal:'HOLD',chg:-3.4,m2m:+1.34,conf:82,spend:41.2,cat:'Veg Oil',priority:8.7,spark:[3800,3900,4050,4200,4150,4100,4120]},
  {id:'prop',name:'Propylene',region:'EU',price:890,unit:'USD/ton',cov:45,signal:'SELL',chg:-6.1,m2m:-0.23,conf:79,spend:19.6,cat:'Petrochem',priority:5.3,spark:[980,950,930,910,890,895,890]},
];

const SIGNALS_DATA = [
  {type:'SATELLITE',icon:'🛰',text:'Crop density index for Malaysian palm plantations −8% MoM. Pre-emptive hedge window: 24–72hrs before market reprices.',comm:'Palm Oil',impact:'HIGH',dir:'up',age:'2h ago'},
  {type:'AIS SHIPPING',icon:'🚢',text:'Red Sea container diversions +34% WoW. Ethylene spot premium expected +8–12% within 5 trading days.',comm:'Ethylene',impact:'HIGH',dir:'up',age:'3h ago'},
  {type:'WEATHER',icon:'🌦',text:'La Niña weakening over NZ — Fonterra crop revision expected. WMP forward curve may soften 4–6%.',comm:'WMP NZ',impact:'MED',dir:'down',age:'5h ago'},
  {type:'CENTRAL BANK',icon:'🏛',text:'ECB hold confirmed. EUR/USD stable. No FX impact on EUR-denominated dairy hedges.',comm:'All Dairy',impact:'LOW',dir:'neutral',age:'6h ago'},
  {type:'PROXY HEDGE',icon:'🔗',text:'Naphtha-Propylene spread at 10yr low. Synthetic hedge via Naphtha futures is 37% more efficient than direct Propylene OTC.',comm:'Propylene',impact:'HIGH',dir:'up',age:'8h ago'},
  {type:'SENTIMENT',icon:'📊',text:'Bloomberg Commodity Fund Flow Index: −$4.2B outflow from agri futures. Short-term price pressure on dairy.',comm:'Dairy',impact:'MED',dir:'down',age:'11h ago'},
  {type:'SUPPLY CHAIN',icon:'🏭',text:'BASF cracker maintenance scheduled Q2. Ethylene supply tightening +3–5% expected May–June.',comm:'Ethylene',impact:'MED',dir:'up',age:'14h ago'},
  {type:'CARBON CBAM',icon:'🌿',text:'EU CBAM carbon premium for Ethylene imports from non-EU: +€28/ton. Factor in synthetic routes.',comm:'Ethylene',impact:'MED',dir:'up',age:'1d ago'},
];

const REGRET_DATA = [
  {date:'Nov 2025',comm:'Ethylene',action:'Overrode AI → Reduced coverage to 65%',outcome:'Price rose +14.2%',cost:'-£0.31M',won:false},
  {date:'Sep 2025',comm:'Palm Oil',action:'Overrode AI → Held coverage (AI said sell)',outcome:'Price fell −8.7%',cost:'-£0.27M',won:false},
  {date:'Jul 2025',comm:'NFDM US',action:'Overrode AI → Increased to 92%',outcome:'Price rose +6.3% — human override correct',cost:'+£0.19M',won:true},
  {date:'May 2025',comm:'WMP EU',action:'Overrode AI → Delayed hedge by 3 weeks',outcome:'Price moved +11.1% in 3wks',cost:'-£0.24M',won:false},
];

const GENOME_PRODUCTS = [
  {name:'Dettol Liquid',sku:'3.2M units/yr',ingredients:[
    {name:'Ethanol (94%)',pct:32,comm:'Ethylene',exp:'High'},
    {name:'Pine Oil (4%)',pct:8,comm:'Pine Resin',exp:'Med'},
    {name:'PET Bottle',pct:12,comm:'Propylene',exp:'Med'},
  ]},
  {name:'Harpic Toilet Bowl',sku:'2.8M units/yr',ingredients:[
    {name:'HCl Acid (40%)',pct:24,comm:'Chlorine',exp:'Low'},
    {name:'Surfactants (8%)',pct:18,comm:'Ethylene',exp:'High'},
    {name:'HDPE Bottle',pct:10,comm:'Ethylene',exp:'High'},
  ]},
  {name:'Enfamil Formula',sku:'1.9M units/yr',ingredients:[
    {name:'Skim Milk Powder (62%)',pct:62,comm:'NFDM',exp:'High'},
    {name:'Palm Olein (18%)',pct:18,comm:'Palm Oil',exp:'High'},
    {name:'Whey Protein (12%)',pct:12,comm:'WMP',exp:'Med'},
  ]},
  {name:'Finish Dishwash',sku:'4.1M units/yr',ingredients:[
    {name:'Surfactant blend (35%)',pct:35,comm:'Propylene',exp:'Med'},
    {name:'Rinse Aid (15%)',pct:15,comm:'Ethylene',exp:'High'},
    {name:'PP Container',pct:8,comm:'Propylene',exp:'Med'},
  ]},
];

const SCENARIOS = [
  {id:'geo',label:'🌍 Geopolitical Shock',desc:'Red Sea closure, sanctions, supply disruption'},
  {id:'climate',label:'🌦 Climate / La Niña',desc:'Crop failures, drought, flood disruption'},
  {id:'macro',label:'📉 Macro Downturn',desc:'Recession, rate spike, currency collapse'},
  {id:'supply',label:'🏭 Supply Disruption',desc:'Plant shutdown, labor strike, force majeure'},
];

const POLICIES = [
  {text:'Maximum 85% coverage on any single commodity during earnings black-out periods', active:true},
  {text:'Never hedge Propylene above 70% when futures contango > 8%', active:true},
  {text:'Minimum 50% coverage on all Tier 1 commodities at all times', active:true},
];

const PEERS = [
  {comm:'Dairy (Overall)',you:65,peer:83,reco:80},
  {comm:'Palm Oil',you:71,peer:59,reco:75},
  {comm:'Petrochemicals',you:62,peer:68,reco:70},
  {comm:'Specialty Chem',you:38,peer:44,reco:55},
];

const COUNTERPARTIES = [
  {name:'Goldman Sachs',exposure:'£42M',rating:'AA−',cds:28,risk:'Low'},
  {name:'Deutsche Bank',exposure:'£31M',rating:'A+',cds:54,risk:'Medium'},
  {name:'Cargill Risk Mgmt',exposure:'£22M',rating:'A−',cds:41,risk:'Low'},
  {name:'Macquarie Comm.',exposure:'£18M',rating:'BBB+',cds:87,risk:'Medium'},
];

const NOTIFICATIONS = [
  {icon:'⚡',title:'AI Oracle: 3 new recommendations',sub:'Ethylene +7%, SMP +12%, Propylene re-evaluate',time:'5m ago',unread:true,type:'ai'},
  {icon:'🛰',title:'Satellite alert: Palm Oil Malaysia',sub:'Crop density down 8% — hedge window open',time:'2h ago',unread:true,type:'signal'},
  {icon:'🚢',title:'AIS: Red Sea diversions +34%',sub:'Ethylene premium expected +8–12% in 5 days',time:'3h ago',unread:true,type:'signal'},
  {icon:'📋',title:'IFRS 9 test passed — Ethylene',sub:'Hedge effectiveness confirmed at 94.2%',time:'1d ago',unread:false,type:'compliance'},
  {icon:'⚠️',title:'Behavioral bias flagged',sub:'Anchoring detected on Ethylene coverage decisions',time:'1d ago',unread:false,type:'risk'},
];

const CMD_ITEMS = [
  {icon:'◎',label:'Dashboard',desc:'Main overview',action:()=>showModule('dashboard',document.getElementById('nav-dashboard'))},
  {icon:'⚡',label:'AI Oracle',desc:'Run AI recommendations',action:()=>showModule('oracle',document.getElementById('nav-oracle'))},
  {icon:'📈',label:'Commodity Desk',desc:'Live commodity portfolio',action:()=>showModule('commodity',document.getElementById('nav-commodity'))},
  {icon:'◎',label:'Scoring Profiles',desc:'Portfolio health & decision scoring',action:()=>showModule('profiles',document.getElementById('nav-profiles'))},
  {icon:'🧬',label:'Product Genome',desc:'SKU ingredient mapping',action:()=>showModule('genome',document.getElementById('nav-genome'))},
  {icon:'◈',label:'Scenario Engine',desc:'Stress-testing & tail risk',action:()=>showModule('scenarios',document.getElementById('nav-scenarios'))},
  {icon:'🛰',label:'Signal Lab',desc:'50+ alternative data streams',action:()=>showModule('signals',document.getElementById('nav-signals'))},
  {icon:'💰',label:'Revenue Engine',desc:'Dynamic pricing & elasticity',action:()=>showModule('revenue',document.getElementById('nav-revenue'))},
  {icon:'📊',label:'Demand Forecast',desc:'13-week ML forecasting',action:()=>showModule('demand',document.getElementById('nav-demand'))},
  {icon:'💡',label:'Profitability',desc:'SKU-level margin analytics',action:()=>showModule('profitability',document.getElementById('nav-profitability'))},
  {icon:'🚛',label:'Supply Chain',desc:'Fleet & logistics command',action:()=>showModule('supply',document.getElementById('nav-supply'))},
  {icon:'📑',label:'Reports',desc:'Executive reporting & exports',action:()=>showModule('reports',document.getElementById('nav-reports'))},
  {icon:'⚙',label:'Settings',desc:'Platform preferences',action:()=>showModule('settings',document.getElementById('nav-settings'))},
];

// STATE
let currentModule = 'dashboard';
let oracleRan = false;
let scenarioChart = null;
let hedgeFuturesChart = null;
let signalDonutBuilt = false;
let biasRadarBuilt = false;
let phsChartBuilt = false;
let critChartBuilt = false;
let selectedScenarioIdx = 0;
let cmdSelectedIdx = -1;
let cmdResults = [];
let activeCharts = {};

// ══════════════════════════════════════════════════════════════════════════════
// NAVIGATION
// ══════════════════════════════════════════════════════════════════════════════
function showModule(module, navEl) {
  currentModule = module;
  // Update nav — clear both nav-item AND nav-sub-item active states
  document.querySelectorAll('.nav-item, .nav-sub-item').forEach(n => n.classList.remove('active'));
  if (navEl) navEl.classList.add('active');

  // Update breadcrumb
  const labels = {
    dashboard:'Dashboard',oracle:'AI Oracle',commodity:'Commodity Desk',
    profiles:'Scoring Profiles',genome:'Product Genome',scenarios:'Scenario Engine',
    signals:'Signal Lab',revenue:'Revenue Engine',demand:'Demand Forecast',
    profitability:'Profitability',supply:'Supply Chain',reports:'Reports',settings:'Settings',
    marginbridge:'Margin Bridge',
    'pricing-os':'Revenue Engine › Pricing OS'
  };
  document.getElementById('topbar-breadcrumb').innerHTML =
    module === 'pricing-os'
      ? `<span style="color:var(--ink-faint)">NERVURE</span>
         <span style="color:var(--ink-ghost)">›</span>
         <span style="color:var(--ink-soft)">Revenue Engine</span>
         <span style="color:var(--ink-ghost)">›</span>
         <strong style="color:var(--pink)">Pricing OS</strong>`
      : `<span style="color:var(--ink-faint)">NERVURE</span>
         <span style="color:var(--ink-ghost)">›</span>
         <strong>${labels[module]||module}</strong>`;

  // Toggle EU AI Act badge
  const euBadge = document.getElementById('eu-ai-badge-wrap');
  if (euBadge) euBadge.classList.toggle('visible', module === 'pricing-os');

  const content = document.getElementById('content');
  content.style.opacity = '0';
  content.style.transform = 'translateY(8px)';

  // Destroy ALL Chart.js instances to prevent memory leak
  try {
    // Destroy by registry (Chart.js 3+)
    const instances = Object.values(Chart.instances || {});
    instances.forEach(c => { try { c.destroy(); } catch(e){} });
  } catch(e) {}
  // Destroy named instances
  [hedgeFuturesChart, crossElasticityChart, promoDecompChart, promoChannelChart, scenarioChart].forEach(c => {
    try { if (c) c.destroy(); } catch(e) {}
  });
  Object.values(activeCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  activeCharts = {};
  scenarioChart = null;
  hedgeFuturesChart = null; crossElasticityChart = null; promoDecompChart = null; promoChannelChart = null;
  signalDonutBuilt = false;
  biasRadarBuilt = false;
  phsChartBuilt = false;
  critChartBuilt = false;
  // Stop any running animations from previous module
  if (typeof reflectionAnimFrame !== 'undefined' && reflectionAnimFrame) {
    cancelAnimationFrame(reflectionAnimFrame);
    reflectionAnimFrame = null;
  }

  requestAnimationFrame(() => {
    const html = getModuleHTML(module);
    content.innerHTML = html;
    content.style.transition = 'none';
    content.style.opacity = '1';
    content.style.transform = 'translateY(0)';
    requestAnimationFrame(() => {
      content.style.transition = 'opacity 0.28s ease, transform 0.28s ease';
      afterModuleRender(module);
    });
  });
}

function getModuleHTML(m) {
  switch(m) {
    case 'dashboard': return renderDashboard();
    case 'oracle': return renderOracle();
    case 'commodity': return renderCommodity();
    case 'profiles': return renderProfiles();
    case 'genome': return renderGenome();
    case 'scenarios': return renderScenarios();
    case 'signals': return renderSignals();
    case 'revenue': return renderRevenue();
    case 'demand': return renderDemand();
    case 'profitability': return renderProfitability();
    case 'supply': return renderSupply();
    case 'reports': return renderReports();
    case 'settings': return renderSettings();
    case 'marginbridge': return renderMarginBridge();
    case 'pricing-os': return renderPricingOS();
    default: return '<div>Module not found</div>';
  }
}

function afterModuleRender(m) {
  switch(m) {
    case 'dashboard': buildDashboard(); initPriceReflection(); startWatchCycle(); break;
    case 'oracle': if(!oracleRan) runOracle(); else showOracleResults(); break;
    case 'commodity': buildCommodityTable(); buildSignalFeed('signal-feed', 5); break;
    case 'profiles': buildProfiles(); break;
    case 'genome': buildGenomeTree(); buildGenomeCommodityBtns(); break;
    case 'scenarios': initScenario(); break;
    case 'signals': buildSignals(); break;
    case 'revenue': buildRevenue(); break;
    case 'demand': buildDemand(); break;
    case 'profitability': buildProfitability(); break;
    case 'supply': buildSupply(); break;
    case 'pricing-os': buildPricingOS(); break;
    case 'marginbridge': buildMarginBridge(); break;
    case 'settings': break;
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// SIDEBAR
// ══════════════════════════════════════════════════════════════════════════════
function buildSidebar() {
  const el = document.getElementById('sb-comm-list');
  const sigColors = {BUY:'var(--green)',HOLD:'var(--amber)',SELL:'var(--red)'};
  el.innerHTML = COMMODITIES.map(c => `
    <div class="comm-mini" onclick="showModule('commodity',document.getElementById('nav-commodity'))">
      <div class="comm-dot" style="background:${sigColors[c.signal]}"></div>
      <div class="comm-mini-name">${c.name}</div>
      <div class="comm-mini-val" style="color:${sigColors[c.signal]}">${c.cov}%</div>
    </div>`).join('');

  buildNotifications();
}

// ══════════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ══════════════════════════════════════════════════════════════════════════════
function buildNotifications() {
  const el = document.getElementById('notif-list');
  el.innerHTML = NOTIFICATIONS.map((n,i) => `
    <div style="display:flex;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border-s);cursor:pointer;transition:var(--transition);${n.unread?'background:rgba(13,148,136,.03)':''}"
         onmouseenter="this.style.background='var(--teal-glow-s)'" onmouseleave="this.style.background='${n.unread?'rgba(13,148,24,.03)':''}'"
         onclick="readNotif(${i})">
      <div style="font-size:20px;flex-shrink:0;margin-top:2px">${n.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">
          <div style="font-size:13px;font-weight:${n.unread?'700':'500'};color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${n.title}</div>
          ${n.unread?'<div style="width:6px;height:6px;border-radius:50%;background:var(--teal);flex-shrink:0"></div>':''}
        </div>
        <div style="font-size:11.5px;color:var(--ink-soft);line-height:1.4">${n.sub}</div>
        <div style="font-size:10.5px;color:var(--ink-faint);margin-top:3px">${n.time}</div>
      </div>
    </div>`).join('');
}

function toggleNotif() {
  const p = document.getElementById('notif-panel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) {
    document.addEventListener('click', closeNotifOutside, true);
  }
}
function closeNotif() {
  document.getElementById('notif-panel').classList.remove('open');
  document.removeEventListener('click', closeNotifOutside, true);
}
function closeNotifOutside(e) {
  const p = document.getElementById('notif-panel');
  const btn = e.target.closest('.topbar-icon-btn');
  if (!p.contains(e.target) && !btn) closeNotif();
}
function readNotif(i) {
  NOTIFICATIONS[i].unread = false;
  buildNotifications();
}
function markAllRead() {
  NOTIFICATIONS.forEach(n => n.unread = false);
  buildNotifications();
}

// ══════════════════════════════════════════════════════════════════════════════
// COMMAND PALETTE
// ══════════════════════════════════════════════════════════════════════════════
function openCmd() {
  document.getElementById('cmd-overlay').classList.add('open');
  setTimeout(() => document.getElementById('cmd-input').focus(), 50);
  cmdFilter('');
}
function closeCmd(e) {
  if (!e || e.target === document.getElementById('cmd-overlay')) {
    document.getElementById('cmd-overlay').classList.remove('open');
    document.getElementById('cmd-input').value = '';
    cmdSelectedIdx = -1;
  }
}
function cmdFilter(q) {
  q = q.toLowerCase().trim();
  cmdResults = q ? CMD_ITEMS.filter(i => i.label.toLowerCase().includes(q) || i.desc.toLowerCase().includes(q)) : CMD_ITEMS;
  cmdSelectedIdx = -1;
  renderCmdResults();
}
function renderCmdResults() {
  const el = document.getElementById('cmd-results');
  if (!cmdResults.length) { el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ink-faint);font-size:13px">No results</div>'; return; }
  el.innerHTML = cmdResults.map((r,i) => `
    <div class="cmd-result${i===cmdSelectedIdx?' selected':''}" onclick="runCmd(${i})">
      <div class="cmd-result-icon">${r.icon}</div>
      <div>
        <div class="cmd-result-label">${r.label}</div>
        <div class="cmd-result-desc">${r.desc}</div>
      </div>
    </div>`).join('');
}
function runCmd(i) {
  if (cmdResults[i]) { cmdResults[i].action(); closeCmd(); }
}
function cmdKeydown(e) {
  if (e.key === 'Escape') { closeCmd(); return; }
  if (e.key === 'ArrowDown') { cmdSelectedIdx = Math.min(cmdSelectedIdx+1, cmdResults.length-1); renderCmdResults(); }
  if (e.key === 'ArrowUp') { cmdSelectedIdx = Math.max(cmdSelectedIdx-1, 0); renderCmdResults(); }
  if (e.key === 'Enter' && cmdSelectedIdx >= 0) { runCmd(cmdSelectedIdx); }
}
document.addEventListener('keydown', e => { if ((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); openCmd(); } });

// ══════════════════════════════════════════════════════════════════════════════
// HELPER: SPARKLINE
// ══════════════════════════════════════════════════════════════════════════════
function drawSparkline(canvasId, data, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const min = Math.min(...data), max = Math.max(...data);
  const range = max - min || 1;
  const pts = data.map((v,i) => ({ x: (i/(data.length-1))*w, y: h - ((v-min)/range)*(h-4) - 2 }));

  ctx.clearRect(0,0,w,h);
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0, color+'40'); grad.addColorStop(1, color+'05');

  ctx.beginPath(); ctx.moveTo(pts[0].x, h);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, h); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();
}

// ══════════════════════════════════════════════════════════════════════════════
// HELPER: SIGNAL FEED
// ══════════════════════════════════════════════════════════════════════════════
function buildSignalFeed(elId, limit) {
  const el = document.getElementById(elId);
  if (!el) return;
  const data = limit ? SIGNALS_DATA.slice(0,limit) : SIGNALS_DATA;
  const impColor = {HIGH:'var(--red)',MED:'var(--amber)',LOW:'var(--green)'};
  const dirIcon = {up:'↑',down:'↓',neutral:'→'};
  el.innerHTML = data.map(s => `
    <div class="signal-item" onclick="">
      <div class="signal-icon">${s.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
          <span class="signal-type" style="color:${impColor[s.impact]}">${s.type}</span>
          <span class="badge ${s.impact==='HIGH'?'badge-red':s.impact==='MED'?'badge-amber':'badge-buy'}" style="font-size:9px">${s.impact}</span>
          <span style="font-size:12px;color:${s.dir==='up'?'var(--green)':'var(--red)'};margin-left:auto">${dirIcon[s.dir]}</span>
        </div>
        <div class="signal-text">${s.text}</div>
        <div class="signal-meta">
          <span style="background:var(--teal-glow);color:var(--teal);padding:1px 5px;border-radius:4px;font-weight:600;font-size:10px">${s.comm}</span>
          <span>${s.age}</span>
        </div>
      </div>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════════════════════════════════
function renderDashboard() {
  return `
  <div class="animate-in">
    <!-- Hero -->
    <div class="hero glass-stage">
      <canvas id="hero-reflection"></canvas>
      <div class="hero-content">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px">
          <div style="flex:1">
            <div class="hero-eyebrow">Monday · 23 Feb 2026 · Q1 Hedging Cycle</div>
            <div class="hero-title">Good morning, Sandip.<br><em>4 commodities</em> need action today.</div>
            <div class="hero-sub">AI auto-tuned 4 parameter sets overnight · Ethylene coverage reco +7% · Proxy hedge discovered for Propylene · New Red Sea signal detected</div>
            <div class="hero-actions">
              <button class="btn btn-primary" onclick="showModule('oracle',document.getElementById('nav-oracle'))">⚡ Run AI Oracle</button>
              <button class="btn btn-gold" onclick="showModule('scenarios',document.getElementById('nav-scenarios'))">◈ Scenario Engine</button>
              <button class="btn btn-dark" onclick="showModule('profiles',document.getElementById('nav-profiles'))">◎ Scoring Profiles</button>
            </div>
          </div>
          <div style="display:flex;gap:12px;flex-shrink:0">
            <div class="hero-stat">
              <div class="hero-stat-val">84</div>
              <div class="hero-stat-lbl">Portfolio Health</div>
            </div>
            <div class="hero-stat">
              <div class="hero-stat-val">+£4.3M</div>
              <div class="hero-stat-lbl">YTD Mark-to-Market</div>
            </div>
            <div class="hero-stat">
              <div class="hero-stat-val">77%</div>
              <div class="hero-stat-lbl">Avg Coverage</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Nervure Watch Cycle ── -->
    <div class="watch-cycle-bar" id="watch-cycle-bar">
      <div class="wc-label"><div class="wc-pulse"></div>Watch Cycle</div>
      <div class="wc-agents">
        <div class="wc-agent done" id="wc-1"><span class="wc-agent-icon">🔭</span><span>Oracle</span><span class="wc-check">✓</span></div>
        <div class="wc-arrow">›</div>
        <div class="wc-agent done" id="wc-2"><span class="wc-agent-icon">🔗</span><span>Margin Bridge</span><span class="wc-check">✓</span></div>
        <div class="wc-arrow">›</div>
        <div class="wc-agent active" id="wc-3"><span class="wc-agent-icon">🎯</span><span>PriceOS · 1,024 scenarios</span><span style="font-size:10px;opacity:.6;animation:spin .8s linear infinite;display:inline-block">⟳</span></div>
        <div class="wc-arrow">›</div>
        <div class="wc-agent pending" id="wc-4"><span class="wc-agent-icon">🛡</span><span>Hedge Agent</span></div>
      </div>
      <div class="wc-timer">Next run <strong id="wc-countdown">14:32</strong></div>
      <button class="wc-autopilot-btn on" id="wc-autopilot-btn" onclick="toggleWcAutopilot(this)">Autopilot ON</button>
    </div>

    <!-- ── Margin Bridge Alert ── -->
    <div style="background:linear-gradient(90deg,rgba(245,158,11,.05),rgba(13,148,136,.05));border:1px solid rgba(245,158,11,.22);border-radius:var(--r12);padding:13px 18px;margin-bottom:14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:var(--transition)"
         onmouseenter="this.style.borderColor='rgba(13,148,136,.35)'" onmouseleave="this.style.borderColor='rgba(245,158,11,.22)'"
         onclick="showModule('marginbridge',document.getElementById('nav-marginbridge'))">
      <div style="width:34px;height:34px;border-radius:8px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0">🔗</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:12.5px;font-weight:700;color:var(--ink);margin-bottom:1px">Margin Bridge Alert — <span style="color:var(--amber)">Ethylene +18.2% spike detected</span></div>
        <div style="font-size:11px;color:var(--ink-soft)">PriceOS elasticity confirms max <strong style="color:var(--teal)">+4.2% safe pass-through</strong> before volume cliff · Residual gap: <strong style="color:var(--red)">£1.8M</strong> · 3 SKUs need action</div>
      </div>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0" onclick="event.stopPropagation();showModule('marginbridge',document.getElementById('nav-marginbridge'))">View Analysis →</button>
    </div>

    <!-- KPI Row -->
    <div class="g5 animate-in-delay-1" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Total Hedged Spend</div>
        <div class="kpi-val">£144M</div>
        <div class="kpi-delta up">↑ +8.2% YoY</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Active Instruments</div>
        <div class="kpi-val">47</div>
        <div class="kpi-delta neutral">Across 6 commodities</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Unhedged Exposure</div>
        <div class="kpi-val">£33.2M</div>
        <div class="kpi-delta down">↓ 3 at-risk</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--purple)">
        <div class="kpi-label">IFRS 9 Effectiveness</div>
        <div class="kpi-val">94.2%</div>
        <div class="kpi-delta up">✓ All pass</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--gold)">
        <div class="kpi-label">AI Rec. Accuracy (12mo)</div>
        <div class="kpi-val">81.4%</div>
        <div class="kpi-delta up">↑ +3.1% vs Q4</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="g-main animate-in-delay-2">
      <!-- Commodity Table -->
      <div>
        <!-- PriceOS Widget — embedded recommendation -->
        <div class="priceos-widget" style="margin-bottom:16px" onclick="showModule('pricing-os',document.getElementById('nav-pricing-os'))">
          <div class="priceos-widget-tag">
            <span style="display:inline-flex;align-items:center;gap:4px;width:6px;height:6px;border-radius:50%;background:var(--pink);box-shadow:0 0 8px var(--pink);animation:liveNumPulse 2s ease-in-out infinite"></span>
            Pricing OS by PriceOS — Revenue Engine Module
          </div>
          <div class="priceos-widget-val count-up">+<em>£2.1M</em></div>
          <div class="priceos-widget-sub">Projected margin this week if top 3 scenarios are applied · Dettol + Harpic + Finish · AME Region · Confidence: 91%</div>
          <div style="display:flex;align-items:center;gap:16px;margin-top:14px;flex-wrap:wrap">
            <button class="priceos-widget-btn">→ Open Autopilot +£2.1M</button>
            <div style="font-size:11.5px;color:rgba(255,255,255,.35)">1,024 scenarios run overnight · 3 pilots live · EU AI Act ✓</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="card-title">Live Commodity Portfolio</div>
              <div class="card-sub">Real-time prices · AI signals · Coverage vs recommendation</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-sm" onclick="showModule('commodity',document.getElementById('nav-commodity'))">Full View →</button>
            </div>
          </div>
        <div class="tbl-head" style="grid-template-columns:1fr 80px 65px 72px 80px 60px 56px 54px">
          <span>Commodity</span><span>Price</span><span>Change</span>
          <span>Signal</span><span>Coverage</span><span>M2M £M</span>
          <span>Priority</span><span>Trend</span>
        </div>
        <div id="comm-table"></div>
      </div>
      </div><!-- end inner left column wrapper -->
      <div style="display:flex;flex-direction:column;gap:14px">
        <!-- Signal Feed -->
        <div class="card" style="overflow:hidden">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="card-title">Alternative Signals</div>
              <div class="card-sub">Live intelligence feed</div>
            </div>
            <div class="live-pill"><div class="live-dot"></div><span class="live-txt">Live</span></div>
          </div>
          <div id="signal-feed"></div>
          <div style="padding:12px 18px;border-top:1px solid var(--border-s);text-align:center">
            <button class="btn btn-ghost btn-sm" onclick="showModule('signals',document.getElementById('nav-signals'))">View All 50 Signals →</button>
          </div>
        </div>

        <!-- Execution Windows -->
        <div class="card" style="padding:18px 20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:3px">🎯 Execution Windows</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">AI-detected timing opportunities</div>

          <div class="window-card window-open">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span style="font-size:11px;font-weight:800;color:var(--green)">🟢 WINDOW OPEN</span>
              <span style="font-size:11px;color:var(--ink-faint)">Closes in 16h</span>
            </div>
            <div style="font-size:15px;font-weight:700;margin-bottom:3px">Ethylene EU</div>
            <div style="font-size:12px;color:var(--ink-soft);line-height:1.55">Spot premium compression. AI confidence 87%. Optimal entry: £1,172–£1,178. Target +9% coverage. M2M uplift: <strong style="color:var(--green)">+£1.07M</strong></div>
            <div style="margin-top:10px">
              <button class="btn btn-primary btn-sm" onclick="showModule('oracle',document.getElementById('nav-oracle'))">Execute Hedge</button>
            </div>
          </div>

          <div class="window-card window-closed">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span style="font-size:11px;font-weight:800;color:var(--red)">🔴 WINDOW CLOSED</span>
              <span style="font-size:11px;color:var(--ink-faint)">Closed 1h ago</span>
            </div>
            <div style="font-size:15px;font-weight:700;margin-bottom:3px">SMP NZ</div>
            <div style="font-size:12px;color:var(--ink-soft);line-height:1.55">Price rebounded +4.2%. Missed window. Potential: <strong style="color:var(--red)">−£0.18M</strong></div>
            <div style="margin-top:10px"><span class="badge badge-red">Regret Logged</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function buildDashboard() {
  buildCommodityTable();
  buildSignalFeed('signal-feed', 5);
}

function buildCommodityTable() {
  const el = document.getElementById('comm-table');
  if (!el) return;
  const sigClass = {BUY:'badge-buy',HOLD:'badge-hold',SELL:'badge-sell'};
  const sigColor = {BUY:'var(--green)',HOLD:'var(--amber)',SELL:'var(--red)'};
  const prioColor = p => p>=8.5?'var(--red)':p>=7?'var(--amber)':'var(--green)';

  el.innerHTML = COMMODITIES.map((c,i) => {
    const chgColor = c.chg > 0 ? 'var(--green)' : 'var(--red)';
    const covColor = c.cov>=75?'var(--green)':c.cov>=60?'var(--amber)':'var(--red)';
    const priceStr = c.price>10 ? c.price.toLocaleString() : c.price.toFixed(2);
    return `
    <div class="tbl-row" style="grid-template-columns:1fr 80px 65px 72px 80px 60px 56px 54px"
         onclick="showModule('profiles',document.getElementById('nav-profiles'))">
      <div>
        <div style="font-size:13.5px;font-weight:700;color:var(--ink)">${c.name}</div>
        <div style="font-size:11px;color:var(--ink-faint)">${c.cat} · ${c.region}</div>
      </div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--ink-mid)">${priceStr}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:${chgColor}">${c.chg>0?'+':''}${c.chg}%</div>
      <div><span class="badge ${sigClass[c.signal]}">${c.signal}</span></div>
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:${covColor}">${c.cov}%</div>
        <div style="margin-top:4px"><div class="prog-bar" style="width:100%;height:3px"><div class="prog-fill" style="width:${c.cov}%;background:${covColor}"></div></div></div>
      </div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:${c.m2m>=0?'var(--green)':'var(--red)'}">${c.m2m>=0?'+':''}£${c.m2m}M</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:${prioColor(c.priority)}">${c.priority}</div>
      <div><canvas id="spark-${c.id}" width="54" height="24" class="sparkline-canvas"></canvas></div>
    </div>`
  }).join('');

  COMMODITIES.forEach(c => {
    const color = c.spark[c.spark.length-1] >= c.spark[0] ? '#10B981' : '#EF4444';
    drawSparkline(`spark-${c.id}`, c.spark, color);
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// AI ORACLE
// ══════════════════════════════════════════════════════════════════════════════
function renderOracle() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">⚡ AI Oracle Engine</div>
        <div class="page-sub">Bayesian optimization · 340 scenario runs · IFRS 9 tested · Behavioral bias detection</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="oracleRan=false;showModule('oracle',document.getElementById('nav-oracle'))">↺ Re-run</button>
        <button class="btn btn-primary" onclick="">⬇ Export Audit Trail</button>
      </div>
    </div>

    <div id="oracle-loading">
      <div class="card" style="padding:40px 32px;text-align:center">
        <div style="font-size:36px;margin-bottom:16px;animation:float 2s ease-in-out infinite">⚡</div>
        <div style="font-size:20px;font-weight:700;margin-bottom:6px">AI Oracle Processing</div>
        <div style="font-size:13px;color:var(--ink-soft);margin-bottom:28px">Fusing 50+ data streams · Running Bayesian optimization</div>
        <div style="max-width:440px;margin:0 auto;height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:24px">
          <div id="oracle-progress" style="height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-l));border-radius:2px;width:0;transition:width .4s ease"></div>
        </div>
        <div id="oracle-steps" style="max-width:440px;margin:0 auto;text-align:left"></div>
      </div>
    </div>

    <div id="oracle-results" style="display:none">
      <!-- Summary KPIs -->
      <div class="g4" style="margin-bottom:16px">
        <div class="kpi" style="--kpi-accent:var(--green)">
          <div class="kpi-label">Estimated P&L Uplift</div>
          <div class="kpi-val">+£3.8M</div>
          <div class="kpi-delta up">If all recommendations adopted</div>
        </div>
        <div class="kpi" style="--kpi-accent:var(--teal)">
          <div class="kpi-label">Avg Model Confidence</div>
          <div class="kpi-val">80.2%</div>
          <div class="kpi-delta neutral">Across 6 commodities</div>
        </div>
        <div class="kpi" style="--kpi-accent:var(--amber)">
          <div class="kpi-label">Behavioral Bias Flags</div>
          <div class="kpi-val">1</div>
          <div class="kpi-delta down">Anchoring · Ethylene</div>
        </div>
        <div class="kpi" style="--kpi-accent:var(--purple)">
          <div class="kpi-label">IFRS 9 Status</div>
          <div class="kpi-val">5 / 6</div>
          <div class="kpi-delta neutral">1 requires review</div>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="card" style="margin-bottom:16px;overflow:hidden">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="card-title">AI Recommendations</div>
            <div class="card-sub">Ranked by expected P&L impact · Accept individually or batch execute</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm">Filter by Signal</button>
            <button class="btn btn-primary btn-sm" onclick="executeAllOracleRecs()">Accept All ✓</button>
          </div>
        </div>
        <div class="tbl-head" style="grid-template-columns:1fr 70px 70px 80px 80px 1fr 130px">
          <span>Commodity</span><span>Signal</span><span>Current</span>
          <span>AI Target</span><span>Δ Impact</span><span>Confidence</span><span>Actions</span>
        </div>
        <div id="oracle-reco-cards"></div>
      </div>

      <!-- Oracle Insights -->
      <div class="g2" style="margin-bottom:16px">
        <div class="card" style="padding:22px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">🧠 Parameter Optimization</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Bayesian auto-tuning ran 340 scenario combinations</div>
          ${['Risk Appetite Weight','Momentum Alpha','Mean-Reversion Beta','Seasonal Adjustment','Confidence Threshold'].map((p,i)=>`
            <div class="prog-row" style="margin-bottom:12px">
              <div class="prog-label">${p}</div>
              <div class="prog-bar" style="flex:1"><div class="prog-fill" style="width:${[72,85,61,78,90][i]}%;background:var(--teal)"></div></div>
              <div class="prog-val" style="color:var(--teal)">${[72,85,61,78,90][i]}%</div>
            </div>`).join('')}
          <div class="diff-banner">
            <div class="diff-icon">🤖</div>
            <div>
              <div class="diff-title">Self-Calibrating Parameters</div>
              <div class="diff-text">Unlike static CTRM systems, Nervure auto-tunes all model parameters nightly using Bayesian optimization against your actual outcomes — no consultant needed.</div>
            </div>
          </div>
        </div>
        <div class="card" style="padding:22px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">📋 Natural Language Audit Trail</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Board-ready reasoning for every recommendation</div>
          ${COMMODITIES.map(c=>`
            <div style="padding:10px 12px;border:1px solid var(--border-s);border-radius:var(--r10);margin-bottom:8px;transition:var(--transition)" onmouseenter="this.style.borderColor='var(--border-m)'" onmouseleave="this.style.borderColor='var(--border-s)'">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                <span style="font-size:12.5px;font-weight:700">${c.name}</span>
                <span class="badge badge-teal" style="font-size:9px">IFRS 9 ✓</span>
              </div>
              <div style="font-size:11.5px;color:var(--ink-soft);line-height:1.55">
                ${c.signal==='BUY'?`Upward price momentum (+${c.chg}%), satellite data confirms supply tightening. Recommend coverage increase to capture ${c.conf}% confidence window.`:
                  c.signal==='HOLD'?`Mixed signals. Await confirmation from weather data before adjusting. Current coverage adequate at ${c.cov}%.`:
                  `Downward trend (${c.chg}%), excess supply detected. Reduce exposure via structured unwind. Proxy hedge via Naphtha available.`}
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

function runOracle() {
  const loadEl = document.getElementById('oracle-loading');
  const resEl = document.getElementById('oracle-results');
  if (!loadEl || !resEl) return;
  loadEl.style.display = 'block';
  resEl.style.display = 'none';

  const steps = [
    'Ingesting CME, ICE, LME live futures feeds…',
    'Bayesian parameter optimization — 340 scenario runs…',
    'Fusing 50+ alternative data signals (satellite, AIS, weather)…',
    'Running Synthetic Hedge Constructor for illiquid commodities…',
    'Checking behavioral bias profile — anchoring flagged on Ethylene…',
    'IFRS 9 hedge effectiveness prospective test…',
    'Generating natural language audit trail…',
    'Recommendations ready ✓',
  ];

  const stepsEl = document.getElementById('oracle-steps');
  stepsEl.innerHTML = steps.map((s,i) => `
    <div class="oracle-step" id="ostep-${i}">
      <div class="step-icon" id="oicon-${i}">○</div>
      <div style="flex:1;color:var(--ink-soft)">${s}</div>
      <div class="step-bar" style="width:80px"><div class="step-fill" id="ofill-${i}"></div></div>
    </div>`).join('');

  let i = 0;
  const prog = document.getElementById('oracle-progress');
  const tick = setInterval(() => {
    if (i > 0) {
      document.getElementById(`oicon-${i-1}`).textContent = '✓';
      document.getElementById(`oicon-${i-1}`).style.color = 'var(--green)';
      document.getElementById(`ostep-${i-1}`).classList.remove('active');
      document.getElementById(`ostep-${i-1}`).classList.add('done');
    }
    if (i < steps.length) {
      const stepEl = document.getElementById(`ostep-${i}`);
      stepEl.classList.add('active');
      document.getElementById(`oicon-${i}`).textContent = '⟳';
      document.getElementById(`oicon-${i}`).style.color = 'var(--teal)';
      document.getElementById(`ofill-${i}`).style.width = '100%';
      prog.style.width = `${((i+1)/steps.length)*100}%`;
      i++;
    } else {
      clearInterval(tick);
      setTimeout(() => {
        loadEl.style.display = 'none';
        showOracleResults();
        oracleRan = true;
      }, 400);
    }
  }, 620);
}

function showOracleResults() {
  const el = document.getElementById('oracle-results');
  if (!el) return;
  el.style.display = 'block';
  buildOracleRecos();
}

function buildOracleRecos() {
  const el = document.getElementById('oracle-reco-cards');
  if (!el) return;
  const sigClass = {BUY:'badge-buy',HOLD:'badge-hold',SELL:'badge-sell'};
  el.innerHTML = COMMODITIES.map(c => {
    const delta = Math.floor(Math.random()*7)+3;
    const newCov = Math.min(93, c.cov+delta);
    const impact = ((delta/100)*c.spend*0.042).toFixed(2);
    const biasWarn = c.id==='eth';
    return `
    <div class="tbl-row" style="grid-template-columns:1fr 70px 70px 80px 80px 1fr 130px;transition:var(--transition)"
         onmouseenter="this.style.background='var(--teal-glow-s)'" onmouseleave="this.style.background=''">
      <div>
        <div style="font-weight:700;font-size:13.5px">${c.name}</div>
        <div style="font-size:11px;color:var(--ink-faint)">${c.cat} · Priority ${c.priority}</div>
      </div>
      <span class="badge ${sigClass[c.signal]}">${c.signal}</span>
      <div style="font-family:'JetBrains Mono';font-size:14px;font-weight:600;color:var(--ink-mid)">${c.cov}%</div>
      <div style="font-family:'JetBrains Mono';font-size:16px;font-weight:800;color:var(--teal)">${newCov}%</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:var(--green)">+£${impact}M</div>
      <div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="prog-bar" style="flex:1;height:5px"><div class="prog-fill" style="width:${c.conf}%;background:var(--teal)"></div></div>
          <span style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:var(--teal)">${c.conf}%</span>
        </div>
        ${biasWarn?'<div style="font-size:10.5px;color:var(--amber);margin-top:4px">⚠ Anchoring bias detected</div>':''}
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-primary btn-xs" onclick="executeOracleRec(c.id, ${newCov})">Accept ✓</button>
        <button class="btn btn-ghost btn-xs" onclick="">Override</button>
        ${c.id==='eth'?`<span class="badge badge-amber">⚠ Bias</span>`:''}
        <span class="badge ${c.id==='prop'?'badge-red':'badge-teal'}" style="font-size:9px">${c.id==='prop'?'IFRS9 !':'IFRS9 ✓'}</span>
      </div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════════════════════════
// COMMODITY DESK
// ══════════════════════════════════════════════════════════════════════════════
function renderCommodity() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">Commodity Desk</div>
        <div class="page-sub">Live portfolio · Real-time pricing · AI signals · Hedge execution</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="">⬇ Export CSV</button>
        <button class="btn btn-primary" onclick="showModule('oracle',document.getElementById('nav-oracle'))">⚡ Run AI Oracle</button>
      </div>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">BUY Signals</div>
        <div class="kpi-val">3</div>
        <div class="kpi-delta up">Action required</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">HOLD Signals</div>
        <div class="kpi-val">2</div>
        <div class="kpi-delta neutral">Monitor closely</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--red)">
        <div class="kpi-label">SELL Signals</div>
        <div class="kpi-val">1</div>
        <div class="kpi-delta down">Propylene exposure</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Total Spend</div>
        <div class="kpi-val">£144M</div>
        <div class="kpi-delta neutral">6 active commodities</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px;overflow:hidden">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="card-title">Live Commodity Portfolio</div>
          <div class="card-sub">Click any row to drill into scoring profiles</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="">All Categories</button>
          <button class="btn btn-ghost btn-sm" onclick="">Dairy</button>
          <button class="btn btn-ghost btn-sm" onclick="">Petrochem</button>
        </div>
      </div>
      <div class="tbl-head" style="grid-template-columns:1fr 90px 70px 72px 90px 70px 60px 60px">
        <span>Commodity</span><span>Price</span><span>Change</span>
        <span>Signal</span><span>Coverage</span><span>M2M £M</span>
        <span>Priority</span><span>Trend</span>
      </div>
      <div id="comm-table"></div>
    </div>

    <div class="g2">
      <div class="card" style="overflow:hidden">
        <div class="card-header">
          <div class="card-title">Alternative Signals</div>
          <div class="card-sub">Latest intelligence by commodity</div>
        </div>
        <div id="signal-feed"></div>
        <div style="padding:12px 18px;border-top:1px solid var(--border-s);text-align:center">
          <button class="btn btn-ghost btn-sm" onclick="showModule('signals',document.getElementById('nav-signals'))">View All 50 Signals →</button>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:14px">Coverage vs Recommendation</div>
          ${COMMODITIES.map(c => `
            <div class="metric-row">
              <div>
                <div class="metric-name">${c.name}</div>
                <div class="metric-sub">${c.cat}</div>
              </div>
              <div style="flex:1;margin:0 12px">
                <div class="prog-bar"><div class="prog-fill" style="width:${c.cov}%;background:${c.cov>=75?'var(--green)':c.cov>=60?'var(--amber)':'var(--red)'}"></div></div>
              </div>
              <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:${c.cov>=75?'var(--green)':c.cov>=60?'var(--amber)':'var(--red)'}">${c.cov}%</div>
            </div>`).join('')}
        </div>
        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">🎯 Execution Windows</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">AI-detected entry/exit opportunities</div>
          <div class="window-card window-open" style="margin-bottom:8px">
            <div style="font-size:11px;font-weight:800;color:var(--green);margin-bottom:4px">🟢 OPEN — Ethylene EU</div>
            <div style="font-size:12px;color:var(--ink-soft)">Entry: £1,172–£1,178 · Target: +9% coverage · M2M: <strong style="color:var(--green)">+£1.07M</strong></div>
            <button class="btn btn-primary btn-xs" style="margin-top:8px" onclick="showModule('oracle',document.getElementById('nav-oracle'))">Execute →</button>
          </div>
          <div class="window-card window-closed">
            <div style="font-size:11px;font-weight:800;color:var(--red);margin-bottom:4px">🔴 CLOSED — SMP NZ</div>
            <div style="font-size:12px;color:var(--ink-soft)">Window closed 1h ago. Missed: <strong style="color:var(--red)">−£0.18M</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

// ══════════════════════════════════════════════════════════════════════════════
// SCORING PROFILES
// ══════════════════════════════════════════════════════════════════════════════
function renderProfiles() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">Scoring Profiles</div>
        <div class="page-sub">5-dimensional intelligence engine · Behavioral AI · Peer benchmarking</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost">⬇ Export PDF</button>
        <button class="btn btn-primary" onclick="showModule('oracle',document.getElementById('nav-oracle'))">⚡ AI Oracle</button>
      </div>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Portfolio Health Score</div>
        <div class="kpi-val" style="color:var(--green)">84</div>
        <div style="margin-top:8px"><span class="score-grade grade-a">A · Excellent</span></div>
        <div class="kpi-sub">Coverage + Timing + M2M + Diversification</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Hedge Efficiency Score</div>
        <div class="kpi-val" style="color:var(--teal)">79</div>
        <div style="margin-top:8px"><span class="score-grade grade-b">B+ · Strong</span></div>
        <div class="kpi-sub">Instrument + Timing + Volume + Cost</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--blue)">
        <div class="kpi-label">Decision Quality Score</div>
        <div class="kpi-val" style="color:var(--blue)">71</div>
        <div style="margin-top:8px"><span class="score-grade grade-b">B · Good</span></div>
        <div class="kpi-sub">AI-override quality · 12-month rolling</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Behavioral Bias Score</div>
        <div class="kpi-val" style="color:var(--amber)">63</div>
        <div style="margin-top:8px"><span class="score-grade grade-c">C+ · Caution</span></div>
        <div class="kpi-sub">Loss aversion · High anchoring</div>
      </div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Portfolio Health Score — Breakdown</div>
          <div class="card-sub">Composite of 4 weighted dimensions · Updated daily</div>
        </div>
        <div style="padding:20px 22px">
          <div style="display:flex;gap:20px;margin-bottom:22px">
            <div style="position:relative;flex-shrink:0">
              <canvas id="phs-chart" width="130" height="130"></canvas>
              <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none">
                <div style="font-size:26px;font-weight:800;color:var(--ink)">84</div>
                <div style="font-size:9px;color:var(--ink-faint);letter-spacing:.08em">HEALTH</div>
              </div>
            </div>
            <div style="flex:1">
              ${[
                ['Coverage Adequacy','93%',93,'var(--green)'],
                ['Timing Quality','78%',78,'var(--teal)'],
                ['M2M Performance','88%',88,'var(--blue)'],
                ['Diversification','82%',82,'var(--purple)']
              ].map(([l,v,w,c])=>`
                <div class="prog-row" style="margin-bottom:14px">
                  <div class="prog-label">${l}</div>
                  <div class="prog-bar" style="flex:1"><div class="prog-fill" style="width:${w}%;background:${c}"></div></div>
                  <div class="prog-val" style="color:${c}">${v}</div>
                </div>`).join('')}
            </div>
          </div>
          <div class="diff-banner">
            <div class="diff-icon">⭐</div>
            <div>
              <div class="diff-title">Multi-Dimensional Scoring — No Competitor Offers This</div>
              <div class="diff-text">o9, Aera, and Buynomics show single-metric coverage ratios. Nervure scores coverage, timing quality, instrument efficiency, behavioral bias, and peer benchmarking in one composite view.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Behavioral Bias Radar</div>
          <div class="card-sub">Detected psychological patterns in 12-month decision history</div>
        </div>
        <div style="padding:20px 22px">
          <canvas id="bias-radar" width="220" height="220" style="display:block;margin:0 auto"></canvas>
          <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
            ${[
              ['Loss Aversion','HIGH','var(--red)'],
              ['Anchoring','HIGH','var(--red)'],
              ['Recency Bias','MED','var(--amber)'],
              ['Overconfidence','LOW','var(--green)'],
            ].map(([n,l,c])=>`
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:var(--r8)">
                <span style="font-size:12px;color:var(--ink)">${n}</span>
                <span style="font-size:10.5px;font-weight:800;color:${c}">${l}</span>
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Peer Benchmark</div>
          <div class="card-sub">Coverage vs. industry median · AI-recommended target</div>
        </div>
        <div style="padding:20px 22px" id="benchmark-rows"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Decision Quality — Regret Tracker</div>
          <div class="card-sub">AI override decisions and their financial outcomes</div>
        </div>
        <div style="padding:20px 22px" id="regret-rows"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Commodity Criticality Matrix</div>
        <div class="card-sub">Spend × Coverage Gap × Price Volatility scoring</div>
      </div>
      <div style="padding:20px 22px">
        <div style="position:relative;height:180px;width:100%;"><canvas id="crit-chart"></canvas></div>
      </div>
    </div>
  </div>`;
}

function buildProfiles() {
  buildPHSChart();
  buildBiasRadar();
  buildBenchmarkRows();
  buildRegretRows();
  buildCritChart();
}

function buildPHSChart() {
  const ctx = document.getElementById('phs-chart');
  if (!ctx || phsChartBuilt) return;
  phsChartBuilt = true;
  activeCharts.phs = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Coverage','Timing','M2M','Diversification'],
      datasets:[{data:[28,21,22,13],backgroundColor:['#10B981','#0D9488','#3B82F6','#8B5CF6'],borderWidth:0}]
    },
    options:{plugins:{legend:{display:false}},cutout:'68%',responsive:false}
  });
}

function buildBiasRadar() {
  const ctx = document.getElementById('bias-radar');
  if (!ctx || biasRadarBuilt) return;
  biasRadarBuilt = true;
  activeCharts.bias = new Chart(ctx, {
    type:'radar',
    data:{
      labels:['Loss Aversion','Anchoring','Recency Bias','Overconfidence','FOMO','Status Quo'],
      datasets:[
        {label:'You',data:[82,78,54,34,61,67],backgroundColor:'rgba(13,148,136,.15)',borderColor:'var(--teal)',borderWidth:2,pointBackgroundColor:'var(--teal)',pointRadius:3},
        {label:'Peer Avg',data:[55,50,48,58,45,52],backgroundColor:'rgba(139,92,246,.08)',borderColor:'rgba(139,92,246,.4)',borderWidth:1.5,pointRadius:2}
      ]
    },
    options:{
      responsive:false,
      scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(0,0,0,.06)'},pointLabels:{font:{size:10,family:'Arial'}},ticks:{display:false}}},
      plugins:{legend:{position:'top',labels:{font:{size:10},boxWidth:8}}}
    }
  });
}

function buildBenchmarkRows() {
  const el = document.getElementById('benchmark-rows');
  if (!el) return;
  el.innerHTML = PEERS.map(p=>`
    <div class="bench-row">
      <div class="bench-label">${p.comm}</div>
      <div style="flex:1;position:relative">
        <div class="bench-bar-wrap">
          <div class="bench-bar-peer" style="width:${p.peer}%"></div>
          <div class="bench-bar-you" style="width:${p.you}%"></div>
          <div class="bench-marker" style="left:${p.reco}%"></div>
        </div>
      </div>
      <div class="bench-you-val">${p.you}%</div>
      <div class="bench-peer-val">Peer: ${p.peer}%</div>
    </div>`).join('');
}

function buildRegretRows() {
  const el = document.getElementById('regret-rows');
  if (!el) return;
  el.innerHTML = REGRET_DATA.map(r=>`
    <div class="decision-row">
      <div class="decision-icon ${r.won?'decision-win':'decision-loss'}">${r.won?'✓':'✗'}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700">${r.date} · ${r.comm}</div>
        <div style="font-size:11.5px;color:var(--ink-soft);margin-top:2px">${r.action}</div>
        <div style="font-size:11.5px;color:var(--ink-faint);margin-top:2px">${r.outcome}</div>
      </div>
      <div class="regret-amount" style="color:${r.won?'var(--green)':'var(--red)'}">${r.cost}</div>
    </div>`).join('');
}

function buildCritChart() {
  const ctx = document.getElementById('crit-chart');
  if (!ctx || critChartBuilt) return;
  critChartBuilt = true;
  activeCharts.crit = new Chart(ctx,{
    type:'bubble',
    data:{datasets:COMMODITIES.map(c=>({
      label:c.name,
      data:[{x:c.spend,y:c.cov,r:c.priority*1.8}],
      backgroundColor:`${c.signal==='BUY'?'rgba(16,185,129,.7)':c.signal==='HOLD'?'rgba(245,158,11,.7)':'rgba(239,68,68,.7)'}`,
      borderColor:`${c.signal==='BUY'?'var(--green)':c.signal==='HOLD'?'var(--amber)':'var(--red)'}`,
      borderWidth:2
    }))},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
      scales:{
        x:{title:{display:true,text:'Annual Spend (£M)',font:{size:11}},grid:{color:'rgba(0,0,0,.04)'}},
        y:{title:{display:true,text:'Coverage (%)',font:{size:11}},min:0,max:100,grid:{color:'rgba(0,0,0,.04)'}}
      }
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// PRODUCT GENOME
// ══════════════════════════════════════════════════════════════════════════════
function renderGenome() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">🧬 Product Genome</div>
        <div class="page-sub">SKU → Ingredient → Commodity mapping · Exposure by product · Shock simulation</div>
      </div>
    </div>

    <div class="g-main-l">
      <div>
        <div class="card" style="overflow:hidden;margin-bottom:14px">
          <div class="card-header">
            <div class="card-title">SKU Ingredient Tree</div>
            <div class="card-sub">Click products to reveal ingredient exposure</div>
          </div>
          <div style="padding:16px 18px" id="genome-tree"></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px;letter-spacing:-0.02em">Commodity Shock Simulator</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">Select a commodity, drag the shock slider — see real £ and margin-point impact per SKU</div>

          <!-- Commodity selector -->
          <div style="margin-bottom:12px" id="genome-commodity-btns"></div>

          <!-- Commodity context -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 12px;background:var(--teal-glow-s);border:1px solid var(--border);border-radius:var(--r8)">
            <div style="flex:1">
              <div style="font-size:11.5px;color:var(--ink-mid);line-height:1.5" id="shock-comm-desc">Drives petrochemical inputs: packaging, surfactants, rinse aid</div>
            </div>
            <div style="font-family:'JetBrains Mono';font-size:10.5px;color:var(--teal);font-weight:600;white-space:nowrap" id="shock-comm-spend">£28.4M annual spend</div>
          </div>

          <!-- Slider -->
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="font-size:11.5px;color:var(--ink-soft);font-weight:600">Price Shock Intensity</label>
              <span id="shock-val-label" style="font-family:'JetBrains Mono';font-size:18px;font-weight:800;color:var(--teal)">+20%</span>
            </div>
            <input type="range" id="genome-shock" min="-50" max="50" value="20" oninput="updateGenomeShock(this.value)" style="width:100%"/>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--ink-faint);margin-top:5px">
              <span style="color:var(--green);font-weight:600">−50% Price Crash</span>
              <span>Neutral</span>
              <span style="color:var(--red);font-weight:600">+50% Price Spike</span>
            </div>
          </div>

          <!-- Total impact summary -->
          <div style="padding:10px 14px;background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--r8);margin-bottom:14px;font-size:12.5px;color:var(--ink-soft)">
            Total portfolio impact: <span id="shock-total-summary" style="font-weight:700;color:var(--ink)">—</span>
          </div>

          <!-- Impact bars -->
          <div id="genome-impact-bars"></div>

          <!-- Legend -->
          <div style="display:flex;gap:16px;margin-top:12px;font-size:11px;color:var(--ink-faint)">
            <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:var(--red);border-radius:2px;opacity:.7"></div> Cost increases</div>
            <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:var(--green);border-radius:2px;opacity:.7"></div> Cost decreases</div>
            <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:var(--ink-ghost);border-radius:2px;opacity:.5"></div> Not affected</div>
          </div>

          <div class="diff-banner" style="margin-top:14px">
            <div class="diff-icon">🧬</div>
            <div>
              <div class="diff-title">SKU-Level DNA Mapping — Zero Competitors</div>
              <div class="diff-text">No CTRM or supply chain tool connects ingredient-level commodity exposure to product P&L in real time. Nervure translates Ethylene price moves directly into Dettol margin impact.</div>
            </div>
          </div>
        </div>

        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:14px">Portfolio-Level Exposure Summary</div>
          ${COMMODITIES.map(c=>`
            <div class="metric-row">
              <div><div class="metric-name">${c.name}</div><div class="metric-sub">£${c.spend}M annual spend</div></div>
              <span class="badge ${c.signal==='BUY'?'badge-buy':c.signal==='HOLD'?'badge-hold':'badge-sell'}">${c.signal}</span>
              <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:${c.cov>=75?'var(--green)':c.cov>=60?'var(--amber)':'var(--red)'};min-width:36px;text-align:right">${c.cov}%</div>
            </div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

function buildGenomeTree() {
  const el = document.getElementById('genome-tree');
  if (!el) return;
  el.innerHTML = GENOME_PRODUCTS.map((p,pi) => `
    <div class="gene-product" id="gene-prod-${pi}" onclick="toggleGene(${pi})">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14.5px;font-weight:700">${p.name}</div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-top:2px">${p.sku}</div>
        </div>
        <span style="font-size:16px;color:var(--teal);transition:transform 0.3s ease" id="gene-arrow-${pi}">▸</span>
      </div>
      <div class="gene-ingredients" id="gene-ing-${pi}">
        ${p.ingredients.map(ing=>`
          <div class="gene-ing">
            <div style="flex:1">
              <div style="font-size:12.5px;font-weight:600">${ing.name}</div>
              <div style="font-size:11px;color:var(--teal);margin-top:3px">→ ${ing.comm}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:'JetBrains Mono';font-size:15px;font-weight:800;color:var(--teal)">${ing.pct}%</div>
              <span class="badge ${ing.exp==='High'?'badge-red':ing.exp==='Med'?'badge-amber':'badge-teal'}" style="font-size:9px">${ing.exp} Exp.</span>
            </div>
          </div>`).join('')}
      </div>
    </div>`).join('');
}

function toggleGene(idx) {
  const ing = document.getElementById(`gene-ing-${idx}`);
  const arrow = document.getElementById(`gene-arrow-${idx}`);
  const prod = document.getElementById(`gene-prod-${idx}`);
  const open = ing.classList.toggle('open');
  prod.classList.toggle('open', open);
  arrow.style.transform = open ? 'rotate(90deg)' : 'rotate(0deg)';
}

// Genome shock state
let activeShockComm = 'Ethylene';

// Per-commodity exposure profiles: each SKU's COGS weight (%) for that commodity
// and the SKU's annual £M spend (used to calc £ impact)
const GENOME_COMM_PROFILES = {
  'Ethylene': {
    color: '#0D9488',
    totalSpend: 28.4,
    desc: 'Drives petrochemical inputs: packaging, surfactants, rinse aid',
    skus: [
      { name: 'Dettol Liquid',      cogsWeight: 44, annualSpend: 18.2, affected: true  },
      { name: 'Harpic Toilet Bowl', cogsWeight: 28, annualSpend: 11.4, affected: true  },
      { name: 'Finish Dishwash',    cogsWeight: 15, annualSpend: 9.8,  affected: true  },
      { name: 'Enfamil Formula',    cogsWeight: 2,  annualSpend: 14.7, affected: false },
    ]
  },
  'Palm Oil': {
    color: '#F59E0B',
    totalSpend: 41.2,
    desc: 'Core fat source in nutrition and personal care formulations',
    skus: [
      { name: 'Enfamil Formula',    cogsWeight: 18, annualSpend: 14.7, affected: true  },
      { name: 'Dettol Liquid',      cogsWeight: 4,  annualSpend: 18.2, affected: true  },
      { name: 'Harpic Toilet Bowl', cogsWeight: 1,  annualSpend: 11.4, affected: false },
      { name: 'Finish Dishwash',    cogsWeight: 1,  annualSpend: 9.8,  affected: false },
    ]
  },
  'NFDM': {
    color: '#3B82F6',
    totalSpend: 26.0,
    desc: 'Primary protein source — 62% of Enfamil COGS',
    skus: [
      { name: 'Enfamil Formula',    cogsWeight: 62, annualSpend: 14.7, affected: true  },
      { name: 'Dettol Liquid',      cogsWeight: 0,  annualSpend: 18.2, affected: false },
      { name: 'Harpic Toilet Bowl', cogsWeight: 0,  annualSpend: 11.4, affected: false },
      { name: 'Finish Dishwash',    cogsWeight: 0,  annualSpend: 9.8,  affected: false },
    ]
  },
  'Propylene': {
    color: '#8B5CF6',
    totalSpend: 19.6,
    desc: 'Packaging (PP bottles) and surfactant feedstock',
    skus: [
      { name: 'Finish Dishwash',    cogsWeight: 43, annualSpend: 9.8,  affected: true  },
      { name: 'Harpic Toilet Bowl', cogsWeight: 10, annualSpend: 11.4, affected: true  },
      { name: 'Dettol Liquid',      cogsWeight: 12, annualSpend: 18.2, affected: true  },
      { name: 'Enfamil Formula',    cogsWeight: 1,  annualSpend: 14.7, affected: false },
    ]
  }
};

function buildGenomeCommodityBtns() {
  const el = document.getElementById('genome-commodity-btns');
  if (!el) return;
  const comms = Object.keys(GENOME_COMM_PROFILES);
  el.innerHTML = `<div style="display:flex;gap:6px;flex-wrap:wrap">${comms.map((c,i)=>`
    <button class="genome-comm-btn btn ${i===0?'btn-primary':'btn-ghost'} btn-sm"
            data-comm="${c}"
            onclick="selectGenomeComm(this,'${c}')">${c}</button>`).join('')}</div>`;
  activeShockComm = comms[0];
  updateGenomeShock(document.getElementById('genome-shock')?.value ?? 20);
}

function selectGenomeComm(btn, comm) {
  document.querySelectorAll('.genome-comm-btn').forEach(b => {
    b.classList.remove('btn-primary');
    b.classList.add('btn-ghost');
  });
  btn.classList.add('btn-primary');
  btn.classList.remove('btn-ghost');
  activeShockComm = comm;

  // Update the descriptor line
  const desc = document.getElementById('shock-comm-desc');
  if (desc) {
    const profile = GENOME_COMM_PROFILES[comm];
    desc.textContent = profile.desc;
    desc.style.animation = 'none';
    requestAnimationFrame(() => { desc.style.animation = 'fadeUp 0.25s ease both'; });
  }

  // Update total spend chip
  const spendEl = document.getElementById('shock-comm-spend');
  if (spendEl) {
    const profile = GENOME_COMM_PROFILES[comm];
    spendEl.textContent = `£${profile.totalSpend}M annual spend`;
  }

  updateGenomeShock(document.getElementById('genome-shock')?.value ?? 20);
}

function updateGenomeShock(val) {
  const pct = parseInt(val);
  const label = document.getElementById('shock-val-label');
  if (label) {
    label.textContent = `${pct > 0 ? '+' : ''}${pct}%`;
    label.style.color = pct > 0 ? 'var(--red)' : pct < 0 ? 'var(--green)' : 'var(--ink-faint)';
  }

  // Update slider fill colour dynamically
  const slider = document.getElementById('genome-shock');
  if (slider) {
    const ratio = (pct + 50) / 100; // 0..1
    const fillColor = pct > 0 ? '#EF4444' : pct < 0 ? '#10B981' : '#8FADA9';
    slider.style.background = `linear-gradient(to right, ${fillColor} 0%, ${fillColor} ${ratio*100}%, var(--teal-dim) ${ratio*100}%, var(--teal-dim) 100%)`;
  }

  const profile = GENOME_COMM_PROFILES[activeShockComm] || GENOME_COMM_PROFILES['Ethylene'];
  const el = document.getElementById('genome-impact-bars');
  const summaryEl = document.getElementById('shock-total-summary');
  if (!el) return;

  // Compute impacts: margin impact = pct * (cogsWeight/100)
  // £ impact = annualSpend * (cogsWeight/100) * (pct/100)
  const results = profile.skus.map(sku => {
    const marginDelta = pct * (sku.cogsWeight / 100);   // e.g. +20% shock × 44% COGS weight = 8.8pp margin hit
    const gbpImpact   = sku.annualSpend * (sku.cogsWeight / 100) * (pct / 100); // £M
    return { ...sku, marginDelta, gbpImpact };
  });

  // Total £ impact
  const totalGbp = results.reduce((a, r) => a + r.gbpImpact, 0);
  if (summaryEl) {
    if (pct === 0) {
      summaryEl.textContent = '—';
    } else {
      const impactColor = totalGbp > 0 ? 'var(--red)' : 'var(--green)';
      const impactSign  = totalGbp > 0 ? '−' : '+';
      summaryEl.innerHTML = `<span style="color:${impactColor};font-weight:800;font-family:'JetBrains Mono'">${impactSign}£${Math.abs(totalGbp).toFixed(2)}M</span> <span style="color:var(--ink-soft)">P&amp;L impact from COGS across portfolio</span>`;
    }
  }

  const maxMargin = Math.max(...results.map(r => Math.abs(r.marginDelta)), 0.01);

  el.innerHTML = results.map(r => {
    if (pct === 0) {
      return `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s);opacity:0.5">
          <div style="min-width:138px">
            <div style="font-size:12.5px;font-weight:600;color:var(--ink-soft)">${r.name}</div>
            <div style="font-size:10.5px;color:var(--ink-faint);margin-top:1px">${r.cogsWeight}% of COGS</div>
          </div>
          <div style="flex:1;height:22px;background:var(--surface-alt);border-radius:6px;overflow:hidden">
            <div style="height:100%;width:0%;border-radius:6px;transition:width .5s ease"></div>
          </div>
          <div style="font-family:'JetBrains Mono';font-size:12px;color:var(--ink-faint);min-width:100px;text-align:right">–</div>
        </div>`;
    }

    const barW = Math.round((Math.abs(r.marginDelta) / maxMargin) * 100);
    const color   = r.marginDelta > 0 ? 'var(--red)'   : 'var(--green)';
    const hexEdge = r.marginDelta > 0 ? '#EF4444'      : '#10B981';
    const bgColor = r.marginDelta > 0 ? 'rgba(239,68,68,.06)' : 'rgba(16,185,129,.05)';
    const sign    = r.marginDelta > 0 ? '+' : '';
    const gbpSign = r.gbpImpact  > 0 ? '−' : '+';
    const affectedStyle = r.affected
      ? `border-left:3px solid ${hexEdge};padding-left:10px;background:${bgColor};border-radius:0 6px 6px 0;margin-left:-3px;`
      : 'opacity:0.32;';

    return `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s);${affectedStyle}transition:all .3s ease">
        <div style="min-width:138px">
          <div style="font-size:12.5px;font-weight:${r.affected ? '700' : '500'};color:${r.affected ? 'var(--ink)' : 'var(--ink-soft)'}">${r.name}</div>
          <div style="font-size:10.5px;color:var(--ink-faint);margin-top:1px">${r.cogsWeight}% of COGS exposed</div>
        </div>
        <div style="flex:1;height:22px;background:var(--surface-alt);border-radius:6px;overflow:hidden">
          <div style="height:100%;width:${barW}%;background:${color};border-radius:6px;transition:width .5s cubic-bezier(.4,0,.2,1);opacity:${r.affected ? 0.85 : 0.2}"></div>
        </div>
        <div style="text-align:right;min-width:110px">
          <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:800;color:${r.affected ? color : 'var(--ink-faint)'}">${sign}${r.marginDelta.toFixed(1)}pp</div>
          <div style="font-size:10.5px;color:${r.affected ? color : 'var(--ink-faint)'};">${gbpSign}£${Math.abs(r.gbpImpact).toFixed(2)}M</div>
        </div>
      </div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════════════════════════
// SCENARIOS
// ══════════════════════════════════════════════════════════════════════════════
function renderScenarios() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">◈ Scenario Engine</div>
        <div class="page-sub">Generative AI stress-testing · Tail risk · Carbon CBAM overlay · Pre-emptive positioning</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost">⬇ Export Report</button>
        <button class="btn btn-primary" onclick="initScenario()">↺ Regenerate</button>
      </div>
    </div>

    <div class="g-main-l">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card" style="padding:18px">
          <div style="font-size:13.5px;font-weight:700;margin-bottom:12px">Shock Type</div>
          <div id="scenario-selector"></div>
        </div>
        <div class="card" style="padding:18px">
          <div style="font-size:13.5px;font-weight:700;margin-bottom:14px">Shock Intensity</div>
          <input type="range" id="scenario-intensity" min="10" max="100" value="55" oninput="updateScenario(this.value)"/>
          <div style="display:flex;justify-content:space-between;font-size:10.5px;color:var(--ink-faint);margin-top:8px">
            <span>Mild</span>
            <span id="intensity-label" style="font-family:'JetBrains Mono';font-weight:800;color:var(--teal)">55%</span>
            <span>Severe</span>
          </div>
        </div>
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-size:13.5px;font-weight:700">🌿 Carbon CBAM Overlay</div>
            <span class="badge badge-purple">EU 2026</span>
          </div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:12px;line-height:1.55">EU Carbon Border Adjustment Mechanism overlaid on all commodity imports.</div>
          <div id="carbon-rows"></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="g2">
          <div class="kpi" style="--kpi-accent:var(--red)">
            <div class="kpi-label">Portfolio P&L Impact</div>
            <div class="kpi-val" style="color:var(--red)" id="scenario-pnl">−£11.6M</div>
            <div class="kpi-sub">If fully unhedged</div>
          </div>
          <div class="kpi" style="--kpi-accent:var(--green)">
            <div class="kpi-label">Hedged Savings</div>
            <div class="kpi-val" style="color:var(--green)" id="scenario-savings">+£7.7M</div>
            <div class="kpi-sub">At current coverage</div>
          </div>
          <div class="kpi" style="--kpi-accent:var(--teal)">
            <div class="kpi-label">Recommended Δ Coverage</div>
            <div class="kpi-val" style="color:var(--teal)" id="scenario-delta">+11%</div>
            <div class="kpi-sub">AI pre-positioning</div>
          </div>
          <div class="kpi" style="--kpi-accent:var(--purple)">
            <div class="kpi-label">Scenario Probability</div>
            <div class="kpi-val" id="scenario-prob">21%</div>
            <div class="kpi-sub">12-month horizon</div>
          </div>
        </div>

        <div class="card" style="padding:22px">
          <div style="font-size:16px;font-weight:700;margin-bottom:4px;letter-spacing:-0.02em">Commodity Impact Waterfall</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">P&L impact by commodity — hedged vs unhedged</div>
          <div style="position:relative;height:200px;width:100%">
            <canvas id="scenario-chart"></canvas>
          </div>
        </div>

        <div class="card" style="padding:20px;background:linear-gradient(135deg,var(--teal-glow),var(--surface));border-color:var(--border-m)">
          <div style="font-size:14px;font-weight:700;color:var(--teal);margin-bottom:8px">🤖 AI Scenario Narrative</div>
          <div id="scenario-narrative" style="font-size:12.5px;color:var(--ink-mid);line-height:1.7"></div>
          <div class="diff-banner" style="margin-top:12px">
            <div class="diff-icon">🌍</div>
            <div>
              <div class="diff-title">Generative Scenarios — Beyond Historical Backtesting</div>
              <div class="diff-text">Legacy tools backtest what happened. Nervure generates novel shock scenarios using LLM reasoning — geopolitical cascades, correlated climate failures, supply concentration domino effects.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function initScenario() {
  buildScenarioSelector();
  buildCarbonRows();
  updateScenario(55);
}

function buildScenarioSelector() {
  const el = document.getElementById('scenario-selector');
  if (!el) return;
  el.innerHTML = SCENARIOS.map((s,i)=>`
    <div class="scenario-opt${i===0?' selected':''}" onclick="selectScenario(this,${i})">
      <div style="font-size:13.5px;font-weight:700;margin-bottom:2px">${s.label}</div>
      <div style="font-size:11.5px;color:var(--ink-soft)">${s.desc}</div>
    </div>`).join('');
}

function selectScenario(el, idx) {
  selectedScenarioIdx = idx;
  document.querySelectorAll('.scenario-opt').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  updateScenario(document.getElementById('scenario-intensity').value);
}

function updateScenario(val) {
  const pct = parseInt(val);
  document.getElementById('intensity-label').textContent = `${pct}%`;
  document.getElementById('scenario-pnl').textContent = `−£${(pct*0.21).toFixed(1)}M`;
  document.getElementById('scenario-savings').textContent = `+£${(pct*0.14).toFixed(1)}M`;
  document.getElementById('scenario-delta').textContent = `+${Math.floor(pct*0.2)}%`;
  document.getElementById('scenario-prob').textContent = `${Math.floor(pct*0.38)}%`;
  buildScenarioChart(pct);
  const n = document.getElementById('scenario-narrative');
  if (n) n.textContent = `Under a ${pct}% intensity ${SCENARIOS[selectedScenarioIdx]?.label||'geopolitical'} scenario, exposure increases significantly. Ethylene spot premium surges +${(pct*0.18).toFixed(0)}%, palm oil supply contracts by ${(pct*0.14).toFixed(0)}%. Your hedge book protects £${(pct*0.14).toFixed(1)}M of the £${(pct*0.21).toFixed(1)}M unhedged exposure. AI recommends pre-positioning +${Math.floor(pct*0.2)}% additional coverage on Ethylene and Palm Oil.`;
}

function buildScenarioChart(pct) {
  const ctx = document.getElementById('scenario-chart');
  if (!ctx) return;
  if (scenarioChart) { scenarioChart.destroy(); scenarioChart = null; }
  const labels = ['Ethylene','Palm Oil','SMP NZ','WMP EU','NFDM','Propylene'];
  const unhedged = [pct*0.092,pct*0.31,-pct*0.04,pct*0.22,pct*0.024,-pct*0.06].map(v=>+v.toFixed(1));
  const hedged = unhedged.map(v=>+(v*0.35).toFixed(1));
  scenarioChart = new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Unhedged Loss',data:unhedged,backgroundColor:'rgba(239,68,68,.65)',borderRadius:5},
      {label:'After Hedge',data:hedged,backgroundColor:'rgba(13,148,136,.7)',borderRadius:5}
    ]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
      scales:{
        x:{grid:{display:false},ticks:{font:{size:11}}},
        y:{title:{display:true,text:'£M P&L Impact',font:{size:11}},grid:{color:'rgba(0,0,0,.04)'}}
      }
    }
  });
}

function buildCarbonRows() {
  const el = document.getElementById('carbon-rows');
  if (!el) return;
  const data = [
    {comm:'Ethylene',import:'Non-EU',carbon:'€28/ton',impact:'HIGH',adj:'+2.4%'},
    {comm:'Palm Oil',import:'MY/ID',carbon:'€14/ton',impact:'MED',adj:'+0.8%'},
    {comm:'NFDM',import:'US',carbon:'€6/ton',impact:'LOW',adj:'+0.3%'},
  ];
  el.innerHTML = data.map(d=>`
    <div class="carbon-chip">
      <div>
        <div style="font-size:12.5px;font-weight:700">${d.comm}</div>
        <div style="font-size:10.5px;color:var(--ink-soft)">${d.import} imports</div>
      </div>
      <div style="text-align:right">
        <div class="carbon-val" style="color:var(--purple)">${d.carbon}</div>
        <div class="carbon-impact" style="background:${d.impact==='HIGH'?'var(--red-bg)':d.impact==='MED'?'var(--amber-bg)':'var(--green-bg)'};color:${d.impact==='HIGH'?'var(--red)':d.impact==='MED'?'var(--amber)':'var(--green)'}">
          ${d.adj} cost adj.
        </div>
      </div>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════════════════════════
// SIGNAL LAB
// ══════════════════════════════════════════════════════════════════════════════
function renderSignals() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">🛰 Signal Lab</div>
        <div class="page-sub">50+ alternative data streams · Real-time triggers · Counterparty risk · Policy enforcement</div>
      </div>
      <div class="live-pill"><div class="live-dot"></div><span class="live-txt">50 signals live</span></div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card" style="overflow:hidden">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="card-title">Live Alternative Data Signals</div>
            <div class="card-sub">Satellite · AIS · Weather · Sentiment · Central Banks</div>
          </div>
          <div class="live-pill"><div class="live-dot"></div><span class="live-txt">Live</span></div>
        </div>
        <div id="full-signal-feed"></div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">Data Source Coverage</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">50+ streams across 8 categories</div>
          <div style="position:relative;height:160px;width:160px;margin:0 auto;"><canvas id="signal-donut"></canvas></div>
          <div id="signal-legend" style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:6px"></div>
        </div>

        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">Counterparty Risk Monitor</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">EMIR / Dodd-Frank · Auto-tested daily</div>
          <div id="counterparty-rows"></div>
        </div>
      </div>
    </div>

    <div class="card" style="padding:24px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
        <div>
          <div style="font-size:18px;font-weight:700">Natural Language Policy Enforcer</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-top:3px">Enter hedging rules in plain English — AI enforces them as hard constraints on every recommendation</div>
        </div>
        <span class="badge badge-purple">CFO-Ready</span>
      </div>
      <div id="policy-rules"></div>
      <div style="margin-top:14px;display:flex;gap:10px">
        <input type="text" id="policy-input" placeholder='e.g. "Never exceed 90% coverage on any single commodity"' style="flex:1"/>
        <button class="btn btn-primary" onclick="addPolicy()">Add Rule</button>
      </div>
      <div class="diff-banner" style="margin-top:14px">
        <div class="diff-icon">📜</div>
        <div>
          <div class="diff-title">Zero Competitors — NL Policy Enforcement</div>
          <div class="diff-text">Every other tool requires a technical consultant to encode hedging rules. Nervure lets your CFO type rules in plain English and enforces them automatically.</div>
        </div>
      </div>
    </div>
  </div>`;
}

function buildSignals() {
  buildSignalFeed('full-signal-feed');
  buildSignalDonut();
  buildCounterpartyRows();
  buildPolicies();
}

function buildSignalDonut() {
  const ctx = document.getElementById('signal-donut');
  if (!ctx || signalDonutBuilt) return;
  signalDonutBuilt = true;
  activeCharts.donut = new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Satellite','AIS Shipping','Weather','Macro/CB','Sentiment','Proxy Hedge','Supply Chain','Carbon/ESG'],
      datasets:[{data:[8,7,9,6,7,5,8,6],backgroundColor:['#0D9488','#14B8A6','#5EEAD4','#A7F3D0','#FCD34D','#8B5CF6','#3B82F6','#10B981'],borderWidth:0}]
    },
    options:{plugins:{legend:{display:false}},cutout:'55%',responsive:false,maintainAspectRatio:false}
  });
  const cats = [['Satellite','#0D9488'],['AIS Shipping','#14B8A6'],['Weather','#5EEAD4'],['Macro/CB','#A7F3D0'],['Sentiment','#FCD34D'],['Proxy Hedge','#8B5CF6'],['Supply Chain','#3B82F6'],['Carbon/ESG','#10B981']];
  document.getElementById('signal-legend').innerHTML = cats.map(([l,c])=>`
    <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--ink-soft)">
      <div style="width:8px;height:8px;border-radius:50%;background:${c};flex-shrink:0"></div>${l}
    </div>`).join('');
}

function buildCounterpartyRows() {
  const el = document.getElementById('counterparty-rows');
  if (!el) return;
  el.innerHTML = COUNTERPARTIES.map(cp=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-s)">
      <div>
        <div style="font-size:13px;font-weight:700">${cp.name}</div>
        <div style="font-size:11px;color:var(--ink-soft)">${cp.exposure} exposure · ${cp.rating}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:'JetBrains Mono';font-size:12px;color:${cp.risk==='Low'?'var(--green)':'var(--amber)'}">CDS: ${cp.cds}bps</div>
        <span class="badge ${cp.risk==='Low'?'badge-buy':'badge-hold'}" style="font-size:9px">${cp.risk} Risk</span>
      </div>
    </div>`).join('');
}

function buildPolicies() {
  const el = document.getElementById('policy-rules');
  if (!el) return;
  renderPolicies();
}

function renderPolicies() {
  const el = document.getElementById('policy-rules');
  if (!el) return;
  el.innerHTML = POLICIES.map((p,i)=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 14px;background:${p.active?'var(--teal-glow)':'rgba(0,0,0,.02)'};border:1px solid ${p.active?'rgba(13,148,136,.2)':'var(--border)'};border-radius:var(--r10);margin-bottom:8px;transition:var(--transition)"
         onmouseenter="this.style.borderColor='var(--border-m)'" onmouseleave="this.style.borderColor='${p.active?'rgba(13,148,136,.2)':'var(--border)'}'">
      <span style="font-size:14px">${p.active?'✅':'⬜'}</span>
      <div style="flex:1;font-size:12.5px;color:var(--ink-mid);line-height:1.55">${p.text}</div>
      <div style="display:flex;gap:5px;flex-shrink:0">
        <span class="badge badge-teal" style="font-size:9px">Active</span>
        <button class="btn btn-ghost btn-xs" onclick="removePolicy(${i})">Remove</button>
      </div>
    </div>`).join('');
}

function addPolicy() {
  const input = document.getElementById('policy-input');
  if (!input.value.trim()) return;
  POLICIES.push({text:input.value.trim(),active:true});
  input.value = '';
  renderPolicies();
}

function removePolicy(i) {
  POLICIES.splice(i,1);
  renderPolicies();
}

// ══════════════════════════════════════════════════════════════════════════════
// REVENUE ENGINE
// ══════════════════════════════════════════════════════════════════════════════
function renderRevenue() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">💰 Revenue Engine</div>
        <div class="page-sub">Dynamic pricing · Elasticity modeling · Promotion ROI · Price waterfall analysis</div>
      </div>
      <button class="btn btn-primary">⬇ Export Pricing Model</button>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Revenue Uplift (AI)</div>
        <div class="kpi-val">+£4.2M</div>
        <div class="kpi-delta up">↑ +12% vs baseline</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Gross Margin</div>
        <div class="kpi-val">34.7%</div>
        <div class="kpi-delta up">↑ +1.2pp YoY</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Price Elasticity</div>
        <div class="kpi-val">-1.34</div>
        <div class="kpi-delta neutral">Avg across portfolio</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--purple)">
        <div class="kpi-label">Promo Spend ROI</div>
        <div class="kpi-val">2.8×</div>
        <div class="kpi-delta up">↑ +0.4× vs last quarter</div>
      </div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="card-title">Dynamic Pricing Recommendations</div>
            <div class="card-sub">AI-optimized price points by SKU segment</div>
          </div>
          <span class="badge badge-teal">Live Model</span>
        </div>
        <div style="padding:16px 20px" id="revenue-pricing-rows"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Price Waterfall Analysis</div>
          <div class="card-sub">From list price to net realized revenue</div>
        </div>
        <div style="padding:16px 20px" id="revenue-waterfall"></div>
      </div>
    </div>

    <div class="g2">
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Elasticity Matrix</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Cross-category price sensitivity</div>
        <div style="position:relative;height:200px;width:100%;"><canvas id="elasticity-chart"></canvas></div>
      </div>
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Promotion ROI Tracker</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Live promotion performance vs forecast</div>
        <div style="position:relative;height:200px;width:100%;"><canvas id="promo-chart"></canvas></div>
      </div>
    </div>
  </div>`;
}

function buildRevenue() {
  // Pricing rows
  const pricingEl = document.getElementById('revenue-pricing-rows');
  if (pricingEl) {
    const items = [
      {sku:'Dettol 750ml',current:'£3.49',ai:'£3.79',uplift:'+£0.8M',conf:88,action:'Increase'},
      {sku:'Harpic Classic',current:'£2.29',ai:'£2.49',uplift:'+£0.5M',conf:82,action:'Increase'},
      {sku:'Enfamil 600g',current:'£22.99',ai:'£21.49',uplift:'+£1.1M',conf:74,action:'Reduce'},
      {sku:'Finish Tabs 80pk',current:'£8.99',ai:'£9.49',uplift:'+£0.6M',conf:79,action:'Increase'},
    ];
    pricingEl.innerHTML = items.map(it=>`
      <div class="metric-row">
        <div style="flex:1">
          <div class="metric-name">${it.sku}</div>
          <div class="metric-sub">Current: ${it.current} → AI: <strong style="color:var(--teal)">${it.ai}</strong></div>
        </div>
        <div style="text-align:right;margin-right:10px">
          <div style="font-family:'JetBrains Mono';font-size:12.5px;font-weight:700;color:var(--green)">${it.uplift}</div>
          <div style="font-size:10.5px;color:var(--ink-faint)">${it.conf}% confidence</div>
        </div>
        <button class="btn btn-primary btn-xs" onclick="applyPricingOSAction('${it.sku}','${it.ai}','${it.action}')">${it.action} →</button>
      </div>`).join('');
  }

  // Waterfall
  const wfEl = document.getElementById('revenue-waterfall');
  if (wfEl) {
    const steps = [
      {label:'List Price',val:100,color:'var(--teal)'},
      {label:'Trade Discounts',val:-14,color:'var(--red)'},
      {label:'Promotional Spend',val:-8,color:'var(--red)'},
      {label:'Logistics',val:-6,color:'var(--amber)'},
      {label:'Net Revenue',val:72,color:'var(--green)'},
    ];
    wfEl.innerHTML = steps.map(s=>`
      <div class="prog-row" style="margin-bottom:12px">
        <div class="prog-label">${s.label}</div>
        <div class="prog-bar" style="flex:1"><div class="prog-fill" style="width:${Math.abs(s.val)}%;background:${s.color}"></div></div>
        <div class="prog-val" style="color:${s.color}">${s.val>0?'':''} ${Math.abs(s.val)}%</div>
      </div>`).join('');
  }

  // Elasticity chart
  const eCtx = document.getElementById('elasticity-chart');
  if (eCtx) {
    activeCharts.elasticity = new Chart(eCtx,{
      type:'bar',
      data:{
        labels:['Dettol','Harpic','Enfamil','Finish','Strepsils','Gaviscon'],
        datasets:[{label:'Price Elasticity',data:[-0.9,-1.2,-2.1,-1.4,-0.7,-0.5],backgroundColor:'rgba(13,148,136,.65)',borderRadius:5}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,indexAxis:'y',
        plugins:{legend:{display:false}},
        scales:{x:{title:{display:true,text:'Elasticity Coefficient'},grid:{color:'rgba(0,0,0,.04)'}},y:{grid:{display:false}}}
      }
    });
  }

  // Promo chart
  const pCtx = document.getElementById('promo-chart');
  if (pCtx) {
    activeCharts.promo = new Chart(pCtx,{
      type:'line',
      data:{
        labels:['Week 1','Week 2','Week 3','Week 4','Week 5','Week 6','Week 7','Week 8'],
        datasets:[
          {label:'Forecast ROI',data:[2.4,2.5,2.6,2.5,2.7,2.8,2.7,2.8],borderColor:'rgba(13,148,136,.4)',borderDash:[5,4],borderWidth:2,pointRadius:0},
          {label:'Actual ROI',data:[2.3,2.6,2.4,2.7,2.8,3.0,2.9,2.8],borderColor:'var(--teal)',backgroundColor:'rgba(13,148,136,.08)',fill:true,borderWidth:2,pointRadius:3,tension:0.4}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
        scales:{y:{min:2.0,title:{display:true,text:'ROI Multiple'},grid:{color:'rgba(0,0,0,.04)'}},x:{grid:{display:false}}}
      }
    });
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// DEMAND FORECAST
// ══════════════════════════════════════════════════════════════════════════════
function renderDemand() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">📊 Demand Forecast</div>
        <div class="page-sub">13-week ML forecasting · Scenario planning · Bias correction · Consensus process</div>
      </div>
      <button class="btn btn-primary">⬇ Export Forecast</button>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Forecast Accuracy</div>
        <div class="kpi-val">94.2%</div>
        <div class="kpi-delta up">↑ +2.1pp vs pure ML baseline</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">SKUs Covered</div>
        <div class="kpi-val">2,847</div>
        <div class="kpi-delta neutral">Active product portfolio</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Bias (MAPE)</div>
        <div class="kpi-val">5.8%</div>
        <div class="kpi-delta up">↓ −1.4% corrected</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--blue)">
        <div class="kpi-label">Forecast Horizon</div>
        <div class="kpi-val">13 wks</div>
        <div class="kpi-delta neutral">Rolling weekly updates</div>
      </div>
    </div>

    <div class="g-main" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="card-title">13-Week Demand Forecast</div>
            <div class="card-sub">Actuals vs ML forecast vs consensus</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm">All SKUs</button>
            <button class="btn btn-ghost btn-sm">Category</button>
          </div>
        </div>
        <div style="padding:20px">
          <div style="position:relative;height:220px;width:100%;"><canvas id="demand-chart"></canvas></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:14px">Category Performance</div>
          ${[['Personal Care',94.8,'+1.2k units',true],['Healthcare',91.3,'-0.8k units',false],['Hygiene',96.1,'+2.4k units',true],['Nutrition',89.4,'-1.1k units',false]].map(([cat,acc,delta,up])=>`
            <div class="metric-row">
              <div style="flex:1"><div class="metric-name">${cat}</div></div>
              <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:var(--teal)">${acc}%</div>
              <span style="font-size:12px;font-weight:700;color:${up?'var(--green)':'var(--red)'};min-width:72px;text-align:right">${delta}</span>
            </div>`).join('')}
        </div>
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:14px">Bias Correction Log</div>
          ${[['Dettol 750ml','Overforecast','−8.2%','Corrected'],['Harpic Classic','Underforecast','+5.1%','Corrected'],['Enfamil 600g','Seasonality miss','−12.3%','Pending']].map(([sku,type,val,st])=>`
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-s)">
              <div style="flex:1">
                <div style="font-size:12.5px;font-weight:600">${sku}</div>
                <div style="font-size:11px;color:var(--ink-soft)">${type}</div>
              </div>
              <span style="font-family:'JetBrains Mono';font-size:12px;color:var(--red)">${val}</span>
              <span class="badge ${st==='Corrected'?'badge-buy':'badge-amber'}" style="font-size:9px">${st}</span>
            </div>`).join('')}
        </div>
      </div>
    </div>

    <div class="card" style="padding:22px">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px">Demand Signal Intelligence</div>
      <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">External data drivers correlated with demand</div>
      <div class="g4">
        ${[
          ['Weather Impact','Signal Strength: 0.71','Winter spike predicted +18%','🌦'],
          ['Google Trends','Signal Strength: 0.63','Hygiene category up 12% WoW','📈'],
          ['News Sentiment','Signal Strength: 0.48','Positive coverage → +6% demand','📰'],
          ['Social Media','Signal Strength: 0.55','Viral mentions → short-term spikes','📱'],
        ].map(([t,c,d,i])=>`
          <div class="card" style="padding:14px 16px;border-color:var(--border-s)">
            <div style="font-size:22px;margin-bottom:8px">${i}</div>
            <div style="font-size:13px;font-weight:700;margin-bottom:2px">${t}</div>
            <div style="font-size:11px;color:var(--teal);margin-bottom:4px">${c}</div>
            <div style="font-size:11.5px;color:var(--ink-soft)">${d}</div>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function buildDemand() {
  const ctx = document.getElementById('demand-chart');
  if (!ctx) return;
  const weeks = ['W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','W13'];
  const actuals = [1820,1850,1790,1900,1880,1930,null,null,null,null,null,null,null];
  const forecast = [1810,1860,1800,1910,1870,1920,1950,1960,1980,1970,2010,2020,2000];
  const consensus = [null,null,null,null,null,null,1940,1970,1985,1975,2000,2015,2005];

  activeCharts.demand = new Chart(ctx,{
    type:'line',
    data:{labels:weeks,datasets:[
      {label:'Actuals',data:actuals,borderColor:'var(--ink)',backgroundColor:'rgba(10,26,24,.08)',fill:false,borderWidth:2.5,pointRadius:4,tension:0.3},
      {label:'ML Forecast',data:forecast,borderColor:'var(--teal)',backgroundColor:'rgba(13,148,136,.08)',fill:true,borderWidth:2,borderDash:[5,4],pointRadius:2,tension:0.4},
      {label:'Consensus',data:consensus,borderColor:'var(--gold)',backgroundColor:'transparent',borderWidth:2,pointRadius:3,tension:0.3}
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
      scales:{
        y:{title:{display:true,text:'Units (thousands)'},grid:{color:'rgba(0,0,0,.04)'}},
        x:{grid:{display:false}}
      }
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════════
// PROFITABILITY
// ══════════════════════════════════════════════════════════════════════════════
function renderProfitability() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">💡 Profitability Analytics</div>
        <div class="page-sub">SKU-level margin analysis · Commodity cost passthrough · Product portfolio optimization</div>
      </div>
      <button class="btn btn-primary">⬇ Export Margin Report</button>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Portfolio Gross Margin</div>
        <div class="kpi-val">34.7%</div>
        <div class="kpi-delta up">↑ +1.2pp vs Q4</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">EBITDA</div>
        <div class="kpi-val">£28.4M</div>
        <div class="kpi-delta up">↑ +8.3% YoY</div>
        <div class="kpi-sub">19.7% EBITDA margin</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Commodity COGS %</div>
        <div class="kpi-val">38.2%</div>
        <div class="kpi-delta down">↑ +2.1pp risk</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--red)">
        <div class="kpi-label">Margin-at-Risk SKUs</div>
        <div class="kpi-val">127</div>
        <div class="kpi-delta down">Requires repricing</div>
      </div>
    </div>

    <div class="g-main" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header" style="display:flex;justify-content:space-between">
          <div>
            <div class="card-title">SKU Margin Waterfall</div>
            <div class="card-sub">Top 10 SKUs by margin contribution</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm">Sort by Margin</button>
            <button class="btn btn-ghost btn-sm">Sort by Risk</button>
          </div>
        </div>
        <div class="tbl-head" style="grid-template-columns:1fr 70px 70px 80px 80px 70px">
          <span>SKU</span><span>Revenue</span><span>COGS</span><span>Gross Margin</span><span>Comm. Risk</span><span>Action</span>
        </div>
        <div id="profitability-table"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:14px">Commodity Cost Passthrough</div>
          <div style="position:relative;height:180px;width:100%;"><canvas id="passthrough-chart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="g2">
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Portfolio Optimization Engine</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">AI recommendations for margin improvement</div>
        ${[
          ['Discontinue Enfamil 400g','Low margin + high commodity risk → discontinue','HIGH','-£2.1M cost avoidance'],
          ['Reprice Dettol 750ml','Elasticity supports +8.6% price → margin +1.2pp','MED','+£0.8M uplift'],
          ['Reformulate Harpic Pro','Reduce Ethylene content by 12% → same efficacy','LOW','+£0.4M COGS saving'],
        ].map(([t,d,p,i])=>`
          <div style="padding:12px 14px;border:1px solid var(--border);border-radius:var(--r10);margin-bottom:8px;transition:var(--transition)"
               onmouseenter="this.style.borderColor='var(--border-m)'" onmouseleave="this.style.borderColor='var(--border)'">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px">
              <div style="font-size:13px;font-weight:700">${t}</div>
              <span class="badge ${p==='HIGH'?'badge-red':p==='MED'?'badge-amber':'badge-teal'}" style="font-size:9px">${p}</span>
            </div>
            <div style="font-size:12px;color:var(--ink-soft);margin-bottom:6px">${d}</div>
            <div style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:var(--green)">${i}</div>
          </div>`).join('')}
      </div>
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Margin Bridge Analysis</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Q4 2025 → Q1 2026 margin drivers</div>
        <div style="position:relative;height:220px;width:100%;"><canvas id="margin-bridge"></canvas></div>
      </div>
    </div>
  </div>`;
}

function buildProfitability() {
  const tblEl = document.getElementById('profitability-table');
  if (tblEl) {
    const skus = [
      {n:'Dettol Liquid 750ml',rev:'£18.2M',cogs:'£10.8M',gm:'40.7%',risk:'Med',gmv:40.7},
      {n:'Enfamil Formula 600g',rev:'£14.7M',cogs:'£10.1M',gm:'31.3%',risk:'High',gmv:31.3},
      {n:'Harpic Classic 750ml',rev:'£11.4M',cogs:'£6.3M',gm:'44.7%',risk:'Low',gmv:44.7},
      {n:'Finish Tabs 80pk',rev:'£9.8M',cogs:'£5.8M',gm:'40.8%',risk:'Med',gmv:40.8},
    ];
    tblEl.innerHTML = skus.map(s=>`
      <div class="tbl-row" style="grid-template-columns:1fr 70px 70px 80px 80px 70px">
        <div style="font-size:13px;font-weight:600">${s.n}</div>
        <div style="font-family:'JetBrains Mono';font-size:12.5px">${s.rev}</div>
        <div style="font-family:'JetBrains Mono';font-size:12.5px">${s.cogs}</div>
        <div>
          <span style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:${s.gmv>=40?'var(--green)':s.gmv>=35?'var(--amber)':'var(--red)'}">${s.gm}</span>
        </div>
        <span class="badge ${s.risk==='High'?'badge-red':s.risk==='Med'?'badge-amber':'badge-buy'}" style="font-size:9px">${s.risk}</span>
        <button class="btn btn-ghost btn-xs" onclick="showModule('oracle',document.getElementById('nav-oracle'))">Optimize</button>
      </div>`).join('');
  }

  const ptCtx = document.getElementById('passthrough-chart');
  if (ptCtx) {
    activeCharts.passthrough = new Chart(ptCtx,{
      type:'line',
      data:{
        labels:['Jan','Feb','Mar','Apr','May','Jun'],
        datasets:[
          {label:'Commodity Cost',data:[38,39,41,43,42,40],borderColor:'var(--red)',backgroundColor:'rgba(239,68,68,.08)',fill:true,borderWidth:2,tension:0.4},
          {label:'Price Realization',data:[34,35,36,37,36,35],borderColor:'var(--teal)',backgroundColor:'rgba(13,148,136,.08)',fill:true,borderWidth:2,tension:0.4}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
        scales:{y:{title:{display:true,text:'% of Revenue'},grid:{color:'rgba(0,0,0,.04)'}},x:{grid:{display:false}}}
      }
    });
  }

  const mbCtx = document.getElementById('margin-bridge');
  if (mbCtx) {
    activeCharts.bridge = new Chart(mbCtx,{
      type:'bar',
      data:{
        labels:['Q4 GM','Volume','Price','Mix','Commodity','SG&A','Q1 GM'],
        datasets:[{
          data:[32.4,1.8,2.3,-0.4,-2.1,0.7,34.7],
          backgroundColor:['rgba(13,148,136,.7)','rgba(16,185,129,.7)','rgba(16,185,129,.7)','rgba(239,68,68,.7)','rgba(239,68,68,.7)','rgba(16,185,129,.7)','rgba(13,148,136,.9)'],
          borderRadius:5
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:false,min:28,title:{display:true,text:'Gross Margin %'},grid:{color:'rgba(0,0,0,.04)'}},x:{grid:{display:false}}}
      }
    });
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// SUPPLY CHAIN
// ══════════════════════════════════════════════════════════════════════════════
function renderSupply() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">🚛 Supply Chain Command</div>
        <div class="page-sub">Fleet optimization · Route intelligence · Inventory management · Supplier risk</div>
      </div>
      <button class="btn btn-primary">⬇ Export Operations Report</button>
    </div>

    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Fleet Utilization</div>
        <div class="kpi-val">87.3%</div>
        <div class="kpi-delta up">↑ +4.1% vs last month</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Fuel Savings (Mo)</div>
        <div class="kpi-val">£320K</div>
        <div class="kpi-delta up">2,450 km/day saved</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Supplier Risk Score</div>
        <div class="kpi-val">72/100</div>
        <div class="kpi-delta down">4 suppliers at-risk</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--blue)">
        <div class="kpi-label">Inventory Turns</div>
        <div class="kpi-val">8.4×</div>
        <div class="kpi-delta up">↑ +1.2× vs industry</div>
      </div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Supply Network Health</div>
          <div class="card-sub">Tier 1 and 2 supplier risk monitoring</div>
        </div>
        <div style="padding:16px 20px" id="supply-nodes"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Inventory Optimization</div>
          <div class="card-sub">AI-recommended safety stock levels</div>
        </div>
        <div style="padding:16px 20px">
          <div style="position:relative;height:200px;width:100%;"><canvas id="inventory-chart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="g2">
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Route Optimization Engine</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">342 active trucks · AI-optimized daily</div>
        ${[['London → Manchester','A-Route','142km','2h 20m','98%'],['Birmingham → Leeds','B-Route','144km','2h 35m','91%'],['Bristol → Cardiff','C-Route','48km','52m','99%']].map(([r,t,d,time,u])=>`
          <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <div style="flex:1">
              <div style="font-size:13px;font-weight:600">${r}</div>
              <div style="font-size:11px;color:var(--ink-soft)">${t} · ${d} · ${time}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:${parseInt(u)>=95?'var(--green)':parseInt(u)>=85?'var(--amber)':'var(--red)'}">${u}</div>
              <div style="font-size:10px;color:var(--ink-faint)">utilization</div>
            </div>
          </div>`).join('')}
      </div>
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Disruption Risk Monitor</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Real-time supply chain risk signals</div>
        ${[
          ['Red Sea Routing','Container diversions +34%','HIGH','Rerouting active'],
          ['BASF Cracker Maintenance','Q2 ethylene supply −5%','MED','Inventory buffer built'],
          ['Fonterra Crop Revision','WMP supply adjustment','MED','Monitoring'],
          ['UK Port Congestion','Dover backlog −18%','LOW','Resolved'],
        ].map(([r,d,p,s])=>`
          <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <span class="badge ${p==='HIGH'?'badge-red':p==='MED'?'badge-amber':'badge-buy'}" style="font-size:9px;margin-top:2px">${p}</span>
            <div style="flex:1">
              <div style="font-size:12.5px;font-weight:600">${r}</div>
              <div style="font-size:11.5px;color:var(--ink-soft)">${d}</div>
            </div>
            <span class="badge badge-teal" style="font-size:9px">${s}</span>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function buildSupply() {
  const el = document.getElementById('supply-nodes');
  if (el) {
    const suppliers = [
      {name:'BASF SE',cat:'Petrochem',risk:22,status:'Normal',spend:'£48M'},
      {name:'Fonterra',cat:'Dairy',risk:45,status:'Watch',spend:'£38M'},
      {name:'Wilmar Int.',cat:'Palm Oil',risk:38,status:'Watch',spend:'£41M'},
      {name:'INEOS Group',cat:'Petrochem',risk:18,status:'Normal',spend:'£22M'},
    ];
    el.innerHTML = suppliers.map(s=>`
      <div class="supply-node" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:13px;font-weight:700">${s.name}</div>
            <div style="font-size:11px;color:var(--ink-soft)">${s.cat} · ${s.spend} spend</div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:700;color:${s.risk<30?'var(--green)':s.risk<50?'var(--amber)':'var(--red)'}">Risk: ${s.risk}/100</div>
            <span class="badge ${s.status==='Normal'?'badge-buy':'badge-amber'}" style="font-size:9px">${s.status}</span>
          </div>
        </div>
        <div style="margin-top:8px"><div class="prog-bar"><div class="prog-fill" style="width:${s.risk}%;background:${s.risk<30?'var(--green)':s.risk<50?'var(--amber)':'var(--red)'}"></div></div></div>
      </div>`).join('');
  }

  const invCtx = document.getElementById('inventory-chart');
  if (invCtx) {
    activeCharts.inventory = new Chart(invCtx,{
      type:'bar',
      data:{
        labels:['Ethylene','NFDM','WMP','Palm Oil','Propylene','Chlorine'],
        datasets:[
          {label:'Current Stock',data:[28,45,32,18,38,55],backgroundColor:'rgba(13,148,136,.65)',borderRadius:4},
          {label:'AI Target',data:[35,40,38,28,30,50],backgroundColor:'rgba(212,175,55,.6)',borderRadius:4}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
        scales:{
          y:{title:{display:true,text:'Days of Cover'},grid:{color:'rgba(0,0,0,.04)'}},
          x:{grid:{display:false}}
        }
      }
    });
  }
}

// ══════════════════════════════════════════════════════════════════════════════
// REPORTS
// ══════════════════════════════════════════════════════════════════════════════
function renderReports() {
  const reports = [
    {icon:'📊',title:'Executive Hedge Summary',desc:'Monthly CFO-ready report on hedging performance, M2M, and AI accuracy',tag:'Monthly',action:'Generate'},
    {icon:'📈',title:'Board Risk Report',desc:'Quarterly tail risk, scenario analysis, and portfolio health for board review',tag:'Quarterly',action:'Generate'},
    {icon:'🌿',title:'CBAM Compliance Report',desc:'EU Carbon Border Adjustment Mechanism impact and compliance status',tag:'Regulatory',action:'Generate'},
    {icon:'🤖',title:'AI Oracle Audit Trail',desc:'Natural language justification for every AI recommendation (IFRS 9 compliant)',tag:'Compliance',action:'Download'},
    {icon:'⚖️',title:'EMIR Trade Report',desc:'Regulatory trade reporting for derivatives — auto-submitted to TR',tag:'Regulatory',action:'Auto-Submit'},
    {icon:'📉',title:'Behavioral Bias Report',desc:'12-month analysis of human override decisions and their financial impact',tag:'Analytics',action:'Generate'},
  ];
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">📑 Reports & Analytics</div>
        <div class="page-sub">Executive reporting · Compliance documents · AI audit trails · Board-ready outputs</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost">Schedule Reports</button>
        <button class="btn btn-primary" onclick="exportAllReports()">⬇ Batch Export</button>
      </div>
    </div>

    <div class="g3" style="margin-bottom:16px">
      ${reports.map(r=>`
        <div class="report-card" onclick="exportReport('${r.title}')">
          <div class="report-icon">${r.icon}</div>
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
            <div style="font-size:14px;font-weight:700;flex:1">${r.title}</div>
            <span class="badge badge-teal" style="font-size:9px">${r.tag}</span>
          </div>
          <div style="font-size:12px;color:var(--ink-soft);line-height:1.55;margin-bottom:12px">${r.desc}</div>
          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();exportReport('${r.action}: ${r.title}')">${r.action}</button>
        </div>`).join('')}
    </div>

    <div class="g2">
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Report Schedule</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Automated delivery to stakeholders</div>
        ${[
          ['Exec Hedge Summary','CFO, Treasurer','Last Monday of month','Email + Slack'],
          ['Board Risk Report','Board Members','Quarterly, Day before Q-review','PDF to Sharepoint'],
          ['EMIR Trade Report','Regulatory team','Daily 18:00 UTC','Auto-submitted'],
          ['AI Oracle Audit','Compliance','On each Oracle run','Stored to audit log'],
        ].map(([r,recv,freq,m])=>`
          <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <div style="flex:1">
              <div style="font-size:13px;font-weight:600">${r}</div>
              <div style="font-size:11px;color:var(--ink-soft)">→ ${recv}</div>
              <div style="font-size:11px;color:var(--ink-faint)">${freq}</div>
            </div>
            <span class="badge badge-teal" style="font-size:9px">${m}</span>
          </div>`).join('')}
      </div>
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Recent Exports</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Last 5 generated reports</div>
        ${[
          ['Hedge Summary Jan 2026','PDF · 2.1MB','2 Feb 2026'],
          ['Board Risk Q4 2025','PDF · 4.8MB','15 Jan 2026'],
          ['AI Audit Trail Feb','CSV · 0.8MB','Today 09:14'],
          ['EMIR Daily Report','XML · 0.3MB','Today 18:00'],
          ['CBAM Q1 Impact','PDF · 1.4MB','28 Jan 2026'],
        ].map(([n,sz,d])=>`
          <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <span style="font-size:18px">📄</span>
            <div style="flex:1">
              <div style="font-size:12.5px;font-weight:600">${n}</div>
              <div style="font-size:11px;color:var(--ink-faint)">${sz} · ${d}</div>
            </div>
            <button class="btn btn-ghost btn-xs" onclick="downloadData('${n}')">⬇</button>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ══════════════════════════════════════════════════════════════════════════════
// SETTINGS
// ══════════════════════════════════════════════════════════════════════════════
function renderSettings() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">⚙ Settings & Configuration</div>
        <div class="page-sub">Platform preferences · Integrations · User management · API configuration</div>
      </div>
      <button class="btn btn-primary" onclick="saveSettings(this)">Save Changes</button>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <!-- Profile & Preferences -->
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:16px">User Profile</div>
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
          <div class="avatar" style="width:52px;height:52px;font-size:18px">S</div>
          <div>
            <div style="font-size:15px;font-weight:700">Sandip Gupta</div>
            <div style="font-size:12px;color:var(--ink-soft)">Head of Commodity Risk · RB Group</div>
            <div style="font-size:11px;color:var(--ink-faint)">sandip.gupta@rb.com</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px">
          ${[
            ['Display Name','Sandip Gupta'],
            ['Email','sandip.gupta@rb.com'],
            ['Currency','GBP (£)'],
            ['Time Zone','Europe/London (GMT)'],
          ].map(([l,v])=>`
            <div>
              <label style="font-size:11px;font-weight:700;color:var(--ink-faint);text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:5px">${l}</label>
              <input type="text" value="${v}" style="font-size:13px"/>
            </div>`).join('')}
        </div>
      </div>

      <!-- Notification Preferences -->
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:16px">Notification Preferences</div>
        ${[
          ['AI Oracle Recommendations','Get notified when new AI recommendations are ready',true],
          ['Signal Alerts (High Impact)','Receive high-impact alternative data signals immediately',true],
          ['Execution Window Opens','Alert when optimal hedge timing windows are detected',true],
          ['IFRS 9 Test Results','Notify on hedge effectiveness test completions',false],
          ['Behavioral Bias Flags','Alert when AI detects decision bias patterns',true],
          ['Weekly Portfolio Summary','Automated weekly digest via email',false],
        ].map(([t,d,on])=>`
          <div style="display:flex;align-items:flex-start;gap:12px;padding:11px 0;border-bottom:1px solid var(--border-s)" onclick="this.querySelector('.toggle').classList.toggle('on')">
            <div style="flex:1">
              <div style="font-size:13px;font-weight:600">${t}</div>
              <div style="font-size:11.5px;color:var(--ink-soft);margin-top:2px">${d}</div>
            </div>
            <div class="toggle${on?' on':''}"></div>
          </div>`).join('')}
      </div>
    </div>

    <!-- Integrations -->
    <div class="card" style="padding:22px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div>
          <div style="font-size:15px;font-weight:700">Data Integrations</div>
          <div style="font-size:12px;color:var(--ink-soft)">Connect to exchanges, ERPs, and data providers</div>
        </div>
        <button class="btn btn-ghost btn-sm">+ Add Integration</button>
      </div>
      <div class="g2">
        ${[
          ['🏛','CME Group','Futures pricing · Enabled','Connected','var(--green)'],
          ['🏛','ICE Futures','Energy & soft commodities · Enabled','Connected','var(--green)'],
          ['📊','Bloomberg Terminal','Market data feed','Connected','var(--green)'],
          ['🏭','SAP S/4HANA','ERP & commodity contracts','Connected','var(--green)'],
          ['🛰','Satellogic','Satellite crop intelligence','Connected','var(--green)'],
          ['🚢','MarineTraffic AIS','Shipping tracking','Connected','var(--green)'],
          ['☁️','Weather Source','Weather data feed','Connected','var(--green)'],
          ['📋','DTCC Trade Rep.','EMIR reporting','Connected','var(--green)'],
          ['💳','Refinitiv Eikon','News & sentiment','Pending','var(--amber)'],
          ['🔗','Naphtha OTC Desk','Proxy hedge execution','Setup required','var(--red)'],
        ].map(([icon,name,desc,status,color])=>`
          <div class="integration-item">
            <div class="integration-icon" style="background:var(--surface-alt);border:1px solid var(--border)">${icon}</div>
            <div style="flex:1">
              <div style="font-size:13px;font-weight:700">${name}</div>
              <div style="font-size:11.5px;color:var(--ink-soft)">${desc}</div>
            </div>
            <span class="badge" style="background:${color}15;color:${color};border:1px solid ${color}40;font-size:9px">${status}</span>
          </div>`).join('')}
      </div>
    </div>

    <!-- Security & Compliance -->
    <div class="g2">
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:16px">Security Settings</div>
        ${[
          ['Two-Factor Authentication','Enable 2FA for account security',true],
          ['Session Timeout','Auto-logout after 30 minutes of inactivity',true],
          ['API Access Logging','Log all API calls for compliance audit',true],
          ['SSO Integration','Azure AD single sign-on',true],
        ].map(([t,d,on])=>`
          <div style="display:flex;align-items:flex-start;gap:12px;padding:11px 0;border-bottom:1px solid var(--border-s)" onclick="this.querySelector('.toggle').classList.toggle('on')">
            <div style="flex:1">
              <div style="font-size:13px;font-weight:600">${t}</div>
              <div style="font-size:11.5px;color:var(--ink-soft)">${d}</div>
            </div>
            <div class="toggle${on?' on':''}"></div>
          </div>`).join('')}
      </div>
      <div class="card" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:16px">Compliance Framework</div>
        ${[
          ['IFRS 9 Hedge Accounting','Enabled','var(--green)','Prospective tests auto-run daily'],
          ['EMIR Reporting','Active','var(--green)','Auto-submitted to DTCC daily'],
          ['EU CBAM Overlay','Active','var(--green)','Carbon premium applied from Jan 2026'],
          ['Dodd-Frank Compliance','Enabled','var(--green)','US counterparty reporting active'],
          ['Basel III Framework','Monitoring','var(--amber)','Counterparty credit risk tracked'],
        ].map(([f,s,c,d])=>`
          <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <div style="flex:1">
              <div style="font-size:13px;font-weight:600">${f}</div>
              <div style="font-size:11.5px;color:var(--ink-soft)">${d}</div>
            </div>
            <span class="badge" style="background:${c}15;color:${c};border:1px solid ${c}40;font-size:9px">${s}</span>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ══════════════════════════════════════════════════════════════════════════════
// PRICING OS — PriceOS embedded as Revenue Engine sub-module
// ══════════════════════════════════════════════════════════════════════════════
let posView = 'dashboard';
let posCopilotHistory = [];
let posChartInst = null;

function renderPricingOS() {
  return `
  <div class="animate-in" id="pos-root">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <div class="page-title dm-serif" style="display:flex;align-items:center;gap:12px">
          Pricing OS
          <span style="font-family:Arial, 'Helvetica Neue', Helvetica, sans-serif;font-size:11px;font-weight:800;background:var(--pink);color:white;padding:3px 9px;border-radius:980px;letter-spacing:.06em;vertical-align:middle">by PriceOS</span>
        </div>
        <div class="page-sub">Causal ML elasticity · 1,024 scenarios/night · Guardrailed autopilot · Reckitt × Shoprite × Carrefour AME</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="live-pill"><div class="live-dot"></div><span class="live-txt">3 Pilots Live</span></div>
        <button class="btn btn-pink" onclick="posSetView('autopilot')">→ +£2.1M Apply Scenarios</button>
      </div>
    </div>

    <!-- Live 3-number strip -->
    <div class="live-strip" id="pos-live-strip">
      <div class="live-card" style="--lc-color:var(--green)">
        <div class="live-card-label">
          <span style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:liveNumPulse 2.5s ease-in-out infinite;display:inline-block"></span>
          Margin Opportunity This Week
        </div>
        <div class="live-card-val count-up live-num">+£2.1M</div>
        <div class="live-card-delta" style="color:var(--green)">↑ Top 3 scenarios applied · 1,024 runs</div>
      </div>
      <div class="live-card" style="--lc-color:var(--pink)">
        <div class="live-card-label">
          <span style="width:6px;height:6px;border-radius:50%;background:var(--pink);box-shadow:0 0 8px var(--pink);animation:liveNumPulse 2s ease-in-out infinite;display:inline-block"></span>
          Optimal Price · Dettol 500ml
        </div>
        <div class="live-card-val count-up" style="color:var(--pink)">£12.40</div>
        <div class="live-card-delta" style="color:var(--ink-soft)">↑ +6.0% recommended · Shoprite NA</div>
      </div>
      <div class="live-card" style="--lc-color:var(--teal)">
        <div class="live-card-label">
          <span style="width:6px;height:6px;border-radius:50%;background:var(--teal);box-shadow:0 0 6px var(--teal);animation:liveNumPulse 3s ease-in-out infinite;display:inline-block"></span>
          Causal Elasticity (Own-Price)
        </div>
        <div class="live-card-val count-up" style="color:var(--teal)">−2.41</div>
        <div class="live-card-delta" style="color:var(--ink-soft)">Double ML estimate · ±0.18 CI · p&lt;0.001</div>
      </div>
    </div>

    <!-- Hierarchy tab bar: clear What Happened → What To Do → Do It -->
    <div class="pos-tab-bar">
      <div class="pos-tab ${posView==='dashboard'?'active':''}" onclick="posSetView('dashboard')">📊 What Happened</div>
      <div class="pos-tab ${posView==='causal'?'active':''}" onclick="posSetView('causal')">🧠 Why It Happened</div>
      <div class="pos-tab ${posView==='scenarios'?'active':''}" onclick="posSetView('scenarios')">🎯 What To Do</div>
      <div class="pos-tab ${posView==='copilot'?'active':''}" onclick="posSetView('copilot')">💬 Ask Copilot</div>
      <div class="pos-tab ${posView==='competitor'?'active':''}" onclick="posSetView('competitor')">👁 Competitor Watch</div>
      <div class="pos-tab ${posView==='autopilot'?'active pink-tab':''}" onclick="posSetView('autopilot')">⚡ Execute It</div>
    </div>

    <!-- View container -->
    <div id="pos-view-container"></div>
  </div>`;
}

function posSetView(view) {
  posView = view;
  // Re-render tabs
  document.querySelectorAll('.pos-tab').forEach((t,i) => {
    const views = ['dashboard','causal','scenarios','copilot','competitor','autopilot'];
    t.className = 'pos-tab' + (views[i]===view?' active':'') + (views[i]==='autopilot'&&view==='autopilot'?' pink-tab':'');
  });
  const el = document.getElementById('pos-view-container');
  if (!el) return;
  el.innerHTML = getPosViewHTML(view);
  setTimeout(() => buildPosView(view), 80);
}

function getPosViewHTML(view) {
  switch(view) {
    case 'dashboard': return renderPosDashboard();
    case 'causal': return renderPosCausal();
    case 'scenarios': return renderPosScenarios();
    case 'copilot': return renderPosCopilot();
    case 'competitor': return renderPosCompetitor();
    case 'autopilot': return renderPosAutopilot();
    default: return '';
  }
}

function renderPosDashboard() {
  return `
  <div class="g4" style="margin-bottom:16px">
    <div class="kpi" style="--kpi-accent:var(--green)">
      <div class="kpi-label">Margin Uplift QTD</div>
      <div class="kpi-val count-up" style="color:var(--green)">+4.2%</div>
      <div class="kpi-delta up">↑ vs last quarter</div>
    </div>
    <div class="kpi" style="--kpi-accent:var(--pink)">
      <div class="kpi-label">Optimal Avg Price</div>
      <div class="kpi-val count-up">£12.40</div>
      <div class="kpi-delta neutral">Model recommended</div>
    </div>
    <div class="kpi" style="--kpi-accent:var(--teal)">
      <div class="kpi-label">Sales Δ if +10% Price</div>
      <div class="kpi-val count-up" style="color:var(--red)">−34%</div>
      <div class="kpi-delta neutral">Causal est. ±2.8%</div>
    </div>
    <div class="kpi" style="--kpi-accent:var(--gold)">
      <div class="kpi-label">Scenarios Run</div>
      <div class="kpi-val count-up">1,024</div>
      <div class="kpi-delta up">10 recs ready</div>
    </div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Price Elasticity Curve — Causal ML</div>
        <div class="card-sub">Double ML estimate · Dettol 500ml · Shoprite NA · Confidence band ±1σ</div>
      </div>
      <div style="padding:18px 20px"><div style="position:relative;height:200px;width:100%"><canvas id="pos-elasticity-chart"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">Pilot Performance · Month 4</div>
        <div class="card-sub">PriceOS markets vs existing process — A/B split · 14 Northern Africa markets</div>
      </div>
      <div style="padding:18px 20px">
        ${[
          ['+5.4%','Gross Margin Δ (PriceOS)','var(--green)'],
          ['−1.8%','Volume Δ (within tolerance)','var(--ink-soft)'],
          ['17%','Elasticity error (vs 31% baseline)','var(--teal)'],
          ['+£2.4M','Annualised P&L upside','var(--green)'],
        ].map(([v,l,c])=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-s)">
            <div style="font-size:13px;color:var(--ink-soft)">${l}</div>
            <div class="count-up" style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:${c}">${v}</div>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function renderPosCausal() {
  return `
  <div class="g2" style="margin-bottom:16px">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Predicted vs Actual Demand</div>
        <div class="card-sub">Double ML fit · R² = 0.87 · Last trained: 3 days ago</div>
      </div>
      <div style="padding:18px 20px"><div style="position:relative;height:220px;width:100%"><canvas id="pos-causal-chart"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">Feature Coefficients</div>
        <div class="card-sub">Causal effect on volume · Statistical significance</div>
      </div>
      <div style="padding:8px 0">
        ${[
          ['Own Price','−2.41','var(--red)',90,'***'],
          ['Carrefour Price','+1.18','var(--teal)',55,'***'],
          ['Promo Depth','+3.20','var(--green)',85,'***'],
          ['Shelf Share','+0.74','var(--blue)',35,'**'],
          ['Seasonality','+0.42','var(--ink-soft)',20,'**'],
        ].map(([feat,coef,c,w,sig])=>`
          <div style="display:flex;align-items:center;gap:12px;padding:11px 20px;border-bottom:1px solid var(--border-s)">
            <div style="flex:1;font-size:13px;color:var(--ink)">${feat}</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:${c};min-width:50px">${coef}</div>
            <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);min-width:28px">${sig}</span>
            <div style="min-width:80px">
              <div class="prog-bar"><div class="prog-fill" style="width:${w}%;background:${c}"></div></div>
            </div>
          </div>`).join('')}
      </div>
    </div>
  </div>
  <div class="card" style="border-color:var(--pink-border);background:rgba(255,45,120,.02)">
    <div style="padding:20px 24px;display:flex;align-items:flex-start;gap:16px">
      <div style="font-size:28px">🧠</div>
      <div>
        <div style="font-size:15px;font-weight:700;color:var(--ink);margin-bottom:8px">Causal insight: What confounders were removed</div>
        <div style="font-size:13.5px;color:var(--ink-soft);line-height:1.7">
          Double ML separates the price elasticity from the Q3 promotional calendar (<strong style="color:var(--ink)">+3.2 volume effect</strong>), Ramadan seasonal uplift (<strong style="color:var(--ink)">+0.9</strong>), and Carrefour's parallel price move in the same period.
          Raw correlation would have <strong style="color:var(--pink)">underestimated price sensitivity by 38%</strong> vs this causal estimate — the difference between a correct +6% recommendation and a 4% undershot that leaves £0.8M on the table.
        </div>
      </div>
    </div>
  </div>`;
}

function renderPosScenarios() {
  const scenarios = [
    {rank:1,sku:'Dettol 500ml · Shoprite NA',change:'+6.0%',margin:'+3.8% / +£2.1M ann',vol:'Low −1.8%',signal:'Clear',alert:'badge-buy'},
    {rank:2,sku:'Dettol 1L · Shoprite SA',change:'+4.5%',margin:'+2.9% / +£1.6M ann',vol:'Low −2.1%',signal:'Watch',alert:'badge-hold'},
    {rank:3,sku:'Harpic 500ml · Shoprite EA',change:'+8.0%',margin:'+2.4% / +£0.9M ann',vol:'Med −4.8%',signal:'Clear',alert:'badge-buy'},
    {rank:4,sku:'Dettol 500ml · Carrefour UAE',change:'−3.0%',margin:'+1.8% / +£0.7M ann',vol:'Defensive',signal:'Urgent',alert:'badge-sell'},
    {rank:5,sku:'Harpic 1L · LuLu KSA',change:'+5.5%',margin:'+1.6% / +£0.6M ann',vol:'Med −3.2%',signal:'Clear',alert:'badge-buy'},
  ];
  return `
  <div class="card" style="overflow:hidden;margin-bottom:16px">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="card-title">Overnight Scenario Rankings</div>
        <div class="card-sub">1,024 scenarios · Ranked by net margin impact · Competitor signals integrated</div>
      </div>
      <button class="btn btn-pink btn-sm" onclick="posSetView('autopilot')">→ Apply All +£2.1M</button>
    </div>
    <div style="display:grid;grid-template-columns:32px 1fr 72px 1fr 80px 80px 110px;padding:10px 20px;background:var(--surface-alt);border-bottom:1px solid var(--border)">
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">#</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">SKU</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">Price Δ</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">Margin Impact</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">Vol Risk</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">Signal</span>
      <span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">Action</span>
    </div>
    ${scenarios.map(s=>`
    <div class="pos-sc-row">
      <div class="${s.rank===1?'pos-rank pos-rank-1':'pos-rank pos-rank-n'}">${s.rank}</div>
      <div style="font-size:13px;font-weight:600;color:var(--ink)">${s.sku}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:${s.change.startsWith('+')?'var(--green)':'var(--red)'}">${s.change}</div>
      <div style="font-size:13px;color:var(--green);font-weight:600">${s.margin}</div>
      <div style="font-size:12px;color:var(--ink-soft)">${s.vol}</div>
      <span class="badge ${s.alert}" style="font-size:10px">${s.signal}</span>
      <button class="btn btn-pink btn-xs" onclick="posApplyScenario(this,'${s.sku}')">→ Apply</button>
    </div>`).join('')}
  </div>
  <div class="card" style="border-color:var(--pink-border);background:rgba(255,45,120,.02)">
    <div style="padding:18px 22px">
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">🎯 Game-theory competitor response</div>
      <div style="font-size:13.5px;color:var(--ink-soft);line-height:1.7">Carrefour UAE's −9.7% move 7 days ago is a <strong style="color:var(--ink)">promotional reset, not a structural price war</strong> (confidence: 81%). Recommend a <strong style="color:var(--pink)">−3.0% defensive cut on Dettol 500ml UAE only</strong> — protecting volume in the near term while preserving margin across 13 other markets. Holding all markets would cost an estimated <strong style="color:var(--red)">£420K in share over 90 days</strong> based on cross-price elasticity.</div>
    </div>
  </div>`;
}

function renderPosCopilot() {
  return `
  <div class="pos-copilot-panel">
    <div class="pos-copilot-header">
      <div class="pos-copilot-title">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--pink);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:white">P</div>
        PriceOS Copilot
        <span style="font-size:11px;font-weight:600;color:rgba(255,255,255,.4)">Powered by Claude · Full pricing graph access</span>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:5px;font-size:11.5px;color:var(--green);font-weight:700">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:liveNumPulse 2s ease-in-out infinite;display:inline-block"></span>
        Live AI
      </div>
    </div>
    <div class="pos-chat-msgs" id="pos-copilot-msgs">
      <div class="pos-msg">
        <div class="pos-avatar pos-avatar-ai">P</div>
        <div class="pos-bubble">Good morning. Ran <strong>1,024 scenarios overnight</strong>. Top recommendation: <span class="p-pink">+6% on Dettol 500ml at Shoprite NA</span>, projecting <span class="p-green">+3.8% net margin</span> with &lt;2% volume loss. Carrefour hasn't moved in 8 days — low defensive risk. Causal elasticity: −2.41 (Double ML, 94% confidence). Ready to simulate competitor response?</div>
      </div>
    </div>
    <div style="padding:12px 16px 8px;border-top:1px solid var(--border-s);display:flex;gap:8px;flex-wrap:wrap;background:var(--surface-alt)">
      ${[
        'Optimal price for Dettol 500ml next week?',
        'What if Carrefour drops 8% on Dettol?',
        'Which SKUs have highest margin recovery?',
        'Explain the causal model CI for Harpic',
      ].map(q=>`<div class="badge badge-teal" style="cursor:pointer;font-size:11px" onclick="posFillPrompt('${q}')">${q}</div>`).join('')}
    </div>
    <div class="pos-input-row">
      <input class="pos-input" id="pos-copilot-input" placeholder='Ask about SKUs, scenarios, competitor moves, model confidence...' type="text" onkeydown="if(event.key==='Enter')posSendMessage()">
      <button class="pos-send-btn" id="pos-send-btn" onclick="posSendMessage()">Ask</button>
    </div>
  </div>`;
}

function renderPosCompetitor() {
  const rows = [
    {name:'Carrefour UAE',sku:'Dettol 500ml equiv',their:'£11.20',our:'£12.40',change:'↓ −9.7% (7 days ago)',alert:'badge-sell',alertTxt:'⚡ High'},
    {name:'LuLu Hypermarket',sku:'Dettol 500ml equiv',their:'£12.50',our:'£12.40',change:'→ No change',alert:'badge-buy',alertTxt:'✓ Stable'},
    {name:'Shoprite Egypt',sku:'Harpic 500ml equiv',their:'£9.80',our:'£9.20',change:'↑ +6.5% (2 days ago)',alert:'badge-hold',alertTxt:'⚠ Watch'},
    {name:'Panda KSA',sku:'Dettol 1L equiv',their:'£18.90',our:'£19.20',change:'→ No change',alert:'badge-buy',alertTxt:'✓ Stable'},
    {name:'Spinneys Lebanon',sku:'Dettol 500ml equiv',their:'£10.90',our:'£12.40',change:'↓ −12.1% (new)',alert:'badge-sell',alertTxt:'⚡ High'},
  ];
  return `
  <div class="card" style="overflow:hidden;margin-bottom:16px">
    <div class="card-header">
      <div class="card-title">Live Competitor Watch · AME Region</div>
      <div class="card-sub">Scraping 48 retailers · Last refresh: 6 min ago · Game-theory signals active</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 70px 70px 1fr 100px;padding:10px 20px;background:var(--surface-alt);border-bottom:1px solid var(--border)">
      ${['Competitor','SKU Match','Their Price','Our Price','Δ Change','Alert'].map(h=>`<span style="font-size:10px;color:var(--ink-faint);font-weight:700;text-transform:uppercase;letter-spacing:.07em">${h}</span>`).join('')}
    </div>
    ${rows.map(r=>`
    <div style="display:grid;grid-template-columns:1fr 1fr 70px 70px 1fr 100px;align-items:center;padding:13px 20px;border-bottom:1px solid var(--border-s);font-size:13px;cursor:pointer;transition:var(--transition)" onmouseenter="this.style.background='var(--teal-glow-s)'" onmouseleave="this.style.background=''">
      <div style="font-weight:700;color:var(--ink)">${r.name}</div>
      <div style="color:var(--ink-soft)">${r.sku}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-weight:700;color:${r.change.includes('↓')?'var(--red)':r.change.includes('↑')?'var(--green)':'var(--ink)'}">${r.their}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--ink)">${r.our}</div>
      <div style="font-size:12px;font-weight:600;color:${r.change.includes('↓')?'var(--red)':r.change.includes('↑')?'var(--green)':'var(--ink-soft)'}">${r.change}</div>
      <span class="badge ${r.alert}">${r.alertTxt}</span>
    </div>`).join('')}
  </div>
  <div class="card" style="border-color:var(--pink-border);background:rgba(255,45,120,.02)">
    <div style="padding:18px 22px">
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">🎯 Game-theory recommendation</div>
      <div style="font-size:13.5px;color:var(--ink-soft);line-height:1.7">Carrefour UAE's −9.7% move is a promotional reset (confidence: 81%). Recommend: <strong style="color:var(--pink)">−3.0% defensive cut on Dettol 500ml UAE only</strong>. Holding all markets = estimated <strong style="color:var(--red)">−£420K share loss over 90 days</strong>.</div>
      <div style="margin-top:14px"><button class="btn btn-pink btn-sm" onclick="posSetView('autopilot')">→ Apply Defensive Response −£420K Protection</button></div>
    </div>
  </div>`;
}

function renderPosAutopilot() {
  return `
  <div class="g2">
    <div class="card">
      <div class="card-header">
        <div class="card-title" style="display:flex;align-items:center;gap:10px">
          Auto-Pilot Configuration
          <span style="font-size:11px;font-weight:700;color:var(--green);background:var(--green-bg);padding:3px 9px;border-radius:980px;border:1px solid rgba(16,185,129,.2)">● ACTIVE</span>
        </div>
        <div class="card-sub">2 changes executed this week · All within guardrail policy · EU AI Act compliant</div>
      </div>
      <div style="padding:18px 22px">
        ${[
          ['Max single price increase','+8.0%','var(--green)'],
          ['Max single price decrease','−5.0%','var(--green)'],
          ['Max weekly changes','3 SKUs','var(--green)'],
          ['Promotional period lock','Yes — 14 days','var(--green)'],
          ['Competitor trigger threshold','Δ > 7% activates review','var(--green)'],
          ['Human approval required above','+6% or −4%','var(--amber)'],
          ['EU AI Act explainability','Enabled · Full audit trail','var(--green)'],
        ].map(([l,v,c])=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-s)">
            <span style="font-size:13px;color:var(--ink-soft)">${l}</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700;color:${c}">${v}</span>
          </div>`).join('')}
        <div style="margin-top:18px;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--pink-bg);border:1px solid var(--pink-border);border-radius:var(--r10)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--pink)">Auto-Pilot Armed</div>
            <div style="font-size:11.5px;color:var(--ink-soft);margin-top:2px">Executes approved scenarios within guardrails</div>
          </div>
          <div class="pos-toggle on" id="pos-autopilot-toggle" onclick="this.classList.toggle('on')"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">Pending Actions — Apply Now</div>
        <div class="card-sub">Top 3 overnight scenarios · Total opportunity: <strong style="color:var(--green)">+£2.1M</strong></div>
      </div>
      <div style="padding:18px 22px;display:flex;flex-direction:column;gap:12px">
        ${[
          {sku:'Dettol 500ml · Shoprite NA',change:'+6.0%',margin:'+£2.1M ann',conf:94},
          {sku:'Dettol 1L · Shoprite SA',change:'+4.5%',margin:'+£1.6M ann',conf:89},
          {sku:'Harpic 500ml · Shoprite EA',change:'+8.0%',margin:'+£0.9M ann',conf:82},
        ].map((s,i)=>`
          <div style="padding:14px 16px;border:1px solid var(--border);border-radius:var(--r12);transition:var(--transition)" onmouseenter="this.style.borderColor='var(--pink-border)'" onmouseleave="this.style.borderColor='var(--border)'">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
              <div>
                <div style="font-size:13.5px;font-weight:700;color:var(--ink)">${s.sku}</div>
                <div style="font-size:12px;color:var(--ink-soft);margin-top:2px">Confidence: ${s.conf}% · Within guardrail · Causal ML</div>
              </div>
              <div style="text-align:right">
                <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:800;color:var(--green)">${s.margin}</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ink-soft)">${s.change}</div>
              </div>
            </div>
            <button class="btn btn-pink" style="width:100%;justify-content:center" onclick="posApplyScenario(this,'${s.sku}')">→ Apply ${s.margin}</button>
          </div>`).join('')}
        <div style="border-top:1px solid var(--border);padding-top:14px">
          <button class="btn btn-pink" style="width:100%;justify-content:center;font-size:14px;padding:13px" onclick="posApplyAll(this)">⚡ Apply All 3 Scenarios → +£2.1M This Week</button>
        </div>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:16px;border-color:rgba(59,130,246,.2);background:rgba(59,130,246,.02)">
    <div style="padding:18px 22px">
      <div style="font-size:14px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px">⚖️ EU AI Act Compliance <span class="badge badge-blue">IFRS 9 + EU AI Act</span></div>
      <div style="font-size:13.5px;color:var(--ink-soft);line-height:1.7">Every executed action includes a full causal reasoning trace, counterfactual explanation, and human override record — satisfying <strong style="color:var(--ink)">Article 14 (human oversight)</strong> and <strong style="color:var(--ink)">Article 13 (transparency)</strong> for high-risk AI systems. Audit export in PDF or JSON available for board review.</div>
    </div>
  </div>`;
}

function buildPricingOS() {
  posView = 'dashboard';
  // Render initial view
  const el = document.getElementById('pos-view-container');
  if (el) {
    el.innerHTML = getPosViewHTML('dashboard');
    setTimeout(() => buildPosView('dashboard'), 80);
  }
}

function buildPosView(view) {
  if (view === 'dashboard') buildPosElasticity();
  if (view === 'causal') buildPosCausalChart();
}

function buildPosElasticity() {
  const canvas = document.getElementById('pos-elasticity-chart');
  if (!canvas) return;
  const prices = [], demand = [], upper = [], lower = [];
  for (let p = 8; p <= 18; p += 0.5) {
    const d = Math.round(100000 * Math.pow(p/12.4, -2.41));
    prices.push(p);
    demand.push(d);
    upper.push(Math.round(d * 1.08));
    lower.push(Math.round(d * 0.92));
  }
  new Chart(canvas, {
    type:'line',
    data:{
      labels: prices,
      datasets:[
        {label:'Demand (Causal ML)',data:demand,borderColor:'#0D9488',borderWidth:2.5,backgroundColor:'rgba(13,148,136,.08)',fill:false,pointRadius:0,tension:0.4},
        {label:'Upper CI',data:upper,borderColor:'rgba(13,148,136,.25)',borderWidth:1,borderDash:[4,4],fill:'+1',backgroundColor:'rgba(13,148,136,.06)',pointRadius:0,tension:0.4},
        {label:'Lower CI',data:lower,borderColor:'rgba(13,148,136,.25)',borderWidth:1,borderDash:[4,4],fill:false,pointRadius:0,tension:0.4},
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:10}}},
      scales:{
        x:{title:{display:true,text:'Price (£)'},grid:{color:'rgba(0,0,0,.04)'}},
        y:{title:{display:true,text:'Weekly Demand (units)'},grid:{color:'rgba(0,0,0,.04)'}}
      }
    }
  });
}

function buildPosCausalChart() {
  const canvas = document.getElementById('pos-causal-chart');
  if (!canvas) return;
  const actual = [], predicted = [];
  for (let i = 0; i < 24; i++) {
    const base = 800 + Math.sin(i*0.5)*200 + i*8;
    actual.push(Math.round(base + (Math.random()-0.5)*120));
    predicted.push(Math.round(base + (Math.random()-0.5)*40));
  }
  new Chart(canvas,{
    type:'line',
    data:{
      labels:Array.from({length:24},(_,i)=>`W${i+1}`),
      datasets:[
        {label:'Actual',data:actual,borderColor:'var(--pink)',borderWidth:1.5,backgroundColor:'transparent',pointRadius:2,tension:0.3},
        {label:'Predicted',data:predicted,borderColor:'var(--green)',borderWidth:2,backgroundColor:'transparent',pointRadius:2,tension:0.4}
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11},boxWidth:8}}},
      scales:{
        x:{grid:{color:'rgba(0,0,0,.04)'},ticks:{maxTicksLimit:8}},
        y:{grid:{color:'rgba(0,0,0,.04)'}}
      }
    }
  });
}

// Copilot message handling
const PRICEOS_SYSTEM = `You are PriceOS Copilot, an expert autonomous pricing intelligence assistant for FMCG brands embedded inside the NERVURE financial operating system. You serve the Reckitt commodity risk team.

Context: Dettol 500ml, Shoprite Northern Africa. Optimal price: £12.40. Causal elasticity: −2.41 (Double ML). Carrefour UAE dropped 9.7% (7 days ago). Top reco: +6.0% → +3.8% margin uplift. Pilot Month 4: +5.4% margin across PriceOS markets.

Be sharp, data-driven, specific to Reckitt/Dettol/Harpic/Finish/Enfamil portfolio. Use exact numbers. Reference confidence intervals. 2-4 sentences max. In the context of NERVURE's CFO-level view.`;

async function posSendMessage() {
  const input = document.getElementById('pos-copilot-input');
  const sendBtn = document.getElementById('pos-send-btn');
  const msgs = document.getElementById('pos-copilot-msgs');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  sendBtn.disabled = true;

  msgs.innerHTML += `<div class="pos-msg" style="flex-direction:row-reverse"><div class="pos-avatar pos-avatar-user">R</div><div class="pos-bubble user">${text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div></div>`;

  const typingId = 'postyping-' + Date.now();
  msgs.innerHTML += `<div class="pos-msg" id="${typingId}"><div class="pos-avatar pos-avatar-ai">P</div><div class="pos-bubble"><div class="pos-typing"><div class="pos-typing-dot"></div><div class="pos-typing-dot"></div><div class="pos-typing-dot"></div></div></div></div>`;
  msgs.scrollTop = msgs.scrollHeight;

  posCopilotHistory.push({role:'user',content:text});

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:PRICEOS_SYSTEM,messages:posCopilotHistory})
    });
    const data = await resp.json();
    const reply = data.content?.[0]?.text || 'Unable to respond. Check API configuration.';
    posCopilotHistory.push({role:'assistant',content:reply});
    document.getElementById(typingId)?.remove();
    const formatted = reply
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/(\+£[\d.]+[MKB]?)/g,'<span class="p-green">$1</span>')
      .replace(/(−£[\d.]+[MKB]?)/g,'<span style="color:var(--red);font-weight:700">$1</span>')
      .replace(/([\+\-][\d.]+%)/g,'<span class="p-pink">$1</span>');
    msgs.innerHTML += `<div class="pos-msg"><div class="pos-avatar pos-avatar-ai">P</div><div class="pos-bubble">${formatted}</div></div>`;
  } catch(e) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `<div class="pos-msg"><div class="pos-avatar pos-avatar-ai">P</div><div class="pos-bubble" style="color:var(--red)">API connection issue. Verify Anthropic API key.</div></div>`;
  }
  msgs.scrollTop = msgs.scrollHeight;
  sendBtn.disabled = false;
}

function posFillPrompt(text) {
  const input = document.getElementById('pos-copilot-input');
  if (input) { input.value = text; input.focus(); }
}

function posApplyScenario(btn, sku) {
  const orig = btn.innerHTML;
  btn.innerHTML = '✓ Applied';
  btn.style.background = 'var(--green)';
  // Count-up animation effect
  setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; }, 2200);
}

function posApplyAll(btn) {
  const orig = btn.innerHTML;
  btn.innerHTML = '✓ All 3 Applied — +£2.1M Executing';
  btn.style.background = 'var(--green)';
  setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; }, 3000);
}

// Add pricing-os and marginbridge to CMD palette
CMD_ITEMS.push({icon:'🎯',label:'Pricing OS',desc:'Causal ML pricing · Scenarios · Autopilot',action:()=>showModule('pricing-os',document.getElementById('nav-pricing-os'))});
CMD_ITEMS.push({icon:'🔗',label:'Margin Bridge',desc:'Cost-to-price transmission · PriceOS integration',action:()=>showModule('marginbridge',document.getElementById('nav-marginbridge'))});
CMD_ITEMS.push({icon:'🧮',label:'Elasticity Engine',desc:'LASSO/Ridge price elasticity backbone',action:()=>showModule('elasticity',document.getElementById('nav-elasticity'))});
CMD_ITEMS.push({icon:'📦',label:'Promo Decomposition',desc:'DFO-style baseline/uplift separation',action:()=>showModule('promo',document.getElementById('nav-promo'))});
CMD_ITEMS.push({icon:'⚖️',label:'Hedging Engine',desc:'Commodity hedge decision engine',action:()=>showModule('hedging',document.getElementById('nav-hedging'))});
CMD_ITEMS.push({icon:'📋',label:'Audit Log',desc:'IFRS 9 decision trail · All agent actions',action:()=>showModule('audit',document.getElementById('nav-audit'))});
CMD_ITEMS.push({icon:'🇮🇳',label:'GST Engine',desc:'ITC reconciliation · GSTR-1/3B matching · Working capital',action:()=>showModule('gst',document.getElementById('nav-gst'))});

// ══════════════════════════════════════════════════════════════════════════════
// PRICE REFLECTION — Live commodity sparkline reflected in hero glass
// ══════════════════════════════════════════════════════════════════════════════
const ETHYLENE_SPARK = [1142,1148,1151,1145,1153,1160,1158,1162,1171,1178,1182,1190,1194,1200,1198,1206,1212,1218,1222,1228,1235,1243,1250,1258];
let reflectionAnimFrame = null;
let sparkOffset = 0;

function initPriceReflection() {
  const canvas = document.getElementById('hero-reflection');
  if (!canvas) return;
  if (reflectionAnimFrame) cancelAnimationFrame(reflectionAnimFrame);

  const hero = canvas.closest('.hero');
  if (!hero) return;

  function resize() {
    canvas.width  = hero.offsetWidth;
    canvas.height = 80;
  }
  resize();
  window.addEventListener('resize', resize);

  function draw() {
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    if (!w) { reflectionAnimFrame = requestAnimationFrame(draw); return; }

    ctx.clearRect(0, 0, w, h);

    // Build extended data with scroll offset for shimmer
    const ext = [...ETHYLENE_SPARK, ...ETHYLENE_SPARK];
    const slice = ext.slice(sparkOffset % ETHYLENE_SPARK.length, (sparkOffset % ETHYLENE_SPARK.length) + 24);
    const min = Math.min(...slice), max = Math.max(...slice);
    const range = max - min || 1;

    // Draw line
    ctx.beginPath();
    ctx.lineWidth = 1.5;
    const grad = ctx.createLinearGradient(0, 0, w, 0);
    grad.addColorStop(0,   'rgba(94,234,212,0)');
    grad.addColorStop(0.2, 'rgba(94,234,212,0.9)');
    grad.addColorStop(0.8, 'rgba(94,234,212,0.9)');
    grad.addColorStop(1,   'rgba(94,234,212,0)');
    ctx.strokeStyle = grad;

    slice.forEach((v, i) => {
      const x = (i / (slice.length - 1)) * w;
      const y = h - 6 - ((v - min) / range) * (h - 12);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Fill under line
    const fillGrad = ctx.createLinearGradient(0, 0, 0, h);
    fillGrad.addColorStop(0, 'rgba(94,234,212,0.12)');
    fillGrad.addColorStop(1, 'rgba(94,234,212,0)');
    ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
    ctx.fillStyle = fillGrad;
    ctx.fill();

    sparkOffset++;
    if (sparkOffset > ETHYLENE_SPARK.length * 40) sparkOffset = 0;

    reflectionAnimFrame = requestAnimationFrame(() => {
      setTimeout(() => { reflectionAnimFrame = requestAnimationFrame(draw); }, 80);
    });
  }
  draw();
}

// ══════════════════════════════════════════════════════════════════════════════
// WATCH CYCLE — Countdown + agent loop simulation
// ══════════════════════════════════════════════════════════════════════════════
let wcSeconds = 14 * 60 + 32;
let wcInterval = null;
let wcAutopilotOn = true;
let wcAgentStep = 2; // 0=oracle,1=margin,2=priceos,3=hedge

function startWatchCycle() {
  if (wcInterval) clearInterval(wcInterval);
  wcInterval = setInterval(() => {
    wcSeconds--;
    if (wcSeconds < 0) {
      wcSeconds = 15 * 60;
      simulateWcRun();
    }
    const el = document.getElementById('wc-countdown');
    if (el) {
      const m = String(Math.floor(wcSeconds / 60)).padStart(2,'0');
      const s = String(wcSeconds % 60).padStart(2,'0');
      el.textContent = `${m}:${s}`;
    }
  }, 1000);
}

function simulateWcRun() {
  // Animate through agents sequentially
  const agents = ['wc-1','wc-2','wc-3','wc-4'];
  agents.forEach((id, i) => {
    const el = document.getElementById(id);
    if (el) {
      el.className = 'wc-agent pending';
      el.querySelector('span:last-child').textContent = '';
    }
  });
  let step = 0;
  const tick = setInterval(() => {
    if (step > 0) {
      const prev = document.getElementById(agents[step-1]);
      if (prev) {
        prev.className = 'wc-agent done';
        const last = prev.querySelector('span:last-child');
        if (last) last.innerHTML = '<span class="wc-check">✓</span>';
      }
    }
    if (step < agents.length) {
      const cur = document.getElementById(agents[step]);
      if (cur) {
        cur.className = 'wc-agent active';
        const last = cur.querySelector('span:last-child');
        if (last) last.innerHTML = '<span style="font-size:10px;opacity:.6;animation:spin .8s linear infinite;display:inline-block">⟳</span>';
      }
      step++;
    } else {
      clearInterval(tick);
      // Final: all done, show notification if autopilot on
      if (wcAutopilotOn) {
        const bar = document.getElementById('watch-cycle-bar');
        if (bar) {
          bar.style.borderColor = 'rgba(16,185,129,0.4)';
          setTimeout(() => { bar.style.borderColor = ''; }, 3000);
        }
      }
    }
  }, 900);
}

function toggleWcAutopilot(btn) {
  wcAutopilotOn = !wcAutopilotOn;
  btn.textContent = wcAutopilotOn ? 'Autopilot ON' : 'Autopilot OFF';
  btn.className = wcAutopilotOn ? 'wc-autopilot-btn on' : 'wc-autopilot-btn';
}

// ══════════════════════════════════════════════════════════════════════════════
// MARGIN BRIDGE — Cost-to-Price Transmission Engine
// ══════════════════════════════════════════════════════════════════════════════
function renderMarginBridge() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">Margin Bridge</div>
        <div class="page-sub">Cost-to-price transmission · Commodity spike → pricing impact simulation · PriceOS integration layer</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost">⬇ Export Analysis</button>
        <button class="btn btn-primary" onclick="showModule('pricing-os',document.getElementById('nav-pricing-os'))">⚡ Send to PriceOS →</button>
      </div>
    </div>

    <!-- Concept Banner — glass-liquid on dark surface -->
    <div class="glass-stage" style="margin-bottom:20px">
      <div style="background:linear-gradient(135deg,var(--ink) 0%,#1A3835 60%,#0D2E2B 100%);border-radius:var(--r16);padding:28px 32px;position:relative;overflow:hidden;border:1px solid var(--border-m);box-shadow:0 8px 32px rgba(0,0,0,0.35),inset 0 1px 0 rgba(255,255,255,0.1)">
        <div style="position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(13,148,136,.18) 0%,transparent 70%);pointer-events:none"></div>
        <div style="position:relative;z-index:1">
          <div style="font-size:11px;color:var(--teal-xl);font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">Integration Layer · Nervure ↔ PriceOS</div>
          <div style="font-size:22px;font-weight:800;color:white;line-height:1.2;margin-bottom:10px;letter-spacing:-.02em">
            When commodity costs spike, <span style="color:var(--teal-xl)">how much can you pass through</span> without losing volume?
          </div>
          <div style="font-size:13.5px;color:rgba(255,255,255,.6);max-width:600px;line-height:1.65;">
            Nervure detects a +18% Ethylene futures move. Margin Bridge automatically queries PriceOS's causal elasticity model to calculate the maximum price pass-through rate before volume cliff — giving you the answer before your competitor's pricing team even opens Excel.
          </div>
          <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
            ${[
              ['rgba(255,255,255,.07)','rgba(255,255,255,.12)','white','+18%','Ethylene Spike'],
              ['rgba(255,255,255,.07)','rgba(255,255,255,.12)','var(--teal-xl)','+£4.8M','COGS Pressure'],
              ['rgba(13,148,136,.15)','rgba(13,148,136,.3)','var(--teal-xl)','+4.2% max','Safe Pass-Through'],
              ['rgba(245,158,11,.1)','rgba(245,158,11,.25)','var(--amber)','−1.8%','Residual Margin Gap'],
            ].map(([bg,border,col,val,lbl],i) => `
              ${i>0?'<div style="display:flex;align-items:center;color:'+(i===3?'var(--amber)':'var(--teal-xl)')+';font-size:22px">→</div>':''}
              <div class="glass-liquid" style="background:${bg};border-color:${border};padding:12px 18px;text-align:center;min-width:130px">
                <div style="font-size:22px;font-weight:800;color:${col}">${val}</div>
                <div style="font-size:10px;color:rgba(255,255,255,.45);letter-spacing:.06em;font-weight:700;margin-top:4px">${lbl}</div>
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Row — glass-lift on light surface -->
    <div class="g4" style="margin-bottom:16px">
      <div class="kpi glass-lift" style="--kpi-accent:var(--red)">
        <div class="kpi-label">Active Cost Shocks</div>
        <div class="kpi-val" style="color:var(--red)">3</div>
        <div class="kpi-delta down">Ethylene, SMP, Propylene</div>
        <div class="kpi-sub">Requiring pass-through analysis</div>
      </div>
      <div class="kpi glass-lift" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Max Safe Pass-Through</div>
        <div class="kpi-val" style="color:var(--teal)">4.2%</div>
        <div class="kpi-delta neutral">Avg across portfolio</div>
        <div class="kpi-sub">Before elasticity cliff</div>
      </div>
      <div class="kpi glass-lift" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Residual Gap (unrecovered)</div>
        <div class="kpi-val" style="color:var(--amber)">£1.8M</div>
        <div class="kpi-delta down">Cannot pass to consumer</div>
        <div class="kpi-sub">Must absorb via efficiency</div>
      </div>
      <div class="kpi glass-lift profit-lift" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Protected via Hedges</div>
        <div class="kpi-val" style="color:var(--green)">£3.1M</div>
        <div class="kpi-delta up">77% of shock absorbed</div>
        <div class="kpi-sub">Nervure hedge coverage</div>
      </div>
    </div>

    <!-- Transmission Table -->
    <div class="card glass-lift" style="margin-bottom:16px;overflow:hidden">
      <div class="card-header">
        <div class="card-title">Cost-to-Price Transmission Matrix</div>
        <div class="card-sub">Live commodity shocks × PriceOS elasticity model × recommended pricing action · Updated on every Nervure signal</div>
      </div>
      <div id="mb-table-root"></div>
    </div>

    <!-- Two-col detail -->
    <div class="g2">
      <div class="card glass-lift" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Elasticity Guardrails</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:18px">PriceOS causal model thresholds — safe pricing corridor per SKU cluster</div>
        <div id="mb-guardrails"></div>
      </div>
      <div class="card glass-lift" style="padding:22px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Pass-Through Waterfall</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:18px">How Nervure hedging reduces the pricing burden on the consumer</div>
        <div style="position:relative;height:220px;width:100%;"><canvas id="mb-waterfall"></canvas></div>
      </div>
    </div>

    <!-- Integration Status -->
    <div class="card glass-lift" style="margin-top:16px;padding:22px;border:1px solid rgba(13,148,136,.2);background:var(--teal-glow-s)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="width:36px;height:36px;border-radius:8px;background:var(--teal-glow);border:1px solid var(--border-m);display:flex;align-items:center;justify-content:center;font-size:18px">🔗</div>
        <div>
          <div style="font-size:15px;font-weight:700">PriceOS Integration Status</div>
          <div style="font-size:12px;color:var(--ink-soft)">Configure the bidirectional data pipeline between Nervure and PriceOS</div>
        </div>
        <span class="badge badge-amber" style="margin-left:auto">NOT YET CONNECTED</span>
      </div>
      <div class="g3">
        ${[
          ['Nervure → PriceOS','Commodity cost signals, COGS floor, hedge coverage ratio','Awaiting API key'],
          ['PriceOS → Nervure','Elasticity thresholds, pricing decisions, volume risk flags','Awaiting API key'],
          ['Shared Compliance Trail','EU AI Act decision log shared across both systems','Planned · Q2 2026'],
        ].map(([t,d,s]) => `
          <div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r10)">
            <div style="font-size:12.5px;font-weight:700;margin-bottom:4px">${t}</div>
            <div style="font-size:11.5px;color:var(--ink-soft);line-height:1.5;margin-bottom:10px">${d}</div>
            <span class="badge badge-amber" style="font-size:9px">${s}</span>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function buildMarginBridge() {
  // Merge hardcoded baseline with live hedge updates from NS state
  const _baseRows = [
    { id:'eth',  comm:'Ethylene',       shock:'+18.2%', cogs:'+£4.8M', hedge:'82%', residual:'+£0.86M', elasticity:'−2.1 (Med)', maxPass:'+4.2%', action:'Price +3.8% on Dettol 500ml lines',              status:'EXECUTE', statusC:'var(--green)' },
    { id:'nfdm', comm:'Skim Milk Powder',shock:'+11.4%',cogs:'+£2.1M', hedge:'68%', residual:'+£0.67M', elasticity:'−1.8 (Low)', maxPass:'+5.1%', action:'Price +4.5% on dairy SKUs',                      status:'EXECUTE', statusC:'var(--green)' },
    { id:'prop', comm:'Propylene',      shock:'+8.7%',  cogs:'+£1.4M', hedge:'24%', residual:'+£1.06M', elasticity:'−3.2 (High)',maxPass:'+1.9%', action:'Absorb via pack-size re-arch. Do not pass.',     status:'ABSORB',  statusC:'var(--red)'   },
    { id:'cs',   comm:'Caustic Soda',   shock:'+5.2%',  cogs:'+£0.9M', hedge:'91%', residual:'+£0.08M', elasticity:'−2.4 (Med)', maxPass:'+3.1%', action:'Pass-through not required — hedge sufficient', status:'HEDGED',  statusC:'var(--teal)'  },
  ];
  // Apply live hedge data from Hedging Engine if available
  const rows = _baseRows.map(r => {
    const liveHedge = (NS.hedgePositions || {})[r.id];
    const mbUpdate = (NS.marginBridgeUpdates || {})[r.id];
    if (liveHedge) {
      return { ...r,
        hedge: liveHedge.coverage + '%',
        residual: mbUpdate ? mbUpdate.residual : r.residual,
        status: mbUpdate ? mbUpdate.status : (liveHedge.coverage >= 80 ? 'HEDGED' : r.status),
        statusC: liveHedge.coverage >= 80 ? 'var(--teal)' : liveHedge.coverage >= 60 ? 'var(--green)' : r.statusC,
        action: liveHedge.coverage >= 80 ? 'Hedge coverage sufficient — minimal pass-through required' :
                r.action + ' (hedge updated ' + new Date(liveHedge.ts).toLocaleTimeString() + ')'
      };
    }
    return r;
  });
  // Show live data banner if we have hedge state
  const mbEl = document.getElementById('mb-table-root');
  const hasLiveData = Object.keys(NS.hedgePositions || {}).length > 0;
  if (hasLiveData && mbEl) {
    const banner = document.createElement('div');
    banner.style.cssText = 'padding:10px 20px;background:rgba(13,148,136,.06);border-bottom:1px solid rgba(13,148,136,.15);font-size:11.5px;color:var(--teal);display:flex;align-items:center;gap:8px';
    banner.innerHTML = '<span>📡</span><span><strong>Live data:</strong> Hedge coverage updated from Hedging Engine · ' + new Date().toLocaleTimeString() + '</span>';
    mbEl.insertAdjacentElement('beforebegin', banner);
  }

  const el = document.getElementById('mb-table-root');
  if (!el) return;

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:110px 80px 80px 60px 90px 110px 80px 1fr 90px;padding:10px 20px;background:var(--surface-alt);border-bottom:1px solid var(--border)">
      ${['Commodity','Shock','COGS Hit','Hedged','Residual','Elasticity (PriceOS)','Max Pass','Recommended Action','Status'].map(h=>`<span style="font-size:9.5px;font-weight:700;color:var(--ink-faint);letter-spacing:.08em;text-transform:uppercase">${h}</span>`).join('')}
    </div>
    ${rows.map(r=>`
    <div style="display:grid;grid-template-columns:110px 80px 80px 60px 90px 110px 80px 1fr 90px;padding:14px 20px;border-bottom:1px solid var(--border-s);transition:var(--transition)"
         onmouseenter="this.style.background='var(--teal-glow-s)'" onmouseleave="this.style.background=''">
      <div style="font-weight:700;font-size:13px">${r.comm}</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;color:var(--red);font-weight:700">${r.shock}</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;color:var(--amber);font-weight:600">${r.cogs}</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;color:var(--green);font-weight:600">${r.hedge}</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;color:var(--ink-mid);font-weight:600">${r.residual}</div>
      <div style="font-size:12px;color:var(--ink-soft)">${r.elasticity}</div>
      <div style="font-family:'JetBrains Mono';font-size:13px;color:var(--teal);font-weight:700">${r.maxPass}</div>
      <div style="font-size:12px;color:var(--ink-soft);line-height:1.4">${r.action}</div>
      <span class="badge" style="background:${r.statusC}15;color:${r.statusC};border:1px solid ${r.statusC}40;font-size:9px;align-self:center">${r.status}</span>
    </div>`).join('')}`;

  const gEl = document.getElementById('mb-guardrails');
  if (gEl) {
    const skus = [
      { name:'Dettol 500ml — NA',  floor:'$10.20', ceil:'$14.80', current:'$12.40', safe:true  },
      { name:'Dettol 1L — KSA',    floor:'$18.40', ceil:'$26.00', current:'$19.80', safe:true  },
      { name:'Harpic 500ml — EA',  floor:'$8.60',  ceil:'$12.00', current:'$11.90', safe:false },
      { name:'Harpic 1L — UAE',    floor:'$14.20', ceil:'$19.50', current:'$14.50', safe:true  },
    ];
    gEl.innerHTML = skus.map(s => {
      const pct = Math.round(
        (parseFloat(s.current.replace('$','')) - parseFloat(s.floor.replace('$',''))) /
        (parseFloat(s.ceil.replace('$',''))   - parseFloat(s.floor.replace('$',''))) * 100
      );
      return `
      <div style="padding:10px 0;border-bottom:1px solid var(--border-s)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-size:12.5px;font-weight:600">${s.name}</div>
          <span class="badge ${s.safe?'badge-buy':'badge-amber'}">${s.safe?'In corridor':'Near ceiling'}</span>
        </div>
        <div style="position:relative;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
          <div style="position:absolute;inset:0;background:rgba(13,148,136,.1);border-radius:3px"></div>
          <div style="position:absolute;left:0;top:0;width:${pct}%;height:100%;background:${s.safe?'var(--teal)':'var(--amber)'};border-radius:3px;transition:width .8s ease"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:4px;font-family:'JetBrains Mono';font-size:10px;color:var(--ink-faint)">
          <span>Floor ${s.floor}</span><span>Current ${s.current}</span><span>Ceil ${s.ceil}</span>
        </div>
      </div>`;
    }).join('');
  }

  const wCanvas = document.getElementById('mb-waterfall');
  if (wCanvas && window.Chart) {
    new Chart(wCanvas, {
      type:'bar',
      data:{
        labels:['Commodity Shock','Hedge Absorption','Residual Exposure','Price Pass-Through','Net Margin Impact'],
        datasets:[{
          data:[8.7,-5.8,2.9,-2.1,0.8],
          backgroundColor:['rgba(239,68,68,.75)','rgba(16,185,129,.75)','rgba(245,158,11,.75)','rgba(13,148,136,.75)','rgba(239,68,68,.75)'],
          borderRadius:5,borderSkipped:false,
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:'#0A1A18',titleColor:'rgba(255,255,255,.8)',
            bodyColor:'rgba(255,255,255,.6)',padding:10,
            callbacks:{label:ctx=>`${ctx.raw>0?'+':''}${ctx.raw}% margin impact`}
          }
        },
        scales:{
          x:{grid:{display:false},ticks:{color:'var(--ink-soft)',font:{size:10},maxRotation:0}},
          y:{grid:{color:'rgba(13,148,136,.08)'},ticks:{color:'var(--ink-faint)',font:{size:10},callback:v=>`${v>0?'+':''}${v}%`}}
        }
      }
    });
  }
}
document.addEventListener('DOMContentLoaded', () => {
  buildSidebar();
  showModule('dashboard', document.getElementById('nav-dashboard'));

  /* ── SIDEBAR HOVER EXPAND / COLLAPSE ─────────────────────────────────── */
  const sb = document.getElementById('sidebar');
  let collapseTimer = null;

  function expandSidebar() {
    clearTimeout(collapseTimer);
    sb.classList.add('sb-expanded');
  }

  function collapseSidebar() {
    clearTimeout(collapseTimer);
    collapseTimer = setTimeout(() => {
      sb.classList.remove('sb-expanded');
    }, 100); // 100ms jitter guard
  }

  sb.addEventListener('mouseenter', expandSidebar);
  sb.addEventListener('mouseleave', collapseSidebar);
  // Mobile/touch: tap sidebar icon to toggle
  sb.addEventListener('click', (e) => {
    if (!sb.classList.contains('sb-expanded')) {
      // If collapsed, clicking anywhere expands it
      if (!e.target.closest('.nav-item') && !e.target.closest('.nav-sub-item')) {
        expandSidebar();
        return;
      }
    }
  });
  // Touch: touchstart expands, touchend outside collapses
  document.addEventListener('touchstart', (e) => {
    if (!sb.contains(e.target)) {
      collapseSidebar();
    }
  }, { passive: true });

  /* ── COLLAPSED TOOLTIPS for nav items ────────────────────────────────── */
  const tooltip = document.createElement('div');
  tooltip.className = 'nav-tooltip';
  document.body.appendChild(tooltip);

  let tooltipTimer = null;

  function showTooltip(el, text) {
    if (sb.classList.contains('sb-expanded')) return;
    clearTimeout(tooltipTimer);
    const rect = el.getBoundingClientRect();
    tooltip.textContent = text;
    tooltip.style.top = (rect.top + rect.height / 2 - 14) + 'px';
    tooltip.classList.add('visible');
  }

  function hideTooltip() {
    tooltip.classList.remove('visible');
  }

  document.querySelectorAll('.nav-item, .nav-sub-item').forEach(item => {
    const label = item.querySelector('.nav-label');
    if (!label) return;
    item.addEventListener('mouseenter', () => showTooltip(item, label.textContent.trim()));
    item.addEventListener('mouseleave', hideTooltip);
    item.addEventListener('click', hideTooltip);
  });
});

// ══════════════════════════════════════════════════════════════════════════════
// NERVURE v5 — AGENTIC ENGINE
// Real state persistence · Connected modules · Human approval gates
// ══════════════════════════════════════════════════════════════════════════════

// ── PERSISTENT STATE ─────────────────────────────────────────────────────────
const STATE_KEY = 'nervure_v5_state';
let NS = {
  auditLog: [],
  approvedActions: [],
  hedgePositions: {},        // commodity_id → { volume, horizon, approved, ts }
  elasticityCache: {},       // sku_id → { elasticity, confidence, method, ts }
  promoDecomp: {},           // sku_id → { baseline, promoLift, wasted }
  appliedPrices: {},         // sku_id → { price, change, ts, reason }
  commodityOverrides: {},    // commodity_id → user_coverage_override
  scenarioResults: null,
  lastOracleRun: null,
};

function saveState() {
  try { localStorage.setItem(STATE_KEY, JSON.stringify(NS)); } catch(e) {}
}
function loadState() {
  try {
    const s = localStorage.getItem(STATE_KEY);
    if (s) NS = { ...NS, ...JSON.parse(s) };
  } catch(e) {}
}
loadState();

function logAudit(action, detail, type = 'info', value = null) {
  const entry = {
    ts: Date.now(), time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'}),
    action, detail, type, value
  };
  NS.auditLog.unshift(entry);
  if (NS.auditLog.length > 200) NS.auditLog = NS.auditLog.slice(0, 200);
  saveState();
  updateAuditBadge();
}

function updateAuditBadge() {
  const el = document.getElementById('audit-badge');
  if (el) el.textContent = NS.auditLog.length;
}

// ── AGENT STATUS BAR ─────────────────────────────────────────────────────────
let agentStatusTimer = null;
function showAgentStatus(msg, duration = 4000) {
  const bar = document.getElementById('agent-status-bar');
  const txt = document.getElementById('agent-status-text');
  if (!bar || !txt) return;
  txt.textContent = msg;
  bar.classList.add('visible');
  clearTimeout(agentStatusTimer);
  agentStatusTimer = setTimeout(() => bar.classList.remove('visible'), duration);
}

// ── APPROVAL MODAL ────────────────────────────────────────────────────────────
let pendingApproval = null;
function requestApproval(action) {
  // action: { title, detail, impact, commodity, sku, execute: fn }
  pendingApproval = action;
  const overlay = document.getElementById('approval-modal-overlay');
  document.getElementById('approval-modal-content').innerHTML = `
    <div style="display:flex;gap:16px;margin-top:12px">
      <div style="flex:1">
        <div style="font-size:11px;font-weight:700;color:var(--ink-faint);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Action</div>
        <div style="font-size:13px;font-weight:700">${action.title}</div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--ink-faint);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">P&L Impact</div>
        <div style="font-family:'JetBrains Mono';font-size:15px;font-weight:800;color:var(--amber)">${action.impact}</div>
      </div>
    </div>`;
  document.getElementById('approval-modal-body').innerHTML = `
    <div style="font-size:12px;color:var(--ink-soft);line-height:1.6;margin-bottom:14px">${action.detail}</div>
    <div style="background:var(--red-bg);border:1px solid rgba(239,68,68,.2);border-radius:var(--r10);padding:12px 14px">
      <div style="font-size:11.5px;font-weight:700;color:var(--red);margin-bottom:4px">⛔ Guardrail Triggered</div>
      <div style="font-size:11.5px;color:var(--ink-soft)">Impact exceeds £750K single-action threshold. Policy requires VP Finance approval. This action will be logged in the IFRS 9 audit trail.</div>
    </div>`;
  overlay.classList.add('open');
  logAudit('GUARDRAIL TRIGGERED', `${action.title} · ${action.impact} · Awaiting approval`, 'warning', action.impact);
}
function closeApprovalModal(e) {
  if (!e || e.target === document.getElementById('approval-modal-overlay')) {
    document.getElementById('approval-modal-overlay').classList.remove('open');
  }
}
function approveAction() {
  if (!pendingApproval) return;
  document.getElementById('approval-modal-overlay').classList.remove('open');
  NS.approvedActions.push({ ...pendingApproval, approvedAt: Date.now() });
  logAudit('ACTION APPROVED', `${pendingApproval.title} · ${pendingApproval.impact} · VP Finance signed`, 'success', pendingApproval.impact);
  showAgentStatus(`✓ Action approved: ${pendingApproval.title}`, 5000);
  if (pendingApproval.execute) pendingApproval.execute();
  saveState();
  pendingApproval = null;
}
function rejectApproval() {
  if (!pendingApproval) return;
  document.getElementById('approval-modal-overlay').classList.remove('open');
  logAudit('ACTION REJECTED', `${pendingApproval.title} · Rejected by user`, 'error');
  showAgentStatus(`⛔ Action rejected: ${pendingApproval.title}`, 4000);
  pendingApproval = null;
}

// ══════════════════════════════════════════════════════════════════════════════
// MODULE: HEDGING DECISION ENGINE (CNC-style)
// €0.8–1.0M savings per commodity pair per year
// ══════════════════════════════════════════════════════════════════════════════
const HEDGE_MODEL_DATA = {
  eth: {
    name: 'Ethylene', region: 'EU', unit: 'USD/ton',
    currentPrice: 1175, futuresCurve: [1182, 1195, 1208, 1219, 1228, 1235],
    historicalVol: 0.18, currentCoverage: 78, reckittCovTarget: 85,
    annualSpend: 28.4, riskFreeRate: 0.045,
    signals: { momentum: 0.72, satelliteConfirm: true, aisRisk: 'HIGH', weatherImpact: 0.12 },
    modelOutput: null
  },
  palm: {
    name: 'Palm Oil', region: 'MY', unit: 'USD/MT',
    currentPrice: 4120, futuresCurve: [4080, 4050, 4030, 4020, 4015, 4010],
    historicalVol: 0.22, currentCoverage: 71, reckittCovTarget: 75,
    annualSpend: 41.2, riskFreeRate: 0.045,
    signals: { momentum: -0.34, satelliteConfirm: true, aisRisk: 'LOW', weatherImpact: -0.08 },
    modelOutput: null
  },
  nfdm: {
    name: 'NFDM', region: 'US', unit: 'USD/lb',
    currentPrice: 1.19, futuresCurve: [1.21, 1.23, 1.24, 1.24, 1.23, 1.22],
    historicalVol: 0.14, currentCoverage: 82, reckittCovTarget: 80,
    annualSpend: 26.0, riskFreeRate: 0.045,
    signals: { momentum: 0.21, satelliteConfirm: false, aisRisk: 'LOW', weatherImpact: 0.03 },
    modelOutput: null
  },
  prop: {
    name: 'Propylene', region: 'EU', unit: 'USD/ton',
    currentPrice: 890, futuresCurve: [870, 855, 845, 840, 838, 840],
    historicalVol: 0.25, currentCoverage: 45, reckittCovTarget: 55,
    annualSpend: 19.6, riskFreeRate: 0.045,
    signals: { momentum: -0.61, satelliteConfirm: false, aisRisk: 'MED', weatherImpact: 0 },
    modelOutput: null
  }
};

function computeHedgeRecommendation(commId) {
  const d = HEDGE_MODEL_DATA[commId];
  if (!d) return null;

  const months = d.futuresCurve.length;
  const contango = d.futuresCurve[months-1] > d.currentPrice;
  const backwardation = d.futuresCurve[months-1] < d.currentPrice;
  
  // Simple Black-Scholes-inspired hedge recommendation
  // Signal composite
  const sigScore = d.signals.momentum * 0.4 + (d.signals.satelliteConfirm ? 0.25 : -0.1) + 
                   (d.signals.aisRisk === 'HIGH' ? 0.2 : d.signals.aisRisk === 'MED' ? 0.05 : -0.05) +
                   d.signals.weatherImpact * 0.5;

  // Recommended coverage based on signal + risk appetite
  let recCoverage, action, rationale, confidence;
  if (sigScore > 0.3) {
    recCoverage = Math.min(90, d.currentCoverage + Math.round(sigScore * 15));
    action = 'BUY';
    rationale = 'Bullish signal composite. Futures in contango with positive momentum — increase hedge coverage before price move.';
    confidence = Math.round(65 + sigScore * 25);
  } else if (sigScore < -0.2) {
    recCoverage = Math.max(40, d.currentCoverage + Math.round(sigScore * 12));
    action = 'REDUCE';
    rationale = 'Bearish signal composite. Futures in backwardation — reduce exposure, let spot price correct.';
    confidence = Math.round(65 + Math.abs(sigScore) * 20);
  } else {
    recCoverage = d.reckittCovTarget;
    action = 'HOLD';
    rationale = 'Mixed signals. Maintain current coverage near target. Monitor for 48h.';
    confidence = 72;
  }

  // Volume recommendation in £M
  const coverageDelta = recCoverage - d.currentCoverage;
  const volumeChange = (d.annualSpend * Math.abs(coverageDelta) / 100).toFixed(1);
  
  // Mark-to-market estimate
  const priceDelta = d.futuresCurve[2] - d.currentPrice; // 3-month forward
  const m2m = (d.annualSpend * d.currentCoverage / 100 * priceDelta / d.currentPrice).toFixed(2);
  
  // Optimal horizon (find highest futures price if BUY, lowest if REDUCE)
  const optimalMonth = action === 'BUY' 
    ? d.futuresCurve.indexOf(Math.max(...d.futuresCurve)) + 1
    : d.futuresCurve.indexOf(Math.min(...d.futuresCurve)) + 1;

  // Annual saving estimate
  const annualSaving = action === 'BUY'
    ? (d.annualSpend * coverageDelta / 100 * 0.08).toFixed(1) // assume 8% price protection
    : (d.annualSpend * Math.abs(coverageDelta) / 100 * 0.05).toFixed(1);

  d.modelOutput = { recCoverage, action, rationale, confidence, volumeChange, m2m, optimalMonth, annualSaving, sigScore };
  return d.modelOutput;
}

// Render Hedging Engine

// ══════════════════════════════════════════════════════════════════════════════
// VERIDIAN — HEDGING ENGINE (Embedded in NERVURE)
// Full CNC Oracle · Scoring Profiles · Commodity DNA · Scenario Engine
// Signal Lab · Behavioral Intelligence · Synthetic Hedge Constructor
// Future Vision 2046 Module
// © Sandip Dixit — NERVURE Platform
// ══════════════════════════════════════════════════════════════════════════════

const VERIDIAN_COMMODITIES = [
  {id:'eth',name:'Ethylene',region:'EU',price:1175,unit:'USD/ton',cov:78,signal:'BUY',chg:+2.3,m2m:+1.07,conf:87,spend:28.4,cat:'Petrochem',priority:9.2,
   history:[1120,1173,1165,1190,1283,1273,1273,1340,1435,1665,1595,1595,1495,1425,1305,1260,1295,1270]},
  {id:'nfdm',name:'NFDM',region:'US',price:1.19,unit:'USD/lb',cov:82,signal:'BUY',chg:-1.1,m2m:+0.78,conf:91,spend:26.0,cat:'Dairy',priority:8.1,
   history:[0.85,0.91,0.95,0.97,1.00,1.07,1.12,1.12,1.16,1.19,1.19,1.22,1.22,1.23,1.25,1.25,1.26,1.28]},
  {id:'wmp',name:'WMP',region:'EU',price:3230,unit:'USD/MT',cov:65,signal:'HOLD',chg:+0.4,m2m:+0.96,conf:74,spend:22.8,cat:'Dairy',priority:7.4,
   history:[2608,2678,2735,2940,3003,3170,3175,3222,3267,3268,3295,3313,3350,3435,3520,3533,3567,3608]},
  {id:'smp',name:'SMP NZ',region:'NZ',price:2787,unit:'USD/MT',cov:54,signal:'BUY',chg:+5.2,m2m:+0.47,conf:68,spend:6.2,cat:'Dairy',priority:6.8,
   history:[2502,2601,2628,2685,2730,2763,2800,2815,2830,2838,2850,2910,2990,3018,3058,3063,3285,3395]},
  {id:'palm',name:'Palm Oil',region:'MY',price:4120,unit:'USD/MT',cov:71,signal:'HOLD',chg:-3.4,m2m:+1.34,conf:82,spend:41.2,cat:'Veg Oil',priority:8.7,
   history:[3200,3350,3520,3680,3850,3950,4000,4050,4100,4120,4150,4200,4250,4300,4350,4400,4450,4500]},
  {id:'prop',name:'Propylene',region:'EU',price:890,unit:'USD/ton',cov:45,signal:'SELL',chg:-6.1,m2m:-0.23,conf:79,spend:19.6,cat:'Petrochem',priority:5.3,
   history:[750,780,800,830,850,860,880,890,900,910,930,950,970,980,990,1000,1010,1020]},
];

const VERIDIAN_SIGNALS = [
  {type:'SATELLITE',icon:'🛰',text:'Crop density index for Malaysian palm plantations −8% MoM. Pre-emptive hedge window: 24–72hrs before market reprices.',comm:'Palm Oil',impact:'HIGH',dir:'up',age:'2h ago'},
  {type:'AIS SHIPPING',icon:'🚢',text:'Red Sea container diversions +34% WoW. Ethylene spot premium expected +8–12% within 5 trading days.',comm:'Ethylene',impact:'HIGH',dir:'up',age:'3h ago'},
  {type:'WEATHER',icon:'🌦',text:'La Niña weakening over NZ — Fonterra crop revision expected. WMP forward curve may soften 4–6%.',comm:'WMP',impact:'MED',dir:'down',age:'5h ago'},
  {type:'CENTRAL BANK',icon:'🏛',text:'ECB hold confirmed. EUR/USD stable. No FX impact on EUR-denominated dairy hedges.',comm:'All Dairy',impact:'LOW',dir:'neutral',age:'6h ago'},
  {type:'PROXY HEDGE',icon:'🔗',text:'Naphtha-Propylene spread at 10yr low. Synthetic hedge via Naphtha futures is 37% more efficient than direct Propylene OTC.',comm:'Propylene',impact:'HIGH',dir:'up',age:'8h ago'},
  {type:'CARBON CBAM',icon:'🌿',text:'EU CBAM carbon premium for Ethylene imports from non-EU: +€28/ton. Factor into synthetic routing.',comm:'Ethylene',impact:'MED',dir:'up',age:'1d ago'},
];

const VD_STATE = { tab:'dashboard', cncComm:'eth', bw:12, fcstart:150, decay:10, fcPct:70, scenario:0, scenarioIntensity:55 };
let vdCharts = {};
let vdOracleRan = false;

function destroyVdChart(k) { if(vdCharts[k]){vdCharts[k].destroy();delete vdCharts[k];} }

// ── RENDER ─────────────────────────────────────────────────────────────────
function renderHedgingEngine() {
  return `
  <div class="animate-in" id="veridian-root">
    <!-- VERIDIAN HEADER -->
    <div style="background:linear-gradient(135deg,#0C1A17 0%,#1A3835 50%,#0D2E2B 100%);border-radius:16px;padding:22px 28px;margin-bottom:20px;position:relative;overflow:hidden">
      <div style="position:absolute;top:-60px;right:-60px;width:240px;height:240px;background:radial-gradient(circle,rgba(13,148,136,.22) 0%,transparent 70%);pointer-events:none"></div>
      <div style="position:relative;z-index:1;display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <svg width="28" height="28" viewBox="0 0 38 38" fill="none"><defs><linearGradient id="vdG" x1="0" y1="0" x2="38" y2="38" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#0D9488"/><stop offset="100%" stop-color="#5EEAD4"/></linearGradient></defs><rect width="38" height="38" rx="9" fill="url(#vdG)" opacity="0.2"/><path d="M19 7 C19 7 19 18 19 31" stroke="#5EEAD4" stroke-width="1.5" stroke-linecap="round"/><path d="M19 13 C15 13 10 11 8 8" stroke="#14B8A6" stroke-width="1.4" stroke-linecap="round"/><path d="M19 13 C23 13 28 11 30 8" stroke="#14B8A6" stroke-width="1.4" stroke-linecap="round"/><path d="M19 19 C15 19 9 18 7 16" stroke="#0D9488" stroke-width="1.2" stroke-linecap="round"/><path d="M19 19 C23 19 29 18 31 16" stroke="#0D9488" stroke-width="1.2" stroke-linecap="round"/><circle cx="19" cy="19" r="3" fill="#D4AF37"/><circle cx="19" cy="19" r="1.5" fill="#FFFFFF" opacity="0.9"/></svg>
            <span style="font-size:11px;color:#5EEAD4;font-weight:700;letter-spacing:.14em;text-transform:uppercase">Veridian · Hedging Intelligence</span>
            <span style="font-size:10px;background:rgba(16,185,129,.2);color:#34D399;border:1px solid rgba(16,185,129,.3);padding:2px 9px;border-radius:20px;font-weight:700">EMBEDDED IN NERVURE</span>
          </div>
          <div style="font-size:22px;font-weight:800;color:#fff;line-height:1.2;margin-bottom:5px">Veridian — Hedging Engine</div>
          <div style="font-size:12.5px;color:rgba(255,255,255,.42);line-height:1.6">CNC Oracle · Distribution + Forecast dual-model · Behavioral bias detection · IFRS 9 tested · Carbon CBAM overlay</div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-start;flex-shrink:0;margin-left:20px">
          <div style="text-align:center;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:11px 16px"><div style="font-size:20px;font-weight:800;color:#fff">84</div><div style="font-size:10px;color:rgba(255,255,255,.36);margin-top:2px;letter-spacing:.06em">HEALTH</div></div>
          <div style="text-align:center;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:11px 16px"><div style="font-size:20px;font-weight:800;color:#34D399">+£4.3M</div><div style="font-size:10px;color:rgba(255,255,255,.36);margin-top:2px;letter-spacing:.06em">YTD M2M</div></div>
          <div style="text-align:center;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:11px 16px"><div style="font-size:20px;font-weight:800;color:#fff">77%</div><div style="font-size:10px;color:rgba(255,255,255,.36);margin-top:2px;letter-spacing:.06em">AVG COV</div></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px;position:relative;z-index:1">
        <button class="btn btn-primary btn-sm" onclick="vdShowTab('oracle')">⚡ Run CNC Oracle</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('cnc')">⚙ CNC Parameters</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('profiles')">◎ Scoring Profiles</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('genome')">🧬 Commodity DNA</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('scenario')">◈ Scenarios</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('signals')">⊕ Signal Lab</button>
        <button class="btn btn-ghost btn-sm" onclick="vdShowTab('future')" style="border-color:rgba(212,175,55,.4);color:#D4AF37">🔮 Vision 2046</button>
      </div>
    </div>

    <!-- VD TAB BAR -->
    <div style="display:flex;gap:2px;background:var(--surface-alt);border-radius:10px;padding:3px;margin-bottom:18px;border:1px solid var(--border)">
      ${['dashboard','oracle','cnc','profiles','genome','scenario','signals','future'].map(t => {
        const labels = {dashboard:'⬡ Command',oracle:'⚡ CNC Oracle',cnc:'⚙ Parameters',profiles:'◎ Scoring',genome:'🧬 DNA',scenario:'◈ Scenarios',signals:'⊕ Signals',future:'🔮 2046'};
        return `<button onclick="vdShowTab('${t}')" id="vdtab-${t}" style="flex:1;padding:7px 8px;border-radius:8px;border:none;cursor:pointer;font-size:11.5px;font-weight:500;color:var(--ink-soft);background:transparent;transition:.18s;font-family:inherit" class="vd-tab-btn">${labels[t]}</button>`;
      }).join('')}
    </div>

    <!-- VD CONTENT PANES -->
    <div id="vd-pane-dashboard" class="vd-pane">
      ${vdRenderDashboard()}
    </div>
    <div id="vd-pane-oracle" class="vd-pane" style="display:none">
      ${vdRenderOracle()}
    </div>
    <div id="vd-pane-cnc" class="vd-pane" style="display:none">
      ${vdRenderCNC()}
    </div>
    <div id="vd-pane-profiles" class="vd-pane" style="display:none">
      ${vdRenderProfiles()}
    </div>
    <div id="vd-pane-genome" class="vd-pane" style="display:none">
      ${vdRenderGenome()}
    </div>
    <div id="vd-pane-scenario" class="vd-pane" style="display:none">
      ${vdRenderScenario()}
    </div>
    <div id="vd-pane-signals" class="vd-pane" style="display:none">
      ${vdRenderSignals()}
    </div>
    <div id="vd-pane-future" class="vd-pane" style="display:none">
      ${vdRenderFuture()}
    </div>

    <!-- COPYRIGHT -->
    <div style="text-align:center;padding:16px;font-size:11px;color:var(--ink-ghost);letter-spacing:.06em;border-top:1px solid var(--border);margin-top:20px">
      © Sandip Dixit · Veridian Hedging Intelligence · Embedded in NERVURE CPG Financial OS · Patent Pending
    </div>
  </div>`;
}

// ── DASHBOARD PANE ─────────────────────────────────────────────────────────
function vdRenderDashboard() {
  const sigClass = {BUY:'badge-success',HOLD:'badge-amber',SELL:'badge-warning'};
  const sigColors = {BUY:'var(--green)',HOLD:'var(--amber)',SELL:'var(--red)'};
  return `
  <div>
    <!-- KPI Strip -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
      ${[
        {l:'Total Hedged',v:'£144.2M',s:'6 commodities · 10 instruments',c:'var(--teal)',i:'◈'},
        {l:'M2M YTD',v:'+£4.39M',s:'77% of max possible capture',c:'var(--green)',i:'↑'},
        {l:'Decision Quality',v:'71%',s:'3 poor calls in 12 months',c:'var(--blue)',i:'⊕'},
        {l:'IFRS 9 Compliance',v:'97%',s:'Auto-tested daily · All hedges',c:'var(--purple)',i:'✓'}
      ].map(k=>`
        <div class="card" style="padding:16px 18px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:12px;color:var(--ink-soft);font-weight:500">${k.l}</div>
            <div style="width:26px;height:26px;border-radius:8px;background:${k.c}18;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${k.c}">${k.i}</div>
          </div>
          <div style="font-size:22px;font-weight:800;color:${k.c};line-height:1">${k.v}</div>
          <div style="font-size:11px;color:var(--ink-faint);margin-top:5px">${k.s}</div>
        </div>`).join('')}
    </div>

    <!-- Commodity Table + Signal Feed -->
    <div style="display:grid;grid-template-columns:1fr 320px;gap:14px;margin-bottom:16px">
      <!-- Table -->
      <div class="card" style="overflow:hidden">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px">
          <div><div class="card-title">Commodity Portfolio</div><div class="card-sub">Live coverage · CNC signals · M2M</div></div>
          <div style="display:flex;gap:4px;align-items:center">
            <div style="width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse-g 2s infinite"></div>
            <span style="font-size:11.5px;color:var(--green);font-weight:600">Live</span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:150px 90px 60px 78px 110px 70px;padding:8px 18px;background:var(--surface-alt);border-bottom:1px solid var(--border)">
          ${['Commodity','Price','Δ 24h','Signal','Coverage','M2M'].map(h=>`<span style="font-size:10.5px;color:var(--ink-faint);font-weight:700;letter-spacing:.07em;text-transform:uppercase">${h}</span>`).join('')}
        </div>
        ${VERIDIAN_COMMODITIES.map(c=>{
          const chgC = c.chg>0?'var(--green)':'var(--red)';
          const covC = c.cov>=75?'var(--green)':c.cov>=60?'var(--amber)':'var(--red)';
          const sigBg = {BUY:'rgba(16,185,129,.1)',HOLD:'rgba(245,158,11,.1)',SELL:'rgba(239,68,68,.1)'};
          const sigCol = {BUY:'var(--green)',HOLD:'var(--amber)',SELL:'var(--red)'};
          const pDisplay = c.price>10?c.price.toLocaleString():c.price;
          return `<div onclick="vdShowTab('oracle')" style="display:grid;grid-template-columns:150px 90px 60px 78px 110px 70px;padding:11px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:.15s" onmouseover="this.style.background='rgba(13,148,136,.04)'" onmouseout="this.style.background=''">
            <div><div style="font-weight:700;font-size:13px">${c.name}</div><div style="font-size:11px;color:var(--ink-soft)">${c.region} · ${c.cat}</div></div>
            <div><div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:600">${pDisplay}</div><div style="font-size:10.5px;color:var(--ink-faint)">${c.unit}</div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700;color:${chgC}">${c.chg>0?'+':''}${c.chg}%</div>
            <div><span style="background:${sigBg[c.signal]};color:${sigCol[c.signal]};border:1px solid ${sigCol[c.signal]}33;padding:3px 8px;border-radius:5px;font-size:11px;font-weight:700">${c.signal}</span></div>
            <div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:5px;background:var(--teal-dim);border-radius:3px;overflow:hidden"><div style="width:${c.cov}%;height:100%;background:${covC};border-radius:3px"></div></div><span style="font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:700;color:${covC}">${c.cov}%</span></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700;color:${c.m2m>0?'var(--green)':'var(--red)'}"> ${c.m2m>0?'+':''}£${Math.abs(c.m2m)}M</div>
          </div>`;
        }).join('')}
      </div>
      <!-- Signal Feed -->
      <div class="card" style="overflow:hidden;display:flex;flex-direction:column">
        <div class="card-header" style="padding:14px 18px"><div class="card-title">Live Signal Feed</div><div class="card-sub">50+ alt-data streams</div></div>
        <div style="flex:1;overflow:auto">
          ${VERIDIAN_SIGNALS.map(s=>{
            const iC = {HIGH:'var(--red)',MED:'var(--amber)',LOW:'var(--ink-faint)'}[s.impact];
            const dI = {up:'↑',down:'↓',neutral:'→'}[s.dir];
            const dC = {up:'var(--red)',down:'var(--green)',neutral:'var(--ink-faint)'}[s.dir];
            return `<div onclick="vdShowTab('signals')" style="padding:11px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:.15s" onmouseover="this.style.background='rgba(13,148,136,.04)'" onmouseout="this.style.background=''">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <div style="display:flex;align-items:center;gap:5px"><span>${s.icon}</span><span style="font-size:10px;font-weight:700;color:${iC};letter-spacing:.07em">${s.type}</span></div>
                <span style="font-size:13px;color:${dC};font-weight:700">${dI}</span>
              </div>
              <div style="font-size:12px;color:var(--ink-mid);line-height:1.5">${s.text.substring(0,90)}…</div>
            </div>`;
          }).join('')}
        </div>
        <div style="padding:10px 14px;border-top:1px solid var(--border)"><button onclick="vdShowTab('signals')" class="btn btn-ghost btn-sm" style="width:100%">View Signal Lab →</button></div>
      </div>
    </div>

    <!-- Trigger Windows -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div style="background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(13,148,136,.04));border:1px solid rgba(16,185,129,.3);border-radius:12px;padding:14px 16px;animation:hedge-pulse 2.5s infinite">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11.5px;font-weight:700;color:var(--green)">🟢 WINDOW OPEN</span><span style="font-size:11px;color:var(--ink-soft)">2h ago</span></div>
        <div style="font-size:14px;font-weight:800;margin-bottom:4px">Ethylene EU</div>
        <div style="font-size:12px;color:var(--ink-soft);line-height:1.5">Spot −3.8% in 4hrs. Distribution model recommends +9% coverage increase. Percentile 45→31.</div>
        <div style="display:flex;gap:6px;margin-top:10px"><button onclick="vdShowTab('oracle')" class="btn btn-primary btn-sm">Execute +9%</button><button class="btn btn-ghost btn-sm">Dismiss</button></div>
      </div>
      <div style="background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(13,148,136,.04));border:1px solid rgba(16,185,129,.3);border-radius:12px;padding:14px 16px;animation:hedge-pulse 2.5s infinite">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11.5px;font-weight:700;color:var(--green)">🟢 WINDOW OPEN</span><span style="font-size:11px;color:var(--ink-soft)">6h ago</span></div>
        <div style="font-size:14px;font-weight:800;margin-bottom:4px">Palm Oil MY</div>
        <div style="font-size:12px;color:var(--ink-soft);line-height:1.5">Satellite: 8% crop density decline. Spot yet to reprice — pre-emptive hedge window before market reacts.</div>
        <div style="display:flex;gap:6px;margin-top:10px"><button onclick="vdShowTab('oracle')" class="btn btn-primary btn-sm">Pre-Hedge</button><button class="btn btn-ghost btn-sm">Dismiss</button></div>
      </div>
      <div style="background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.2);border-radius:12px;padding:14px 16px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11.5px;font-weight:700;color:var(--red)">🔴 WINDOW CLOSED</span><span style="font-size:11px;color:var(--ink-soft)">1h ago</span></div>
        <div style="font-size:14px;font-weight:800;margin-bottom:4px">SMP NZ</div>
        <div style="font-size:12px;color:var(--ink-soft);line-height:1.5">Price rebounded +4.2%. Window open 6hrs. Missed potential: <span style="color:var(--red);font-weight:700">−£0.18M</span></div>
        <div style="margin-top:10px"><span style="font-size:11px;background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);padding:3px 9px;border-radius:5px;font-weight:600">Regret Logged</span></div>
      </div>
    </div>
  </div>`;
}

// ── ORACLE PANE ─────────────────────────────────────────────────────────────
function vdRenderOracle() {
  const recos = [
    {comm:'Ethylene EU',signal:'BUY',cov:78,reco:87,price:'1,175',unit:'USD/ton',m2m:'+£1.07M',pct:16.7,conf:87,why:'Spot at 16.7th percentile of 18-month history → strong BUY. Forecast +6.6% vs. spot → increases urgency. Combined CNC recommendation: 87% coverage.'},
    {comm:'NFDM US',signal:'BUY',cov:82,reco:85,price:'1.19',unit:'USD/lb',m2m:'+£0.78M',pct:37,conf:91,why:'Price at 37th percentile of 36-month history. Forecast stable +3.2%. Distribution 63%, Forecast 74%. Combined at 70/30: 85%.'},
    {comm:'Palm Oil MY',signal:'HOLD',cov:71,reco:71,price:'4,120',unit:'USD/MT',m2m:'+£1.34M',pct:62,conf:82,why:'Price at 62nd percentile — historically elevated. Satellite palm supply tightening counterbalances. HOLD at 71%.'},
    {comm:'SMP NZ',signal:'BUY',cov:54,reco:68,price:'2,787',unit:'USD/MT',m2m:'+£0.47M',pct:16,conf:68,why:'16th percentile — historically cheap. Forecast +12.3% urgency. Window open. Reco: 68%.'},
    {comm:'WMP EU',signal:'HOLD',cov:65,reco:65,price:'3,230',unit:'USD/MT',m2m:'+£0.96M',pct:52,conf:74,why:'52nd percentile — near historical median. La Niña weather uncertainty. HOLD current coverage.'},
    {comm:'Propylene EU',signal:'SELL',cov:45,reco:35,price:'890',unit:'USD/ton',m2m:'−£0.23M',pct:88,conf:79,why:'88th percentile — historically expensive. Forecast downward −6.1%. SELL/reduce to 35%.'},
  ];
  const sigC = {BUY:'var(--green)',HOLD:'var(--amber)',SELL:'var(--red)'};
  return `
  <div>
    <!-- Summary KPIs -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:18px">
      <div class="card" style="padding:16px 18px;border-top:3px solid var(--green)"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:6px">Expected M2M Uplift</div><div style="font-size:24px;font-weight:800;color:var(--green)">+£4.7M</div><div style="font-size:11.5px;color:var(--ink-faint)">vs no-change · 12-month</div></div>
      <div class="card" style="padding:16px 18px;border-top:3px solid var(--teal)"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:6px">Top Opportunity</div><div style="font-size:18px;font-weight:800">Ethylene EU</div><div style="font-size:11.5px;color:var(--ink-faint)">+£1.4M potential · Window open now</div></div>
      <div class="card" style="padding:16px 18px;border-top:3px solid var(--purple)"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:6px">Params Auto-Tuned</div><div style="font-size:24px;font-weight:800;color:var(--purple)">4 of 6</div><div style="font-size:11.5px;color:var(--ink-faint)">Avg M2M improvement +12.3%</div></div>
    </div>
    <!-- Reco Cards -->
    <div style="display:flex;flex-direction:column;gap:12px">
      ${recos.map(r=>`
        <div class="card" style="overflow:hidden">
          <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:15px;font-weight:800">${r.comm}</div><div style="font-size:12px;color:var(--ink-soft)">Current: <span style="font-family:'JetBrains Mono',monospace;font-weight:600">${r.price} ${r.unit}</span> · M2M: <span style="font-weight:600;color:${r.m2m.startsWith('+')?'var(--green)':'var(--red)'}">${r.m2m}</span></div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <span style="background:${sigC[r.signal]}18;color:${sigC[r.signal]};border:1px solid ${sigC[r.signal]}44;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:700">${r.signal}</span>
              <span style="font-size:12px;color:var(--ink-soft)">Confidence: <span style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--teal)">${r.conf}%</span></span>
            </div>
          </div>
          <div style="padding:14px 18px;display:flex;align-items:center;gap:24px">
            <div><div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:3px">Current</div><div style="font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800;color:var(--ink-mid)">${r.cov}%</div></div>
            <div style="font-size:18px;color:var(--ink-ghost)">→</div>
            <div><div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:3px">CNC Reco</div><div style="font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800;color:${sigC[r.signal]}">${r.reco}%</div></div>
            <div style="flex:1;max-width:200px">
              <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:5px">Historical Percentile: <b>${r.pct}%</b></div>
              <div style="height:6px;background:var(--teal-dim);border-radius:3px;position:relative">
                <div style="width:${r.pct}%;height:100%;background:${r.pct>70?'var(--red)':r.pct>40?'var(--amber)':'var(--teal)'};border-radius:3px"></div>
                <div style="position:absolute;top:-3px;left:${r.pct}%;width:2px;height:12px;background:var(--ink);border-radius:1px;transform:translateX(-50%)"></div>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--ink-ghost);margin-top:3px"><span>Cheap</span><span>Median</span><span>Expensive</span></div>
            </div>
            <div style="flex:1;font-size:12px;color:var(--ink-soft);line-height:1.6;padding:9px 12px;background:var(--surface-alt);border-radius:8px">${r.why}</div>
          </div>
        </div>`).join('')}
    </div>
    <!-- Behavioral Warning -->
    <div style="background:linear-gradient(90deg,rgba(13,148,136,.07),rgba(20,184,166,.04));border:1px solid rgba(13,148,136,.22);border-radius:12px;padding:13px 16px;display:flex;gap:10px;align-items:flex-start;margin-top:14px">
      <span style="font-size:17px">⚠️</span>
      <div><div style="font-size:12.5px;font-weight:700;color:var(--teal);margin-bottom:3px">Behavioral Warning — Ethylene</div><div style="font-size:12.5px;color:var(--ink-soft);line-height:1.6">AI detects anchoring to Jan 2025 price (1,050 USD/ton). Current spot +11.9%. Loss aversion bias likely suppressing buy signal. CNC still recommends +9% coverage increase.</div></div>
    </div>
  </div>`;
}

// ── CNC PARAMETER PANE ──────────────────────────────────────────────────────
function vdRenderCNC() {
  return `
  <div>
    <div style="background:linear-gradient(135deg,rgba(13,148,136,.07),rgba(59,130,246,.04));border:1px solid rgba(13,148,136,.2);border-radius:12px;padding:14px 16px;display:flex;gap:10px;margin-bottom:18px">
      <span style="font-size:17px">🧮</span>
      <div><div style="font-size:13px;font-weight:700;color:var(--teal)">Commodity Nerve Centre — Transparent Methodology</div><div style="font-size:12.5px;color:var(--ink-soft);line-height:1.55">Dual-approach: (1) Distribution-Based — historical percentile positioning, (2) Forecast-Based — FC Grid % change vs. spot. Final is a weighted blend of 4 tunable parameters. ION · Brady · AEGIS run black-box models. Veridian shows every parameter.</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Left: Parameters -->
      <div>
        <div style="font-size:14px;font-weight:700;margin-bottom:4px">⚙ Parameter Configuration</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">Select commodity, tune 4 CNC parameters. 340+ combinations back-tested. M2M-optimal set surfaced.</div>
        <!-- Commodity selector -->
        <div style="margin-bottom:14px">
          <div style="font-size:12px;font-weight:700;margin-bottom:8px;color:var(--ink)">Commodity</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap" id="vd-cnc-comms">
            ${VERIDIAN_COMMODITIES.map(c=>`<button onclick="vdSelectCNCComm('${c.id}')" id="vdcc-${c.id}" class="btn btn-sm ${c.id==='eth'?'btn-primary':'btn-ghost'}" style="font-size:11.5px">${c.name}</button>`).join('')}
          </div>
        </div>
        ${[
          {id:'window',label:'① Backward Looking Window',desc:'Months of historical spot prices in distribution. Larger=generalist, Smaller=reactive.',opts:['12 mo|12','18 mo|18','36 mo|36','54 mo|54'],sel:'12'},
          {id:'fcstart',label:'② FC Grid Start Value',desc:'Upper bound of forecast grid. Controls sensitivity to large price increases vs. spot.',opts:['50%|50','100%|100','150%|150'],sel:'150'},
          {id:'decay',label:'③ FC Grid Time Decay',desc:'Per-period reduction in forecast confidence. Higher=lower reliance on long-term forecasts.',opts:['7.5%|7.5','10%|10','15%|15','20%|20'],sel:'10'},
          {id:'fcpct',label:'④ Importance of FC Approach (P%)',desc:'Weight of Forecast vs. Distribution. P%=Forecast, (100−P%)=Distribution.',opts:['10%|10','30%|30','50%|50','70%|70','90%|90'],sel:'70'},
        ].map(p=>`
          <div style="background:var(--surface-alt);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px">
            <div style="font-size:12.5px;font-weight:700;color:var(--ink);margin-bottom:3px">${p.label}</div>
            <div style="font-size:12px;color:var(--ink-soft);margin-bottom:10px;line-height:1.5">${p.desc}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              ${p.opts.map(o=>{const[lbl,val]=o.split('|');return `<button onclick="vdSetParam('${p.id}',${val},this)" style="padding:5px 12px;border-radius:7px;border:1px solid var(--border);font-size:12px;font-weight:500;cursor:pointer;color:var(--ink-soft);background:var(--surface);transition:.15s" class="vd-param-btn ${val===p.sel?'active-param':''}" ${val===p.sel?'style="padding:5px 12px;border-radius:7px;border:1px solid var(--teal);font-size:12px;font-weight:600;cursor:pointer;color:white;background:var(--teal);transition:.15s"':''}">${lbl}</button>`;}).join('')}
            </div>
          </div>`).join('')}
      </div>
      <!-- Right: Live Calc -->
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div><div style="font-size:14px;font-weight:700">① Distribution Approach</div><div style="font-size:11.5px;color:var(--ink-soft)">Historical percentile → coverage reco</div></div>
            <span id="vd-dist-weight" style="font-size:11.5px;background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2);padding:3px 9px;border-radius:5px;font-weight:600">30% weight</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div style="background:var(--surface-alt);border-radius:10px;padding:12px"><div style="font-size:11px;color:var(--ink-soft);margin-bottom:3px">Future Price Position</div><div style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:800;color:var(--teal)" id="vd-dist-pct">16.7%</div><div style="font-size:11px;color:var(--ink-faint)">percentile in history</div></div>
            <div style="background:var(--teal-glow);border:1px solid var(--border-m);border-radius:10px;padding:12px"><div style="font-size:11px;color:var(--ink-soft);margin-bottom:3px">Distribution Reco</div><div style="font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800;color:var(--teal)" id="vd-dist-reco">83.3%</div></div>
          </div>
        </div>
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div><div style="font-size:14px;font-weight:700">② Forecast Approach</div><div style="font-size:11.5px;color:var(--ink-soft)">FC Grid lookup → coverage</div></div>
            <span id="vd-fc-weight" style="font-size:11.5px;background:rgba(13,148,136,.1);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:3px 9px;border-radius:5px;font-weight:600">70% weight</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
            <div style="background:var(--surface-alt);border-radius:10px;padding:12px"><div style="font-size:11px;color:var(--ink-soft);margin-bottom:3px">Forecast Reco (M+3)</div><div style="font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800;color:var(--teal)" id="vd-fc-reco">54%</div></div>
            <div style="background:var(--surface-alt);border-radius:10px;padding:12px"><div style="font-size:11px;color:var(--ink-soft);margin-bottom:3px">FC vs Spot Δ</div><div style="font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800;color:var(--amber)">+6.6%</div></div>
          </div>
        </div>
        <div class="card" style="padding:18px;background:linear-gradient(135deg,rgba(13,148,136,.05),rgba(255,255,255,0))">
          <div style="font-size:14px;font-weight:700;margin-bottom:10px">Final Combined Recommendation</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ink-mid);line-height:2;background:rgba(13,148,136,.05);border:1px solid var(--border-m);border-radius:10px;padding:12px">
            Final = (<span style="color:var(--teal);font-weight:700" id="vd-f-dw">0.30</span>) × <span style="color:var(--teal);font-weight:700" id="vd-f-dr">83.3%</span> + (<span style="color:var(--teal);font-weight:700" id="vd-f-fw">0.70</span>) × <span style="color:var(--teal);font-weight:700" id="vd-f-fr">54%</span><br>
            = <span style="color:var(--green);font-weight:700;font-size:16px" id="vd-f-fin">63%</span> → After layering: <span style="color:var(--green);font-weight:700;font-size:16px" id="vd-f-lay">66%</span>
          </div>
          <!-- Monthly recos -->
          <div style="margin-top:14px" id="vd-monthly-recos"></div>
        </div>
      </div>
    </div>
  </div>`;
}

// ── SCORING PROFILES PANE ────────────────────────────────────────────────────
function vdRenderProfiles() {
  return `
  <div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
      ${[
        {l:'Portfolio Health',v:'84/100',g:'A · Excellent',gc:'var(--green)',bt:'var(--green)'},
        {l:'Hedge Efficiency',v:'79/100',g:'B+ · Strong',gc:'var(--teal)',bt:'var(--teal)'},
        {l:'Decision Quality',v:'71/100',g:'B · Good',gc:'var(--blue)',bt:'var(--blue)'},
        {l:'Behavioral Bias',v:'63/100',g:'C+ · Caution',gc:'var(--amber)',bt:'var(--amber)'},
      ].map(k=>`
        <div class="card" style="padding:16px 18px;border-top:3px solid ${k.bt}">
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:6px">${k.l}</div>
          <div style="font-size:22px;font-weight:800;color:${k.gc}">${k.v}</div>
          <div style="margin-top:6px"><span style="font-size:12px;font-weight:700;color:${k.gc};background:${k.gc}18;border:1px solid ${k.gc}44;padding:3px 9px;border-radius:12px">${k.g}</span></div>
        </div>`).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <!-- Health Breakdown -->
      <div class="card" style="padding:20px">
        <div style="font-size:14px;font-weight:700;margin-bottom:14px">Portfolio Health — Breakdown</div>
        ${[
          {l:'Coverage Adequacy',v:28,max:30,pct:93,c:'var(--green)'},
          {l:'Timing Quality',v:21,max:25,pct:84,c:'var(--teal)'},
          {l:'M2M Performance',v:19,max:25,pct:76,c:'var(--blue)'},
          {l:'Diversification',v:16,max:20,pct:80,c:'var(--purple)'},
        ].map(r=>`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:11px">
            <div style="font-size:12px;color:var(--ink-soft);min-width:130px">${r.l}</div>
            <div style="flex:1;height:6px;background:var(--teal-dim);border-radius:3px;overflow:hidden"><div style="width:${r.pct}%;height:100%;background:${r.c};border-radius:3px"></div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:${r.c};min-width:36px">${r.v}/${r.max}</div>
          </div>`).join('')}
        <div style="background:linear-gradient(90deg,rgba(13,148,136,.07),transparent);border:1px solid var(--border-m);border-radius:10px;padding:11px;display:flex;gap:8px;margin-top:6px">
          <span>💡</span><div style="font-size:12px;color:var(--ink-soft)"><b style="color:var(--teal)">Category Creator</b> — ION, Brady, AEGIS all show M2M. None compute composite health across coverage quality, timing percentiles, and instrument diversification.</div>
        </div>
      </div>
      <!-- Behavioral Fingerprint -->
      <div class="card" style="padding:20px">
        <div style="font-size:14px;font-weight:700;margin-bottom:4px">Buyer Behavioral Fingerprint</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">127 CRM decisions analyzed · Sarah Chen</div>
        ${[
          {n:'Loss Aversion',s:'Holds coverage too long when losing',v:'HIGH · 78%',c:'var(--red)'},
          {n:'Anchoring Bias',s:'Anchors to last-paid price',v:'MED · 67%',c:'var(--amber)'},
          {n:'Overconfidence',s:'Override 23%, win rate 61%',v:'MED · 51%',c:'var(--amber)'},
          {n:'Recency Bias',s:'Over-weights last 3 months',v:'LOW · 29%',c:'var(--green)'},
        ].map(b=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-radius:8px;border:1px solid var(--border);margin-bottom:7px;transition:.15s" onmouseover="this.style.borderColor='var(--border-m)'" onmouseout="this.style.borderColor='var(--border)'">
            <div><div style="font-size:12.5px;font-weight:600;color:var(--ink)">${b.n}</div><div style="font-size:11.5px;color:var(--ink-soft)">${b.s}</div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:${b.c}">${b.v}</div>
          </div>`).join('')}
        <div style="background:linear-gradient(90deg,rgba(245,158,11,.06),transparent);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:11px;display:flex;gap:8px;margin-top:6px">
          <span>🧠</span><div style="font-size:12px;color:var(--ink-soft)"><b style="color:var(--amber)">World's First</b> — Procurement Behavioral Intelligence Layer. Every override recorded + analyzed using behavioral economics. Flags bias before the CRM vote.</div>
        </div>
      </div>
    </div>
    <!-- Regret Engine -->
    <div class="card" style="overflow:hidden">
      <div class="card-header" style="padding:14px 18px;display:flex;justify-content:space-between;align-items:center">
        <div><div class="card-title">Regret Engine — Decision Autopsy</div><div class="card-sub">Every CRM decision vs. AI recommendation · Accountability + learning loops</div></div>
        <div style="text-align:right"><div style="font-size:11.5px;color:var(--ink-soft)">12-month regret cost</div><div style="font-size:20px;font-weight:800;color:var(--red)">−£0.83M</div></div>
      </div>
      <div style="padding:14px 18px">
        ${[
          {d:'Nov 2025',c:'Ethylene',a:'Overrode AI → Reduced to 65%',o:'Price +14.2% — loss',cost:'−£0.31M',w:false},
          {d:'Sep 2025',c:'Palm Oil',a:'Overrode AI → Held coverage',o:'Price fell −8.7% — held loss',cost:'−£0.27M',w:false},
          {d:'Jul 2025',c:'NFDM US',a:'Overrode AI → Increased to 92%',o:'Price +6.3% — AI was right',cost:'+£0.19M',w:true},
          {d:'May 2025',c:'WMP EU',a:'Overrode AI → Delayed hedge 3 weeks',o:'Price +11.1% in 3 weeks',cost:'−£0.24M',w:false},
        ].map(r=>`
          <div style="display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)">
            <div style="width:32px;height:32px;border-radius:50%;background:${r.w?'rgba(16,185,129,.12)':'rgba(239,68,68,.12)'};display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${r.w?'✓':'✗'}</div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600">${r.d} — ${r.c}</div><div style="font-size:12px;color:var(--ink-soft)">${r.a}</div><div style="font-size:12px;color:var(--ink-soft)">${r.o}</div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:13.5px;font-weight:700;color:${r.w?'var(--green)':'var(--red)'}">${r.cost}</div>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ── COMMODITY DNA PANE ────────────────────────────────────────────────────────
function vdRenderGenome() {
  return `
  <div>
    <div style="background:linear-gradient(90deg,rgba(13,148,136,.07),transparent);border:1px solid var(--border-m);border-radius:12px;padding:13px 16px;display:flex;gap:10px;margin-bottom:16px">
      <span>🧬</span><div><div style="font-size:13px;font-weight:700;color:var(--teal)">Commodity DNA™ — Competitive Moat</div><div style="font-size:12.5px;color:var(--ink-soft)">ION, Brady, Eka, AEGIS — all built for commodity traders, not CPG procurement. None map product COGS to commodity trees. Palm oil spikes 20% → you see exactly which SKUs are impacted.</div></div>
    </div>
    <div style="display:grid;grid-template-columns:280px 1fr;gap:16px">
      <!-- Product Tree -->
      <div>
        <div style="font-size:13px;font-weight:700;margin-bottom:10px">Product Exposure Tree</div>
        ${[
          {n:'Dettol Liquid',s:'3.2M units/yr',ings:[{n:'Ethanol (94%)',c:'Ethylene',e:'High',p:32},{n:'PET Bottle',c:'Propylene',e:'Med',p:12}]},
          {n:'Harpic Toilet',s:'2.8M units/yr',ings:[{n:'Surfactants (8%)',c:'Ethylene',e:'High',p:18},{n:'HDPE Bottle',c:'Ethylene',e:'High',p:10}]},
          {n:'Enfamil Formula',s:'1.9M units/yr',ings:[{n:'Skim Milk (62%)',c:'NFDM',e:'High',p:62},{n:'Palm Olein (18%)',c:'Palm Oil',e:'High',p:18}]},
          {n:'Finish Dishwash',s:'4.1M units/yr',ings:[{n:'Surfactant blend',c:'Propylene',e:'Med',p:35}]},
        ].map((p,i)=>`
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:.18s" onclick="this.querySelector('.gene-ings').style.display=this.querySelector('.gene-ings').style.display==='none'?'block':'none'" onmouseover="this.style.borderColor='var(--teal)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700;font-size:13px">${p.n}</div><div style="font-size:11.5px;color:var(--ink-soft)">${p.s}</div></div><span style="color:var(--ink-faint)">▸</span></div>
            <div class="gene-ings" style="display:none;margin-top:8px">
              ${p.ings.map(g=>`<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-top:1px solid var(--border)">
                <div style="font-size:12px;color:var(--ink-mid);flex:1">${g.n}</div>
                <span style="font-size:11px;background:rgba(13,148,136,.1);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:2px 7px;border-radius:5px;font-weight:600">${g.c}</span>
                <span style="font-size:11px;background:${g.e==='High'?'rgba(239,68,68,.1)':'rgba(245,158,11,.1)'};color:${g.e==='High'?'var(--red)':'var(--amber)'};border:1px solid ${g.e==='High'?'rgba(239,68,68,.2)':'rgba(245,158,11,.2)'};padding:2px 6px;border-radius:5px;font-weight:600">${g.e}</span>
                <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--ink-soft)">${g.p}%</span>
              </div>`).join('')}
            </div>
          </div>`).join('')}
      </div>
      <!-- COGS Simulator + Synthetic Hedge -->
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">COGS Shock Simulator</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:14px">Select commodity · Set shock · See P&L ripple across SKUs</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">
            ${['Ethylene','Palm Oil','NFDM','WMP','Propylene'].map(c=>`<button onclick="vdSelectShockComm(this,'${c}')" class="btn btn-sm btn-ghost vd-shock-btn" style="font-size:12px">${c}</button>`).join('')}
          </div>
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--ink-soft);margin-bottom:6px"><span>Price Shock</span><span id="vd-shock-lbl" style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--teal)">+20%</span></div>
          <input type="range" min="-30" max="50" value="20" oninput="vdUpdateShock(this.value)" style="width:100%;accent-color:var(--teal);cursor:pointer;height:4px">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink-faint);margin-top:4px"><span>−30%</span><span>0%</span><span>+50%</span></div>
          <div id="vd-shock-bars" style="margin-top:14px">
            ${['Dettol Liquid','Harpic Toilet','Enfamil Formula','Finish Dishwash'].map(s=>`
              <div style="margin-bottom:10px">
                <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12.5px;font-weight:600">${s}</span><span style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--red)">+6.4% COGS</span></div>
                <div style="height:5px;background:var(--teal-dim);border-radius:3px;overflow:hidden"><div style="width:32%;height:100%;background:var(--red);border-radius:3px"></div></div>
              </div>`).join('')}
          </div>
        </div>
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">Synthetic Hedge Constructor</div>
          <div style="font-size:12px;color:var(--ink-soft);margin-bottom:12px">For illiquid commodities — AI builds correlated basket hedges</div>
          <div style="background:rgba(13,148,136,.08);border-radius:9px;padding:10px 12px;margin-bottom:12px"><div style="font-size:12.5px;font-weight:600;color:var(--teal)">Target: NFDM US — No liquid futures</div><div style="font-size:12px;color:var(--ink-soft)">94.7% tracking · Lower cost than OTC</div></div>
          ${[{w:'41%',n:'CME Class III Milk Futures',d:'Primary — 0.87 corr · Most liquid proxy',t:'Long',tc:'var(--teal)'},{w:'33%',n:'NZD/USD FX Forward',d:'Currency hedge · NZ dairy export · 0.71 corr',t:'Long',tc:'var(--blue)'},{w:'26%',n:'SMP NZ Butter Futures',d:'Secondary dairy proxy · 0.63 corr · SGX',t:'Long',tc:'var(--teal)'}].map(sc=>`
            <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:9px;margin-bottom:7px;transition:.15s" onmouseover="this.style.borderColor='var(--border-m)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:800;color:var(--teal);min-width:42px">${sc.w}</div>
              <div style="flex:1"><div style="font-size:12.5px;font-weight:600">${sc.n}</div><div style="font-size:11.5px;color:var(--ink-soft)">${sc.d}</div></div>
              <span style="font-size:11px;background:${sc.tc}18;color:${sc.tc};border:1px solid ${sc.tc}44;padding:2px 8px;border-radius:5px;font-weight:600">${sc.t}</span>
            </div>`).join('')}
          <div style="padding:10px 12px;background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);border-radius:9px;font-size:12.5px;font-weight:700;color:var(--green)">Basket vs. OTC: +22% lower cost · +8% better tracking</div>
        </div>
      </div>
    </div>
  </div>`;
}

// ── SCENARIO PANE ─────────────────────────────────────────────────────────────
function vdRenderScenario() {
  return `
  <div>
    <div style="display:grid;grid-template-columns:280px 1fr;gap:16px">
      <!-- Left controls -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card" style="padding:18px">
          <div style="font-size:13px;font-weight:700;margin-bottom:12px">Shock Type</div>
          ${[
            {t:'Red Sea Supply Shock',d:'Container +40% → petrochems +15%',i:0},
            {t:'La Niña Dairy Impact',d:'NZ/AU production −12% → dairy +18%',i:1},
            {t:'Stagflation Wave',d:'Energy spike + demand destruction',i:2},
            {t:'Carbon Tariff Cascade',d:'EU CBAM + domestic carbon tax',i:3},
          ].map(s=>`
            <div onclick="vdSelectScenario(${s.i},this)" style="border:1px solid var(--border);border-radius:10px;padding:11px 13px;cursor:pointer;transition:.18s;margin-bottom:7px;${s.i===0?'border-color:var(--teal);background:rgba(13,148,136,.06)':''}" class="vd-scenario-card">
              <div style="font-weight:600;font-size:13px">${s.t}</div>
              <div style="font-size:12px;color:var(--ink-soft);margin-top:2px">${s.d}</div>
            </div>`).join('')}
        </div>
        <div class="card" style="padding:18px">
          <div style="font-size:13px;font-weight:700;margin-bottom:12px">Shock Intensity</div>
          <input type="range" min="10" max="100" value="55" oninput="vdUpdateScenarioIntensity(this.value)" style="width:100%;accent-color:var(--teal);cursor:pointer;height:4px">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--ink-faint);margin-top:6px"><span>Mild</span><span id="vd-scenario-intensity" style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--teal)">55%</span><span>Severe</span></div>
        </div>
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-size:13px;font-weight:700">🌿 Carbon CBAM Overlay</div><span style="font-size:11px;background:rgba(139,92,246,.1);color:var(--purple);border:1px solid rgba(139,92,246,.2);padding:2px 8px;border-radius:5px;font-weight:600">EU 2026</span></div>
          ${[['Ethylene','€28/ton','+2.4%','var(--red)'],['Propylene','€22/ton','+2.8%','var(--amber)'],['Palm Oil','€18/ton','+0.4%','var(--green)']].map(r=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-radius:8px;border:1px solid var(--border);margin-bottom:7px">
              <div><div style="font-size:12.5px;font-weight:600">${r[0]}</div><div style="font-size:12px;color:var(--ink-soft)">CBAM: ${r[1]}</div></div>
              <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:${r[3]}">${r[2]}</div>
            </div>`).join('')}
        </div>
      </div>
      <!-- Right output -->
      <div style="display:flex;flex-direction:column;gap:14px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="card" style="padding:16px"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:5px">Portfolio P&L Impact</div><div style="font-size:22px;font-weight:800;color:var(--red)" id="vd-sc-pnl">−£11.6M</div><div style="font-size:11.5px;color:var(--ink-faint)">If fully unhedged</div></div>
          <div class="card" style="padding:16px"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:5px">Hedged Savings</div><div style="font-size:22px;font-weight:800;color:var(--green)" id="vd-sc-sav">+£7.7M</div><div style="font-size:11.5px;color:var(--ink-faint)">At current coverage</div></div>
          <div class="card" style="padding:16px"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:5px">Recommended Δ Coverage</div><div style="font-size:22px;font-weight:800;color:var(--teal)" id="vd-sc-delta">+11%</div><div style="font-size:11.5px;color:var(--ink-faint)">AI pre-positioning reco</div></div>
          <div class="card" style="padding:16px"><div style="font-size:12px;color:var(--ink-soft);margin-bottom:5px">Scenario Probability</div><div style="font-size:22px;font-weight:800" id="vd-sc-prob">21%</div><div style="font-size:11.5px;color:var(--ink-faint)">AI-assessed · 12-month</div></div>
        </div>
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:12px">Commodity Impact Waterfall</div>
          <div style="position:relative;height:180px"><canvas id="vd-scenario-chart"></canvas></div>
        </div>
        <div class="card" style="padding:20px;background:linear-gradient(135deg,rgba(13,148,136,.05),transparent)">
          <div style="font-size:13px;font-weight:700;color:var(--teal);margin-bottom:8px">🤖 AI Scenario Narrative</div>
          <div id="vd-sc-narrative" style="font-size:13px;color:var(--ink-mid);line-height:1.7">Under a <b>55% intensity Red Sea Supply Shock</b> scenario, total portfolio P&L impact reaches <b>−£11.6M</b> if fully unhedged. Current hedges save <b>+£7.7M</b>. AI recommends pre-positioning +11% coverage across Ethylene (9.2 criticality) and Palm Oil (8.7). CBAM carbon premiums add ~£0.8M incremental cost.</div>
          <div style="background:linear-gradient(90deg,rgba(13,148,136,.07),transparent);border:1px solid var(--border-m);border-radius:10px;padding:11px;display:flex;gap:8px;margin-top:12px">
            <span>🌍</span><div style="font-size:12px;color:var(--ink-soft)"><b style="color:var(--teal)">Generative Scenarios</b> — Legacy tools backtest what happened. Veridian generates novel shock scenarios via LLM reasoning — geopolitical cascades, correlated climate failures, supply concentration domino effects.</div>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

// ── SIGNALS PANE ─────────────────────────────────────────────────────────────
function vdRenderSignals() {
  return `
  <div>
    <div style="display:grid;grid-template-columns:1fr 300px;gap:14px;margin-bottom:16px">
      <div class="card" style="padding:0;overflow:hidden;display:flex;flex-direction:column">
        <div class="card-header" style="padding:14px 18px;display:flex;justify-content:space-between;align-items:center">
          <div><div class="card-title">Live Alternative Data Signals</div><div class="card-sub">Satellite · AIS shipping · Weather · Sentiment · Central banks</div></div>
          <div style="display:flex;align-items:center;gap:5px"><div style="width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse-g 2s infinite"></div><span style="font-size:11.5px;color:var(--green);font-weight:600">50 Live</span></div>
        </div>
        <div style="flex:1;overflow:auto">
          ${VERIDIAN_SIGNALS.map(s=>{
            const iC = {HIGH:'var(--red)',MED:'var(--amber)',LOW:'var(--ink-faint)'}[s.impact];
            return `<div style="padding:12px 16px;border-bottom:1px solid var(--border);transition:.15s;cursor:pointer" onmouseover="this.style.background='rgba(13,148,136,.04)'" onmouseout="this.style.background=''">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                <div style="display:flex;align-items:center;gap:6px">
                  <span style="font-size:15px">${s.icon}</span>
                  <span style="font-size:10.5px;font-weight:700;color:${iC};letter-spacing:.07em">${s.type}</span>
                  <span style="font-size:10px;background:rgba(13,148,136,.1);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:2px 7px;border-radius:4px;font-weight:600">${s.comm}</span>
                </div>
                <span style="font-size:11.5px;color:var(--ink-faint)">${s.age}</span>
              </div>
              <div style="font-size:12.5px;color:var(--ink-mid);line-height:1.55">${s.text}</div>
            </div>`;
          }).join('')}
        </div>
      </div>
      <!-- Sources + Counterparty -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card" style="padding:16px">
          <div style="font-size:13px;font-weight:700;margin-bottom:12px">Signal Sources</div>
          ${[['Satellite Imagery',8,'var(--teal)',3],['AIS Shipping',7,'var(--blue)',2],['Weather / ENSO',9,'var(--green)',1],['Macro / Central Banks',6,'var(--purple)',1],['Social Sentiment',7,'var(--amber)',0],['Proxy Hedge Spreads',5,'var(--teal-l)',1],['Supply Chain',8,'var(--ink-soft)',1],['Carbon / CBAM',6,'var(--green)',1]].map(r=>`
            <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
              <div style="width:3px;height:24px;border-radius:2px;background:${r[2]};flex-shrink:0"></div>
              <div style="flex:1"><div style="font-size:12px;font-weight:500">${r[0]}</div><div style="font-size:11px;color:var(--ink-faint)">${r[1]} streams</div></div>
              ${r[3]>0?`<span style="font-size:10px;background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.2);padding:2px 7px;border-radius:4px;font-weight:600">${r[3]} live</span>`:`<span style="font-size:11px;color:var(--ink-ghost)">quiet</span>`}
            </div>`).join('')}
        </div>
        <div class="card" style="padding:16px">
          <div style="font-size:13px;font-weight:700;margin-bottom:12px">Counterparty Risk</div>
          ${[['Goldman Sachs','£38M','AA−',28,'Low'],['BP Energy','£31M','A+',35,'Low'],['Cargill','£22M','A−',41,'Low'],['Macquarie','£18M','BBB+',87,'Med']].map(r=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
              <div><div style="font-size:12.5px;font-weight:600">${r[0]}</div><div style="font-size:11.5px;color:var(--ink-soft)">${r[1]} · ${r[2]}</div></div>
              <div style="text-align:right"><div style="font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:600;color:${r[4]==='Low'?'var(--green)':'var(--amber)'}">CDS ${r[3]}bps</div><span style="font-size:10px;background:${r[4]==='Low'?'rgba(16,185,129,.1)':'rgba(245,158,11,.1)'};color:${r[4]==='Low'?'var(--green)':'var(--amber)'};border:1px solid ${r[4]==='Low'?'rgba(16,185,129,.2)':'rgba(245,158,11,.2)'};padding:2px 7px;border-radius:4px;font-weight:600">${r[4]}</span></div>
            </div>`).join('')}
        </div>
      </div>
    </div>
    <!-- NL Policy Enforcer -->
    <div class="card" style="padding:22px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div><div style="font-size:16px;font-weight:800">Natural Language Policy Enforcer</div><div style="font-size:12.5px;color:var(--ink-soft);margin-top:3px">Enter hedging rules in plain English — AI enforces as hard constraints on every recommendation</div></div>
        <span style="font-size:11px;background:rgba(139,92,246,.1);color:var(--purple);border:1px solid rgba(139,92,246,.2);padding:3px 10px;border-radius:6px;font-weight:600">CFO-Ready</span>
      </div>
      <div id="vd-policies">
        ${['Never exceed 90% coverage on any single commodity within a single month','Minimum 40% coverage for commodities with spend > £20M/year','During earnings lock-up periods (±21 days), no new hedges > £5M notional','Propylene: coverage floor 30% regardless of price outlook — supply concentration risk'].map(p=>`
          <div style="display:flex;align-items:flex-start;gap:9px;padding:10px 12px;background:rgba(13,148,136,.05);border:1px solid rgba(13,148,136,.18);border-radius:9px;margin-bottom:8px">
            <span style="font-size:14px">✅</span>
            <div style="flex:1;font-size:12.5px;color:var(--ink-mid);line-height:1.5">${p}</div>
            <div style="display:flex;gap:5px;flex-shrink:0">
              <span style="font-size:10.5px;background:rgba(13,148,136,.1);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:2px 7px;border-radius:4px;font-weight:600">Active</span>
              <span style="font-size:10.5px;background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2);padding:2px 7px;border-radius:4px;font-weight:600">Enforced</span>
            </div>
          </div>`).join('')}
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <input type="text" id="vd-policy-input" placeholder='e.g. "Never exceed 90% during earnings periods"' style="flex:1;padding:10px 14px;border:1px solid var(--border-m);border-radius:9px;font-size:13px;background:var(--surface-alt);outline:none;font-family:inherit">
        <button onclick="vdAddPolicy()" class="btn btn-primary">Add Rule</button>
      </div>
    </div>
  </div>`;
}

// ── FUTURE VISION 2046 PANE ───────────────────────────────────────────────────
function vdRenderFuture() {
  return `
  <div>
    <!-- Vision Banner -->
    <div style="background:linear-gradient(135deg,#0C1A17,#1A3835,#0D1F3C);border-radius:16px;padding:28px 32px;margin-bottom:20px;position:relative;overflow:hidden">
      <div style="position:absolute;top:-80px;right:-80px;width:320px;height:320px;background:radial-gradient(circle,rgba(212,175,55,.18) 0%,transparent 70%);pointer-events:none"></div>
      <div style="position:absolute;bottom:-60px;left:30%;width:240px;height:240px;background:radial-gradient(circle,rgba(13,148,136,.14) 0%,transparent 70%);pointer-events:none"></div>
      <div style="position:relative;z-index:1">
        <div style="font-size:11px;color:#D4AF37;font-weight:700;letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px">🔮 NERVURE × VERIDIAN — VISION 2046</div>
        <div style="font-size:26px;font-weight:800;color:#fff;line-height:1.25;margin-bottom:8px">The next 20 years of<br><span style="background:linear-gradient(90deg,#5EEAD4,#D4AF37);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Commodity Intelligence</span></div>
        <div style="font-size:13px;color:rgba(255,255,255,.42);line-height:1.7;max-width:640px">We built the prototype. The backend is coming. But here is what we — and the market — are building toward. This is not fiction. Every capability shown below has a technology pathway from where we are today.</div>
      </div>
    </div>

    <!-- Timeline -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:18px">
      ${[
        {yr:'2026–2028',phase:'Foundation',col:'var(--teal)',items:['Real-time CME/ICE data integration via API','GPT-4o copilot answering "Why Ethylene at 78%?"','Automated IFRS 9 test filing to audit systems','Multi-user CRM approval workflows with MFA','ERP integration (SAP/Oracle) — auto-hedge booking']},
        {yr:'2028–2032',phase:'Intelligence',col:'var(--blue)',items:['Autonomous hedging agent (Nervure executes without human approval for sub-£500K transactions)','Climate risk layer — physical + transition risk scoring','Real-time satellite-to-hedge pipeline (no human in loop)','Natural language contract generation for OTC desks','Federated benchmarking — industry-wide anonymous data pool']},
        {yr:'2032–2046',phase:'Autonomy',col:'var(--amber)',items:['Fully autonomous treasury AI — CFO approves strategy, AI handles all execution','Digital twin of global commodity supply chains — simulate before you hedge','Quantum optimization for 10,000+ parameter hedge portfolios','Neuro-symbolic AI combining LLM reasoning with causal math models','Planetary-scale carbon accounting embedded in every hedge decision']},
      ].map(t=>`
        <div class="card" style="padding:20px;border-top:3px solid ${t.col}">
          <div style="font-size:11px;color:${t.col};font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px">${t.yr}</div>
          <div style="font-size:16px;font-weight:800;color:var(--ink);margin-bottom:14px">${t.phase}</div>
          ${t.items.map(i=>`<div style="display:flex;gap:8px;margin-bottom:9px;font-size:12.5px;color:var(--ink-mid);line-height:1.5"><div style="width:5px;height:5px;border-radius:50%;background:${t.col};flex-shrink:0;margin-top:5px"></div><div>${i}</div></div>`).join('')}
        </div>`).join('')}
    </div>

    <!-- Paradigm Shifts -->
    <div class="card" style="padding:24px;margin-bottom:14px">
      <div style="font-size:16px;font-weight:800;margin-bottom:4px">The 3 Paradigm Shifts That Will Reshape This Market</div>
      <div style="font-size:12.5px;color:var(--ink-soft);margin-bottom:18px">Each one is a category-creating opportunity — and a competitive threat to anyone who misses it</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
        ${[
          {icon:'🌍',t:'Physical Climate Risk becomes Treasury Risk',d:'By 2035, every CFO will need a "climate-adjusted hedge book." Rainfall data, sea level projections, and extreme weather probabilities will be embedded directly into commodity coverage calculations. Veridian is building the data layer now.',c:'var(--green)'},
          {icon:'🤖',t:'Agentic AI Replaces Approval Committees',d:'The 5-person hedge committee will be replaced by an AI agent + single CFO override. Speed of execution goes from 3 days to 3 seconds. The winners are companies who build trust in AI execution first — that trust is earned through transparent explainability (our moat).',c:'var(--teal)'},
          {icon:'⛓',t:'DeFi Commodity Hedging — Blockchain Settlement',d:'Tokenized commodity futures on-chain will eliminate counterparty risk and reduce hedge execution cost by 60%+. Our synthetic hedge constructor is already building the mental model for programmable basket hedges. On-chain is the natural next layer.',c:'var(--purple)'},
        ].map(p=>`
          <div style="border:1px solid var(--border);border-radius:12px;padding:18px;transition:.22s" onmouseover="this.style.borderColor='${p.c}';this.style.background='${p.c}06'" onmouseout="this.style.borderColor='var(--border)';this.style.background=''">
            <div style="font-size:24px;margin-bottom:10px">${p.icon}</div>
            <div style="font-size:13.5px;font-weight:700;color:var(--ink);margin-bottom:8px;line-height:1.4">${p.t}</div>
            <div style="font-size:12.5px;color:var(--ink-soft);line-height:1.65">${p.d}</div>
          </div>`).join('')}
      </div>
    </div>

    <!-- Competitive Moat Analysis -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div class="card" style="padding:20px">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">🏆 Why Veridian Wins Long-Term</div>
        ${[
          {item:'Explainability-first architecture',why:'Regulators (MiFID II, DORA, EU AI Act) will mandate it. We built it from day 1.',c:'var(--green)'},
          {item:'CPG-native, not commodity trader port',why:'ION/Brady retrofitted for traders. We understand SKU-level COGS exposure natively.',c:'var(--teal)'},
          {item:'Behavioral intelligence moat',why:'127+ decisions → personalized bias fingerprint. Grows more accurate with every override.',c:'var(--blue)'},
          {item:'Open parameter architecture',why:'Full transparency builds CFO trust. Black-box competitors will face AI Act scrutiny.',c:'var(--purple)'},
          {item:'Agentic-ready from prototype',why:'Autonomous execution path is in our architecture. Not bolted on later.',c:'var(--amber)'},
        ].map(m=>`
          <div style="display:flex;gap:10px;margin-bottom:11px">
            <div style="width:5px;border-radius:3px;background:${m.c};flex-shrink:0"></div>
            <div><div style="font-size:12.5px;font-weight:600;color:var(--ink)">${m.item}</div><div style="font-size:12px;color:var(--ink-soft);line-height:1.5">${m.why}</div></div>
          </div>`).join('')}
      </div>
      <div class="card" style="padding:20px">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">💰 TAM Expansion: 2026 → 2046</div>
        ${[
          {yr:'2026',tam:'£420M',desc:'UK/EU CPG hedging software · 200 target companies',w:18},
          {yr:'2028',tam:'£1.2B',desc:'+ North America CPG · Add PriceOS bundle',w:34},
          {yr:'2031',tam:'£3.8B',desc:'+ Mid-market food/pharma + Emerging Markets',w:55},
          {yr:'2036',tam:'£9.4B',desc:'+ Autonomous treasury SaaS + carbon layer',w:72},
          {yr:'2046',tam:'£28B',desc:'Global CFO AI platform · Multi-asset class',w:100},
        ].map(r=>`
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px">
              <span style="font-size:12.5px;font-weight:600">${r.yr} — ${r.tam} TAM</span>
              <span style="font-size:12px;color:var(--ink-soft)">${r.desc}</span>
            </div>
            <div style="height:6px;background:var(--teal-dim);border-radius:3px;overflow:hidden"><div style="width:${r.w}%;height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-l));border-radius:3px;transition:width 1s ease"></div></div>
          </div>`).join('')}
        <div style="margin-top:14px;padding:12px;background:rgba(212,175,55,.08);border:1px solid rgba(212,175,55,.2);border-radius:10px">
          <div style="font-size:12.5px;font-weight:700;color:#D4AF37">Husband note → Wifey says:</div>
          <div style="font-size:12.5px;color:var(--ink-soft);line-height:1.6;margin-top:4px">Backend missing = prototype incomplete. But TAM, moat, and differentiation are real. Get 3 pilot customers paying £50K/yr each = £150K ARR = product-market fit signal. Then raise. Don't raise before.</div>
        </div>
      </div>
    </div>

    <!-- Feature Roadmap (Competitive) -->
    <div class="card" style="padding:24px">
      <div style="font-size:16px;font-weight:800;margin-bottom:4px">🚀 Next Features to Ship — Ranked by Revenue Impact</div>
      <div style="font-size:12.5px;color:var(--ink-soft);margin-bottom:16px">Wifey's unbiased priority stack — money-math driven, not feature-vanity driven</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
        ${[
          {rank:1,f:'Backend data layer',why:'Without real CME/ICE prices, this is a prototype. Nothing else matters.',effort:'High',rev:'Unlocks all ARR',c:'var(--red)'},
          {rank:2,f:'PDF export — CFO hedge summary',why:'Every CFO wants a 2-page PDF on Monday. One feature, drives trials.',effort:'Low',rev:'+£30K/yr per client',c:'var(--green)'},
          {rank:3,f:'Slack/Teams copilot',why:'"@nervure what should we do on Ethylene today?" = daily habit = retention.',effort:'Med',rev:'+40% retention',c:'var(--teal)'},
          {rank:4,f:'Multi-user approval workflows',why:'Hedge committees have 3–8 people. Without this, no enterprise deal.',effort:'Med',rev:'Unlocks £100K+ deals',c:'var(--blue)'},
          {rank:5,f:'IFRS 9 auto-report filing',why:'Auditors demand it. Automated = 8hrs/quarter saved per client.',effort:'High',rev:'+£25K/yr per client',c:'var(--purple)'},
          {rank:6,f:'Mobile app (read-only)',why:'CFO checks hedge book at airport. Simple. High perceived value.',effort:'Low',rev:'+15% conversion',c:'var(--amber)'},
        ].map(f=>`
          <div style="border:1px solid var(--border);border-radius:10px;padding:14px;transition:.18s" onmouseover="this.style.borderColor='${f.c}'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:18px;font-weight:900;color:${f.c}">${f.rank}</span><div style="font-size:13px;font-weight:700">${f.f}</div></div>
            <div style="font-size:12px;color:var(--ink-soft);line-height:1.5;margin-bottom:8px">${f.why}</div>
            <div style="display:flex;gap:6px">
              <span style="font-size:10.5px;background:${f.c}18;color:${f.c};border:1px solid ${f.c}44;padding:2px 7px;border-radius:5px;font-weight:600">${f.effort} effort</span>
              <span style="font-size:10.5px;background:rgba(13,148,136,.08);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:2px 7px;border-radius:5px;font-weight:600">${f.rev}</span>
            </div>
          </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ── TAB SWITCHER ────────────────────────────────────────────────────────────
function vdShowTab(tab) {
  VD_STATE.tab = tab;
  document.querySelectorAll('.vd-pane').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.vd-tab-btn').forEach(b => {
    b.style.background = 'transparent';
    b.style.color = 'var(--ink-soft)';
    b.style.fontWeight = '500';
  });
  const pane = document.getElementById('vd-pane-' + tab);
  if (pane) pane.style.display = 'block';
  const btn = document.getElementById('vdtab-' + tab);
  if (btn) { btn.style.background = 'var(--surface)'; btn.style.color = 'var(--ink)'; btn.style.fontWeight = '700'; btn.style.boxShadow = 'var(--shadow-s)'; }

  // Lazy builds
  if (tab === 'oracle' && !vdOracleRan) setTimeout(() => vdRunOracle(), 50);
  if (tab === 'cnc') setTimeout(() => vdInitCNC(), 50);
  if (tab === 'scenario') setTimeout(() => vdBuildScenarioChart(1), 200);
}

// ── CNC ENGINE LOGIC ────────────────────────────────────────────────────────
function vdSelectCNCComm(id) {
  VD_STATE.cncComm = id;
  document.querySelectorAll('[id^="vdcc-"]').forEach(b => {
    b.className = 'btn btn-sm btn-ghost';
  });
  const el = document.getElementById('vdcc-' + id);
  if (el) el.className = 'btn btn-sm btn-primary';
  vdUpdateCNC();
}

function vdSetParam(param, val, btn) {
  VD_STATE[param === 'fcpct' ? 'fcPct' : param === 'window' ? 'bw' : param === 'fcstart' ? 'fcstart' : 'decay'] = val;
  if (btn) {
    btn.closest('.vd-param-card, div').querySelectorAll('.vd-param-btn').forEach(b => {
      b.style.background = 'var(--surface)'; b.style.color = 'var(--ink-soft)'; b.style.borderColor = 'var(--border)'; b.style.fontWeight = '500';
    });
    btn.style.background = 'var(--teal)'; btn.style.color = '#fff'; btn.style.borderColor = 'var(--teal)'; btn.style.fontWeight = '600';
  }
  vdUpdateCNC();
}

function vdInitCNC() { vdUpdateCNC(); }

function vdUpdateCNC() {
  const comm = VERIDIAN_COMMODITIES.find(c => c.id === VD_STATE.cncComm);
  if (!comm) return;
  const {bw, fcstart, decay, fcPct} = VD_STATE;
  const distPct = 100 - fcPct;
  const histPrices = comm.history.slice(-bw);
  const sorted = [...histPrices].sort((a, b) => a - b);
  const pricesAbove = sorted.filter(p => p >= comm.price).length;
  const percentile = parseFloat((pricesAbove / sorted.length * 100).toFixed(2));
  const distReco = parseFloat((100 - percentile).toFixed(1));
  const fcReco = Math.min(90, Math.max(10, Math.round(60 - (0.0664 * 100 / (fcstart/100)) * 8)));
  const combined = parseFloat(((distPct/100)*distReco + (fcPct/100)*fcReco).toFixed(1));
  const layered = Math.max(combined, 45);

  const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
  set('vd-dist-weight', `${distPct}% weight`);
  set('vd-fc-weight', `${fcPct}% weight`);
  set('vd-dist-pct', `${percentile.toFixed(1)}%`);
  set('vd-dist-reco', `${distReco}%`);
  set('vd-fc-reco', `${fcReco}%`);
  set('vd-f-dw', (distPct/100).toFixed(2));
  set('vd-f-fw', (fcPct/100).toFixed(2));
  set('vd-f-dr', `${distReco}%`);
  set('vd-f-fr', `${fcReco}%`);
  set('vd-f-fin', `${combined}%`);
  set('vd-f-lay', `${layered}%`);

  // Monthly recos
  const el = document.getElementById('vd-monthly-recos');
  if (!el) return;
  const months = ['Mar-26','Apr-26','May-26','Jun-26','Jul-26','Aug-26'];
  el.innerHTML = months.map((m, i) => {
    const fcD = Math.max(0, fcReco - fcReco * (decay/100) * i);
    const cov = parseFloat(((distPct/100)*distReco + (fcPct/100)*fcD).toFixed(0));
    const lay = Math.max(cov, 40 - i*2);
    const c = cov>=75?'var(--green)':cov>=55?'var(--teal)':'var(--amber)';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:9px;border:1px solid var(--border);margin-bottom:7px;transition:.15s;cursor:pointer" onmouseover="this.style.background='rgba(13,148,136,.04)'" onmouseout="this.style.background=''">
      <div style="font-weight:700;font-size:13.5px;min-width:65px">${m}</div>
      <div style="flex:1;margin:0 12px"><div style="height:4px;background:var(--teal-dim);border-radius:2px;overflow:hidden"><div style="width:${lay}%;height:100%;background:${c};border-radius:2px"></div></div><div style="font-size:11px;color:var(--ink-soft);margin-top:3px">Dist: ${Math.round(distReco)}% · FC: ${Math.round(fcD)}%</div></div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:800;color:${c};min-width:46px">${lay}%</div>
      <span style="font-size:11px;background:${lay>=75?'rgba(16,185,129,.1)':lay>=55?'rgba(13,148,136,.1)':'rgba(245,158,11,.1)'};color:${lay>=75?'var(--green)':lay>=55?'var(--teal)':'var(--amber)'};border:1px solid ${lay>=75?'rgba(16,185,129,.2)':lay>=55?'rgba(13,148,136,.2)':'rgba(245,158,11,.2)'};padding:3px 9px;border-radius:5px;font-weight:700;margin-left:8px">${lay>=75?'BUY':lay>=55?'HOLD':'WAIT'}</span>
    </div>`;
  }).join('');
}

// ── ORACLE RUN ───────────────────────────────────────────────────────────────
function vdRunOracle() {
  vdOracleRan = true;
}

// ── SCENARIO CHART ────────────────────────────────────────────────────────────
function vdBuildScenarioChart(factor) {
  destroyVdChart('scenario');
  const ctx = document.getElementById('vd-scenario-chart');
  if (!ctx) return;
  const impacts = VERIDIAN_COMMODITIES.map(c => -(c.priority/10*factor*2.1).toFixed(2));
  vdCharts['scenario'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: VERIDIAN_COMMODITIES.map(c => c.name),
      datasets: [{label:'P&L Impact (£M)',data:impacts,backgroundColor:impacts.map(v=>v<-1.5?'rgba(239,68,68,.7)':v<-1?'rgba(245,158,11,.7)':'rgba(13,148,136,.7)'),borderRadius:5}]
    },
    options: {
      indexAxis:'y',plugins:{legend:{display:false}},
      scales:{x:{grid:{color:'rgba(13,148,136,.08)'},ticks:{font:{size:11,family:'JetBrains Mono'},color:'#8FADA9',callback:v=>'£'+v+'M'}},y:{grid:{display:false},ticks:{font:{size:12,family:'Arial'},color:'#4A6B67'}}}
    }
  });
}

// ── SCENARIO INTERACTIONS ─────────────────────────────────────────────────────
const VD_SCENARIOS = [
  {pnl:14.2,sav:9.2,delta:14,prob:28},
  {pnl:9.8,sav:6.4,delta:9,prob:34},
  {pnl:18.6,sav:11.8,delta:18,prob:19},
  {pnl:7.4,sav:5.1,delta:7,prob:22},
];

function vdSelectScenario(i, el) {
  VD_STATE.scenario = i;
  document.querySelectorAll('.vd-scenario-card').forEach((c,ci) => {
    c.style.borderColor = ci===i?'var(--teal)':'var(--border)';
    c.style.background = ci===i?'rgba(13,148,136,.06)':'';
  });
  vdUpdateScenarioIntensity(VD_STATE.scenarioIntensity);
}

function vdUpdateScenarioIntensity(val) {
  VD_STATE.scenarioIntensity = parseFloat(val);
  const lbl = document.getElementById('vd-scenario-intensity');
  if (lbl) lbl.textContent = val + '%';
  const s = VD_SCENARIOS[VD_STATE.scenario];
  const f = val/55;
  const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
  set('vd-sc-pnl', '−£' + (s.pnl*f).toFixed(1) + 'M');
  set('vd-sc-sav', '+£' + (s.sav*f).toFixed(1) + 'M');
  set('vd-sc-delta', '+' + Math.round(s.delta*f) + '%');
  set('vd-sc-prob', Math.round(s.prob) + '%');
  vdBuildScenarioChart(f);
}

// ── SHOCK SIMULATOR ───────────────────────────────────────────────────────────
function vdSelectShockComm(btn, comm) {
  document.querySelectorAll('.vd-shock-btn').forEach(b => { b.className = 'btn btn-sm btn-ghost vd-shock-btn'; });
  btn.className = 'btn btn-sm btn-primary vd-shock-btn';
  vdUpdateShock(document.getElementById('vd-shock-lbl')?.textContent?.replace('%','') || '20');
}

function vdUpdateShock(val) {
  val = parseFloat(val);
  const lbl = document.getElementById('vd-shock-lbl');
  if (lbl) lbl.textContent = (val>0?'+':'') + val + '%';
  const el = document.getElementById('vd-shock-bars');
  if (!el) return;
  const prods = [{s:'Dettol Liquid',r:0.32},{s:'Harpic Toilet',r:0.28},{s:'Enfamil Formula',r:0.18},{s:'Finish Dishwash',r:0.35}];
  el.innerHTML = prods.map(p => {
    const d = (p.r * val).toFixed(1);
    const isPos = val > 0;
    return `<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12.5px;font-weight:600">${p.s}</span><span style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:${isPos?'var(--red)':'var(--green)'}">${isPos?'+':''}${d}% COGS</span></div><div style="height:5px;background:var(--teal-dim);border-radius:3px;overflow:hidden"><div style="width:${Math.min(100,Math.abs(d)*5)}%;height:100%;background:${isPos?'var(--red)':'var(--green)'};border-radius:3px"></div></div></div>`;
  }).join('');
}

// ── POLICY ────────────────────────────────────────────────────────────────────
function vdAddPolicy() {
  const input = document.getElementById('vd-policy-input');
  if (!input || !input.value.trim()) return;
  const el = document.getElementById('vd-policies');
  if (!el) return;
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;align-items:flex-start;gap:9px;padding:10px 12px;background:rgba(13,148,136,.05);border:1px solid rgba(13,148,136,.18);border-radius:9px;margin-bottom:8px';
  div.innerHTML = `<span style="font-size:14px">✅</span><div style="flex:1;font-size:12.5px;color:var(--ink-mid);line-height:1.5">${input.value.trim()}</div><span style="font-size:10.5px;background:rgba(13,148,136,.1);color:var(--teal);border:1px solid rgba(13,148,136,.2);padding:2px 7px;border-radius:4px;font-weight:600">Active</span>`;
  el.appendChild(div);
  input.value = '';
}

// ── BUILD HOOK ────────────────────────────────────────────────────────────────
function buildHedgingEngine() {
  // Init default tab
  setTimeout(() => {
    vdShowTab('dashboard');
    // Add @keyframes if needed
    if (!document.getElementById('vd-styles')) {
      const st = document.createElement('style');
      st.id = 'vd-styles';
      st.textContent = `
        @keyframes hedge-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.28)} 50%{box-shadow:0 0 14px 2px rgba(16,185,129,.13)} }
        @keyframes pulse-g { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.5)} 50%{box-shadow:0 0 0 6px rgba(16,185,129,0)} }
        .vd-pane { animation: fadeUp .3s both; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
      `;
      document.head.appendChild(st);
    }
  }, 80);
}

// Add nav label update
const _nav_label_update = () => {
  const el = document.getElementById('nav-hedging');
  if (el) {
    el.querySelector('.nav-label').textContent = 'Veridian · Hedging Engine';
  }
};


// ══════════════════════════════════════════════════════════════════════════════
// MODULE: ELASTICITY ENGINE (Lasso regression backbone for PriceOS)
// ══════════════════════════════════════════════════════════════════════════════
const ELASTICITY_DATA = {
  skus: [
    { id: 'det500', name: 'Dettol Liquid 500ml', category: 'Hygiene', basePrice: 11.80, baseVolume: 42000,
      trueElasticity: -1.8, confidence: 91, method: 'LASSO', scannerObs: 8420,
      crossElasticity: { det750: 0.42, harp500: 0.18 } },
    { id: 'det750', name: 'Dettol Liquid 750ml', category: 'Hygiene', basePrice: 15.40, baseVolume: 38000,
      trueElasticity: -2.1, confidence: 87, method: 'LASSO', scannerObs: 7340,
      crossElasticity: { det500: 0.38, harp500: 0.12 } },
    { id: 'harp500', name: 'Harpic Classic 500ml', category: 'Cleaning', basePrice: 8.20, baseVolume: 28000,
      trueElasticity: -1.4, confidence: 84, method: 'RIDGE', scannerObs: 5210,
      crossElasticity: { det500: 0.21, det750: 0.09 } },
    { id: 'finish80', name: 'Finish Tabs 80pk', category: 'Cleaning', basePrice: 12.60, baseVolume: 19000,
      trueElasticity: -3.2, confidence: 78, method: 'LASSO', scannerObs: 4180,
      crossElasticity: { finish40: 0.65, finish120: 0.44 } },
    { id: 'enfam600', name: 'Enfamil Formula 600g', category: 'Nutrition', basePrice: 22.80, baseVolume: 9500,
      trueElasticity: -0.8, confidence: 93, method: 'OLS', scannerObs: 3320,
      crossElasticity: { enfam400: 0.31 } },
    { id: 'harp1l', name: 'Harpic Power 1L', category: 'Cleaning', basePrice: 11.40, baseVolume: 15200,
      trueElasticity: -2.6, confidence: 81, method: 'LASSO', scannerObs: 4760,
      crossElasticity: { harp500: 0.55, det750: 0.14 } },
  ]
};

function computePriceImpact(skuId, priceDelta) {
  const sku = ELASTICITY_DATA.skus.find(s => s.id === skuId);
  if (!sku) return null;
  const pctChange = priceDelta / sku.basePrice;
  const volumeChange = sku.trueElasticity * pctChange;
  const newVolume = sku.baseVolume * (1 + volumeChange);
  const newPrice = sku.basePrice + priceDelta;
  const oldRevenue = sku.basePrice * sku.baseVolume;
  const newRevenue = newPrice * newVolume;
  const revenueDelta = newRevenue - oldRevenue;
  const optimalPrice = sku.basePrice * (1 - 1/(2 * sku.trueElasticity));
  return { pctChange, volumeChange, newVolume, newPrice, oldRevenue, newRevenue, revenueDelta, optimalPrice, sku };
}

function renderElasticityEngine() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">🧮 Elasticity Engine</div>
        <div class="page-sub">SKU-level Lasso regression · ${ELASTICITY_DATA.skus.reduce((a,s)=>a+s.scannerObs,0).toLocaleString()} scanner observations · Causal backbone for Pricing OS</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="lineage-badge" data-source="Lasso/Ridge regression · Scanner data · ${new Date().toLocaleDateString('en-GB')} updated">📊 Model v3.1</span>
        <button class="btn btn-primary" onclick="runElasticityAgent()">⚡ Run Elasticity Agent</button>
      </div>
    </div>

    <!-- Elasticity Grid -->
    <div class="card" style="padding:20px;margin-bottom:16px">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px">SKU Elasticity Matrix</div>
      <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">
        Click any SKU to simulate price changes below · Lasso regression on ${ELASTICITY_DATA.skus.reduce((a,s)=>a+s.scannerObs,0).toLocaleString()} weekly scanner records
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
        ${ELASTICITY_DATA.skus.map(s => {
          const absE = Math.abs(s.trueElasticity);
          const cls = absE < 1.5 ? 'inelastic' : absE < 2.5 ? 'moderate' : 'elastic';
          const col = absE < 1.5 ? 'var(--green)' : absE < 2.5 ? 'var(--amber)' : 'var(--red)';
          return `
          <div class="elasticity-cell ${cls}" onclick="selectElasticitySku('${s.id}')">
            <div class="e-val" style="color:${col}">${s.trueElasticity.toFixed(1)}</div>
            <div class="e-sku">${s.name}</div>
            <div class="e-method">${s.method} · ${s.scannerObs.toLocaleString()} obs · ${s.confidence}% conf</div>
          </div>`;
        }).join('')}
      </div>
      <div style="display:flex;gap:16px;margin-top:14px;font-size:11px">
        <span style="color:var(--green)">● Inelastic (|e|&lt;1.5): price power</span>
        <span style="color:var(--amber)">● Moderate (1.5–2.5): caution</span>
        <span style="color:var(--red)">● Elastic (|e|&gt;2.5): volume sensitive</span>
      </div>
    </div>

    <div class="g-main">
      <!-- Price Simulator -->
      <div>
        <div class="card" style="padding:20px;margin-bottom:14px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">Price Change Simulator</div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:14px" id="elast-sku-label">Select a SKU above to simulate</div>
          
          <div style="margin-bottom:16px">
            <label style="font-size:11px;font-weight:700;color:var(--ink-faint);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:6px">Price Change: <span id="elast-slider-val" style="color:var(--teal)">0%</span></label>
            <input type="range" id="elast-price-slider" min="-20" max="20" value="0" step="0.5"
              style="width:100%;accent-color:var(--teal)"
              oninput="updateElasticitySimulation(this.value)">
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--ink-faint);margin-top:4px">
              <span>−20%</span><span>0%</span><span>+20%</span>
            </div>
          </div>
          
          <div id="elast-simulation-results" style="display:none">
            <!-- Connected Flow -->
            <div class="connected-flow" style="border:none;padding:0;background:transparent;margin-bottom:14px">
              <div class="flow-stage" style="background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--r10)">
                <div class="flow-stage-label">Price Change</div>
                <div class="flow-stage-val" id="sim-price-change" style="color:var(--amber)">—</div>
                <div class="flow-stage-sub">New: <span id="sim-new-price">—</span></div>
                <div class="flow-arrow">→</div>
              </div>
              <div class="flow-stage" style="background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--r10)">
                <div class="flow-stage-label">Volume Impact</div>
                <div class="flow-stage-val" id="sim-vol-change">—</div>
                <div class="flow-stage-sub">Units: <span id="sim-new-vol">—</span></div>
                <div class="flow-arrow">→</div>
              </div>
              <div class="flow-stage" style="background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--r10)">
                <div class="flow-stage-label">Revenue Δ</div>
                <div class="flow-stage-val" id="sim-rev-delta">—</div>
                <div class="flow-stage-sub" id="sim-verdict">—</div>
              </div>
            </div>
            
            <!-- Feed to PriceOS button -->
            <div id="elast-action-zone"></div>
          </div>
        </div>

        <!-- Optimal Price -->
        <div class="card" style="padding:20px">
          <div style="font-size:15px;font-weight:700;margin-bottom:4px">Optimal Price Finder</div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:14px">Calculates revenue-maximizing price from elasticity curve</div>
          <div id="elast-optimal-zone">
            <div style="color:var(--ink-faint);font-size:12px;text-align:center;padding:20px">Select a SKU to see optimal price</div>
          </div>
        </div>
      </div>

      <!-- Right: Agent Trace + Cross-Elasticity -->
      <div>
        <div class="agent-trace" id="elast-agent-trace" style="margin-bottom:14px">
          <div class="agent-trace-header">
            <div class="agent-pulse" id="elast-pulse"></div>
            <div class="agent-trace-title">ELASTICITY AGENT — READY</div>
          </div>
          <div id="elast-trace-steps">
            <div class="agent-step" style="padding:20px 16px;justify-content:center;color:rgba(255,255,255,.25)">
              Click "Run Elasticity Agent" to train models
            </div>
          </div>
        </div>

        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">Cross-Price Elasticities</div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:14px">If Dettol 500ml price +10%, substitution to:</div>
          <div style="position:relative;height:160px;width:100%;"><canvas id="cross-elasticity-chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>`;
}

let activeElasticitySku = null;
let crossElasticityChart = null;

function selectElasticitySku(id) {
  activeElasticitySku = id;
  const sku = ELASTICITY_DATA.skus.find(s => s.id === id);
  if (!sku) return;
  
  document.getElementById('elast-sku-label').textContent = `Simulating: ${sku.name} · Base price £${sku.basePrice.toFixed(2)} · Elasticity ${sku.trueElasticity}`;
  document.getElementById('elast-price-slider').value = 0;
  document.getElementById('elast-slider-val').textContent = '0%';
  document.getElementById('elast-simulation-results').style.display = 'none';
  
  // Show optimal price
  const opt = computePriceImpact(id, sku.basePrice * (1 - 1/(2*sku.trueElasticity)) - sku.basePrice);
  if (opt) {
    document.getElementById('elast-optimal-zone').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="padding:12px 14px;background:var(--surface-alt);border-radius:var(--r10);text-align:center">
          <div style="font-size:10px;color:var(--ink-faint);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">Current Price</div>
          <div style="font-family:'JetBrains Mono';font-size:18px;font-weight:800">£${sku.basePrice.toFixed(2)}</div>
        </div>
        <div style="padding:12px 14px;background:var(--teal-glow);border:1px solid var(--border-m);border-radius:var(--r10);text-align:center">
          <div style="font-size:10px;color:var(--teal);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">Revenue-Max Price</div>
          <div style="font-family:'JetBrains Mono';font-size:18px;font-weight:800;color:var(--teal)">£${opt.optimalPrice.toFixed(2)}</div>
        </div>
      </div>
      <div style="margin-top:12px;padding:12px 14px;background:var(--green-bg);border:1px solid rgba(16,185,129,.2);border-radius:var(--r10)">
        <div style="font-size:12.5px;font-weight:700;color:var(--green)">↑ Revenue-maximizing adjustment: +${((opt.optimalPrice/sku.basePrice-1)*100).toFixed(1)}%</div>
        <div style="font-size:11.5px;color:var(--ink-soft);margin-top:3px">Based on own-price elasticity of ${sku.trueElasticity}. Model confidence: ${sku.confidence}%.</div>
        <button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="feedElasticityToPriceOS('${id}')">→ Feed to Pricing OS</button>
      </div>`;
  }
  
  buildCrossElasticityChart(id);
}

function updateElasticitySimulation(pct) {
  document.getElementById('elast-slider-val').textContent = `${parseFloat(pct)>=0?'+':''}${parseFloat(pct).toFixed(1)}%`;
  if (!activeElasticitySku) return;
  
  const sku = ELASTICITY_DATA.skus.find(s => s.id === activeElasticitySku);
  const priceDelta = sku.basePrice * (parseFloat(pct)/100);
  const r = computePriceImpact(activeElasticitySku, priceDelta);
  if (!r) return;
  
  document.getElementById('elast-simulation-results').style.display = 'block';
  
  const pctStr = `${r.pctChange>=0?'+':''}${(r.pctChange*100).toFixed(1)}%`;
  document.getElementById('sim-price-change').textContent = pctStr;
  document.getElementById('sim-price-change').style.color = r.pctChange >= 0 ? 'var(--amber)' : 'var(--green)';
  document.getElementById('sim-new-price').textContent = `£${r.newPrice.toFixed(2)}`;
  
  const volPct = `${(r.volumeChange*100).toFixed(1)}%`;
  document.getElementById('sim-vol-change').textContent = volPct;
  document.getElementById('sim-vol-change').style.color = r.volumeChange >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('sim-new-vol').textContent = `${Math.round(r.newVolume).toLocaleString()} units`;
  
  const revK = (r.revenueDelta/1000).toFixed(0);
  document.getElementById('sim-rev-delta').textContent = `${r.revenueDelta>=0?'+':''}£${Math.abs(revK)}K`;
  document.getElementById('sim-rev-delta').style.color = r.revenueDelta >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('sim-verdict').textContent = r.revenueDelta >= 0 ? '▲ Revenue positive' : '▼ Revenue negative';
  
  // Action zone
  const actionZone = document.getElementById('elast-action-zone');
  if (Math.abs(parseFloat(pct)) > 0.5) {
    actionZone.innerHTML = `
      <button class="btn btn-primary btn-sm" onclick="applyElasticityPrice('${activeElasticitySku}', ${r.newPrice.toFixed(2)}, ${pct})">
        → Apply ${pctStr} to Pricing OS
      </button>
      <span style="font-size:11px;color:var(--ink-faint);margin-left:10px">Revenue impact: ${r.revenueDelta>=0?'+':''}£${Math.abs(revK)}K/wk</span>`;
  }
}

function applyElasticityPrice(skuId, newPrice, pct) {
  const sku = ELASTICITY_DATA.skus.find(s => s.id === skuId);
  const impact = Math.abs(sku.baseVolume * (sku.basePrice - newPrice) / 1000) * 52 / 1000;
  
  if (impact > 750) {
    requestApproval({
      title: `Reprice ${sku.name} by ${parseFloat(pct)>=0?'+':''}${parseFloat(pct).toFixed(1)}%`,
      detail: `New price: £${newPrice.toFixed(2)} (current: £${sku.basePrice.toFixed(2)}). Annual revenue impact based on elasticity ${sku.trueElasticity}. Model confidence: ${sku.confidence}%.`,
      impact: `~£${impact.toFixed(0)}K/yr`,
      execute: () => executeElasticityPrice(skuId, newPrice, pct)
    });
  } else {
    executeElasticityPrice(skuId, newPrice, pct);
  }
}

function executeElasticityPrice(skuId, newPrice, pct) {
  const sku = ELASTICITY_DATA.skus.find(s => s.id === skuId);
  NS.appliedPrices[skuId] = { price: newPrice, change: pct, ts: Date.now(), time: new Date().toLocaleString('en-GB'), reason: `Elasticity model ${sku.trueElasticity}` };
  NS.elasticityCache[skuId] = { elasticity: sku.trueElasticity, confidence: sku.confidence, method: sku.method, ts: Date.now() };
  saveState();
  logAudit('PRICE APPLIED VIA ELASTICITY', `${sku.name}: £${sku.basePrice.toFixed(2)} → £${newPrice.toFixed(2)} (${parseFloat(pct)>=0?'+':''}${parseFloat(pct).toFixed(1)}%)`, 'success', `${parseFloat(pct)>=0?'+':''}${parseFloat(pct).toFixed(1)}%`);
  showAgentStatus(`✓ Price applied: ${sku.name} → £${newPrice.toFixed(2)} · Elasticity-justified`, 6000);
  
  const actionZone = document.getElementById('elast-action-zone');
  if (actionZone) {
    actionZone.innerHTML = `<div style="padding:8px 12px;background:var(--green-bg);border:1px solid rgba(16,185,129,.2);border-radius:var(--r8);font-size:12px;font-weight:700;color:var(--green)">✓ Applied to Pricing OS at £${newPrice.toFixed(2)} · ${new Date().toLocaleTimeString()}</div>`;
  }
}

function feedElasticityToPriceOS(skuId) {
  const sku = ELASTICITY_DATA.skus.find(s => s.id === skuId);
  NS.elasticityCache[skuId] = { elasticity: sku.trueElasticity, confidence: sku.confidence, method: sku.method, ts: Date.now() };
  saveState();
  logAudit('ELASTICITY FED TO PRICEOS', `${sku.name}: elasticity ${sku.trueElasticity} (${sku.confidence}% conf) · ${sku.method}`, 'info');
  showAgentStatus(`✓ Elasticity data for ${sku.name} fed to Pricing OS`, 5000);
  showModule('pricing-os', document.getElementById('nav-pricing-os'));
}

function buildCrossElasticityChart(skuId) {
  const sku = ELASTICITY_DATA.skus.find(s => s.id === skuId);
  if (!sku) return;
  const ctx = document.getElementById('cross-elasticity-chart');
  if (!ctx) return;
  if (crossElasticityChart) crossElasticityChart.destroy();
  const entries = Object.entries(sku.crossElasticity);
  crossElasticityChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: entries.map(([k]) => {
        const other = ELASTICITY_DATA.skus.find(s => s.id === k);
        return other ? other.name.split(' ').slice(-2).join(' ') : k;
      }),
      datasets: [{
        data: entries.map(([,v]) => v),
        backgroundColor: entries.map(([,v]) => v > 0.3 ? 'rgba(239,68,68,.7)' : 'rgba(245,158,11,.6)'),
        borderRadius: 5
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { max: 1, grid: { color: 'rgba(0,0,0,.04)' }, ticks: { callback: v => `+${(v*100).toFixed(0)}%` } }, x: { grid: { display: false } } }
    }
  });
}

function runElasticityAgent() {
  const traceEl = document.getElementById('elast-trace-steps');
  const pulseEl = document.getElementById('elast-pulse');
  showAgentStatus('⚡ Elasticity agent training models…');
  logAudit('ELASTICITY AGENT STARTED', `Training Lasso/Ridge models on ${ELASTICITY_DATA.skus.reduce((a,s)=>a+s.scannerObs,0).toLocaleString()} observations`, 'info');
  
  const steps = [
    { text: 'Loading scanner data: 33,230 weekly SKU-level observations…', icon: '📦' },
    { text: 'Cleaning: removing promotional outliers, holiday adjustments…', icon: '🧹' },
    { text: 'Feature engineering: own-price, cross-price, seasonality dummies…', icon: '⚙️' },
    { text: 'Running Lasso regression (L1 penalty λ=0.12) for 4 SKUs…', icon: '🔢' },
    { text: 'Running Ridge regression (L2 penalty λ=0.08) for 2 SKUs…', icon: '🔢' },
    { text: 'Cross-validating with 5-fold time-series split…', icon: '✂️' },
    { text: 'Computing confidence intervals via bootstrap (n=1000)…', icon: '📊' },
    { text: `All models converged · R² range: 0.78–0.93 ✓`, icon: '✓' },
  ];

  traceEl.innerHTML = steps.map((s,i) => `
    <div class="agent-step" id="es-${i}">
      <div class="ast-icon">${s.icon}</div>
      <div class="ast-text">${s.text}</div>
      ${i < 7 ? `<div class="ast-conf" id="es-conf-${i}"></div>` : ''}
    </div>`).join('');

  let i = 0;
  const confs = [null, null, null, '84%', '79%', '91%', '88%', null];
  const tick = setInterval(() => {
    if (i > 0) {
      const prev = document.getElementById(`es-${i-1}`);
      if (prev) { prev.className = 'agent-step done'; prev.querySelector('.ast-icon').textContent = '✓'; }
    }
    if (i < steps.length) {
      const cur = document.getElementById(`es-${i}`);
      if (cur) { cur.className = 'agent-step active'; }
      if (confs[i]) {
        const c = document.getElementById(`es-conf-${i}`);
        if (c) c.textContent = confs[i];
      }
      i++;
    } else {
      clearInterval(tick);
      pulseEl.style.background = 'var(--green)';
      document.querySelector('.agent-trace-title').textContent = 'ELASTICITY AGENT — MODELS READY';
      logAudit('ELASTICITY MODELS READY', `6 SKUs trained · Avg conf 85.7% · Lasso/Ridge/OLS`, 'success');
      showAgentStatus('✓ Elasticity models trained — click any SKU to simulate prices', 6000);
    }
  }, 450);
}

function buildElasticityEngine() {
  buildCrossElasticityChart('det500');
  selectElasticitySku('det500');
}

// ══════════════════════════════════════════════════════════════════════════════
// MODULE: PROMO UPLIFT DECOMPOSITION (DFO-style)
// ══════════════════════════════════════════════════════════════════════════════
const PROMO_DATA = [
  { week: 'W1 Jan', baseline: 1820, promoLift: 0, promo: false },
  { week: 'W2 Jan', baseline: 1840, promoLift: 0, promo: false },
  { week: 'W3 Jan', baseline: 1790, promoLift: 380, promo: true, type: 'BOGOF', channel: 'Superstore', depth: 20 },
  { week: 'W4 Jan', baseline: 1810, promoLift: 0, promo: false },
  { week: 'W1 Feb', baseline: 1850, promoLift: 0, promo: false },
  { week: 'W2 Feb', baseline: 1830, promoLift: 540, promo: true, type: 'Price Off -15%', channel: 'Chemist', depth: 15 },
  { week: 'W3 Feb', baseline: 1860, promoLift: 120, promo: true, type: 'Display + TPR', channel: 'Online', depth: 8 },
  { week: 'W4 Feb', baseline: 1880, promoLift: 0, promo: false },
  { week: 'W1 Mar', baseline: 1900, promoLift: 620, promo: true, type: 'Spring Event', channel: 'All', depth: 18 },
  { week: 'W2 Mar', baseline: 1910, promoLift: 0, promo: false },
  { week: 'W3 Mar', baseline: 1950, promoLift: 0, promo: false },
  { week: 'W4 Mar', baseline: 1940, promoLift: 290, promo: true, type: 'End-of-Month', channel: 'Superstore', depth: 12 },
];

function renderPromoDecomposition() {
  const totalActual = PROMO_DATA.reduce((a,w) => a + w.baseline + w.promoLift, 0);
  const totalBaseline = PROMO_DATA.reduce((a,w) => a + w.baseline, 0);
  const totalPromo = PROMO_DATA.reduce((a,w) => a + w.promoLift, 0);
  const promoContrib = (totalPromo / totalActual * 100).toFixed(1);
  const promoWeeks = PROMO_DATA.filter(w => w.promo).length;
  const avgLift = (totalPromo / promoWeeks / PROMO_DATA.filter(w=>w.promo).reduce((a,w)=>a+w.baseline,0) * PROMO_DATA.filter(w=>w.promo).length * 100 / promoWeeks).toFixed(1);

  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">📦 Promo Uplift Decomposition</div>
        <div class="page-sub">DFO-style baseline/lift separation · Wmape ≤25% · Promo ROI analytics · Dettol 500ml · Jan–Mar 2026</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="lineage-badge" data-source="SAP · Nielsen POS · ERP promo calendar">📅 Live promo data</span>
        <button class="btn btn-primary" onclick="runPromoAgent()">⚡ Run Decomposition Agent</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="g4" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Total Volume (13wk)</div>
        <div class="kpi-val">${totalActual.toLocaleString()}</div>
        <div class="kpi-delta neutral">units · Dettol 500ml</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">Baseline Volume</div>
        <div class="kpi-val">${totalBaseline.toLocaleString()}</div>
        <div class="kpi-delta up">${(100-parseFloat(promoContrib)).toFixed(1)}% of total</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--pink)">
        <div class="kpi-label">Promo Uplift Volume</div>
        <div class="kpi-val">${totalPromo.toLocaleString()}</div>
        <div class="kpi-delta neutral">${promoContrib}% of total · ${promoWeeks} promo weeks</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">Avg Uplift per Promo</div>
        <div class="kpi-val">+${avgLift}%</div>
        <div class="kpi-delta down">Promo ROI tracked below</div>
      </div>
    </div>

    <!-- Agent Trace -->
    <div class="agent-trace" id="promo-agent-trace" style="margin-bottom:16px">
      <div class="agent-trace-header">
        <div class="agent-pulse" id="promo-pulse"></div>
        <div class="agent-trace-title">PROMO DECOMPOSITION AGENT — READY</div>
        <span style="margin-left:auto;font-size:10px;color:rgba(255,255,255,.3)" id="promo-trace-ts"></span>
      </div>
      <div id="promo-trace-steps">
        <div class="agent-step" style="padding:20px 16px;justify-content:center;color:rgba(255,255,255,.25)">Click "Run Decomposition Agent" to separate baseline from promo volume</div>
      </div>
    </div>

    <!-- Decomposed Chart -->
    <div class="card" style="padding:20px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div>
          <div style="font-size:15px;font-weight:700">Baseline vs Promo Volume Decomposition</div>
          <div style="font-size:11.5px;color:var(--ink-soft)">Stacked view — every Excel finance team does this manually, Nervure automates it</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <span style="display:flex;align-items:center;gap:5px;font-size:11.5px"><span style="width:10px;height:10px;background:var(--teal);border-radius:2px;display:inline-block"></span>Baseline</span>
          <span style="display:flex;align-items:center;gap:5px;font-size:11.5px"><span style="width:10px;height:10px;background:var(--pink);border-radius:2px;display:inline-block"></span>Promo Uplift</span>
        </div>
      </div>
      <div style="position:relative;height:220px;width:100%;"><canvas id="promo-decomp-chart"></canvas></div>
    </div>

    <!-- Promo Events Table + ROI -->
    <div class="g2">
      <div class="card" style="overflow:hidden">
        <div class="card-header">
          <div class="card-title">Promo Event Analysis</div>
          <div class="card-sub">Lift, ROI and payback per promotion</div>
        </div>
        <div class="tbl-head" style="grid-template-columns:80px 1fr 70px 70px 70px 60px">
          <span>Week</span><span>Promo Type</span><span>Channel</span><span>Depth</span><span>Uplift</span><span>ROI</span>
        </div>
        <div id="promo-events-table"></div>
      </div>

      <div>
        <div class="card" style="padding:20px;margin-bottom:14px">
          <div style="font-size:14px;font-weight:700;margin-bottom:14px">Promo Uplift by Channel</div>
          <div style="position:relative;height:180px;width:100%;"><canvas id="promo-channel-chart"></canvas></div>
        </div>
        <div class="card" style="padding:20px">
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">Forward Forecast</div>
          <div style="font-size:11.5px;color:var(--ink-soft);margin-bottom:12px">Next 4 weeks · With and without promo</div>
          ${[
            ['W1 Apr','No promo','1,960','1,960'],
            ['W2 Apr','Price Off -12%','1,980','2,520'],
            ['W3 Apr','No promo','1,970','1,970'],
            ['W4 Apr','Spring burst','1,990','2,680'],
          ].map(([w,type,base,total])=>`
            <div style="padding:9px 0;border-bottom:1px solid var(--border-s)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <div style="font-size:12.5px;font-weight:600">${w} · ${type}</div>
                <div style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:${total!==base?'var(--pink)':'var(--teal)'}">${total}</div>
              </div>
              <div class="promo-bar-wrap">
                <div class="promo-bar-base" style="width:${(parseInt(base.replace(',',''))/3000*100).toFixed(0)}%"></div>
                ${total!==base?`<div class="promo-bar-lift" style="left:${(parseInt(base.replace(',',''))/3000*100).toFixed(0)}%;width:${((parseInt(total.replace(',',''))-parseInt(base.replace(',','')))/3000*100).toFixed(0)}%"></div>`:''}
              </div>
              <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--ink-faint);margin-top:3px">
                <span>Baseline: ${base}</span>
                ${total!==base?`<span style="color:var(--pink)">Promo lift: +${(parseInt(total.replace(',',''))-parseInt(base.replace(',',''))).toLocaleString()}</span>`:''}
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

let promoDecompChart = null;
let promoChannelChart = null;

function buildPromoDecomposition() {
  buildPromoDecompChart();
  buildPromoEventsTable();
  buildPromoChannelChart();
}

function buildPromoDecompChart() {
  const ctx = document.getElementById('promo-decomp-chart');
  if (!ctx) return;
  if (promoDecompChart) promoDecompChart.destroy();
  promoDecompChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: PROMO_DATA.map(w => w.week),
      datasets: [
        { label: 'Baseline', data: PROMO_DATA.map(w => w.baseline), backgroundColor: 'rgba(13,148,136,.7)', borderRadius: 3 },
        { label: 'Promo Uplift', data: PROMO_DATA.map(w => w.promoLift), backgroundColor: 'rgba(255,45,120,.7)', borderRadius: 3 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, grid: { color: 'rgba(0,0,0,.04)' }, title: { display: true, text: 'Volume (units)' } } },
      plugins: { legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 10 } } }
    }
  });
}

function buildPromoEventsTable() {
  const el = document.getElementById('promo-events-table');
  if (!el) return;
  const promoEvents = PROMO_DATA.filter(w => w.promo);
  el.innerHTML = promoEvents.map(w => {
    const upliftPct = (w.promoLift / w.baseline * 100).toFixed(0);
    const roi = (w.promoLift * 11.80 / (w.promoLift * 11.80 * w.depth / 100) * 100 - 100).toFixed(0);
    return `
    <div class="tbl-row" style="grid-template-columns:80px 1fr 70px 70px 70px 60px">
      <div style="font-family:'JetBrains Mono';font-size:11.5px">${w.week}</div>
      <div>
        <div style="font-size:12.5px;font-weight:600">${w.type}</div>
      </div>
      <div style="font-size:11.5px;color:var(--ink-soft)">${w.channel}</div>
      <div style="font-family:'JetBrains Mono';font-size:12px;color:var(--amber)">−${w.depth}%</div>
      <div style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:var(--pink)">+${upliftPct}%</div>
      <div style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:${parseInt(roi)>=100?'var(--green)':'var(--red)'}">${roi}%</div>
    </div>`;
  }).join('');
}

function buildPromoChannelChart() {
  const ctx = document.getElementById('promo-channel-chart');
  if (!ctx) return;
  if (promoChannelChart) promoChannelChart.destroy();
  const channels = {};
  PROMO_DATA.filter(w=>w.promo).forEach(w => {
    channels[w.channel] = (channels[w.channel] || 0) + w.promoLift;
  });
  promoChannelChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(channels),
      datasets: [{ data: Object.values(channels), backgroundColor: ['rgba(13,148,136,.75)','rgba(255,45,120,.75)','rgba(245,158,11,.75)','rgba(59,130,246,.75)'], borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 10 } } } }
  });
}

function runPromoAgent() {
  const traceEl = document.getElementById('promo-trace-steps');
  const pulseEl = document.getElementById('promo-pulse');
  const tsEl = document.getElementById('promo-trace-ts');
  tsEl.textContent = new Date().toLocaleTimeString();
  showAgentStatus('⚡ Promo decomposition agent running…');
  logAudit('PROMO AGENT STARTED', 'Decomposing 13-week volume into baseline + promo uplift', 'info');
  
  const steps = [
    { text: 'Loading 13-week POS scanner data from SAP…', icon: '📥', conf: null },
    { text: 'Identifying promo calendar events from ERP…', icon: '📅', conf: null },
    { text: 'Fitting dynamic regression on baseline volume…', icon: '📈', conf: '91%' },
    { text: 'Decomposing promo uplift from 4 promotion types…', icon: '✂️', conf: '88%' },
    { text: 'Computing channel-level ROI per promo event…', icon: '💰', conf: null },
    { text: 'Running Wmape validation: 18.4% (target ≤25%) ✓', icon: '✓', conf: null },
    { text: 'Forward forecast computed for W1–W4 Apr 2026 ✓', icon: '✓', conf: null },
  ];
  
  traceEl.innerHTML = steps.map((s,i) => `
    <div class="agent-step" id="ps-${i}">
      <div class="ast-icon">${s.icon}</div>
      <div class="ast-text">${s.text}</div>
      ${s.conf ? `<div class="ast-conf">${s.conf}</div>` : ''}
    </div>`).join('');
    
  let i = 0;
  const tick = setInterval(() => {
    if (i > 0) {
      const prev = document.getElementById(`ps-${i-1}`);
      if (prev) { prev.className = 'agent-step done'; prev.querySelector('.ast-icon').textContent = '✓'; }
    }
    if (i < steps.length) {
      document.getElementById(`ps-${i}`).className = 'agent-step active';
      i++;
    } else {
      clearInterval(tick);
      pulseEl.style.background = 'var(--green)';
      document.querySelector('#promo-agent-trace .agent-trace-title').textContent = 'PROMO AGENT — DECOMPOSITION COMPLETE';
      logAudit('PROMO DECOMPOSITION COMPLETE', 'Baseline + promo uplift separated · Wmape 18.4% · Forward forecast ready', 'success');
      showAgentStatus('✓ Promo decomposition complete · Wmape 18.4% · Within target ≤25%', 7000);
      // Show action zone after agent completes
      const actionZone = document.createElement('div');
      actionZone.style.cssText = 'margin-top:12px;padding:12px 14px;background:rgba(13,148,136,.06);border:1px solid rgba(13,148,136,.15);border-radius:10px;display:flex;align-items:center;gap:12px;flex-wrap:wrap';
      actionZone.innerHTML = '<span style="font-size:12.5px;font-weight:700;color:var(--teal)">✓ Model ready</span><span style="font-size:11.5px;color:var(--ink-soft);flex:1">13-week decomposition complete · Wmape 18.4%</span>' +
        '<button class="btn btn-primary btn-sm" onclick="lockPromoForecast()">→ Lock Forecast in Demand Module</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="showModule(\'demand\',document.getElementById(\'nav-demand\'))">→ View Demand Forecast</button>';
      document.getElementById('promo-agent-trace').insertAdjacentElement('afterend', actionZone);
    }
  }, 500);
}

// ══════════════════════════════════════════════════════════════════════════════
// GLOBAL AUDIT LOG MODULE
// ══════════════════════════════════════════════════════════════════════════════
function renderAuditLog() {
  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">📋 Audit Log & Decision Trail</div>
        <div class="page-sub">All agent actions · Approvals · Price changes · Hedge executions · Persists across sessions</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="lineage-badge" data-source="localStorage · ${NS.auditLog.length} entries">💾 ${NS.auditLog.length} entries</span>
        <button class="btn btn-ghost" onclick="if(confirm('Clear audit log?')){NS.auditLog=[];saveState();showModule('audit',document.getElementById('nav-audit'))}">🗑 Clear Log</button>
      </div>
    </div>
    
    <div class="card" style="overflow:hidden">
      <div class="card-header">
        <div class="card-title">Full Decision Audit Trail</div>
        <div class="card-sub">Board-ready reasoning for every recommendation · IFRS 9 compliant</div>
      </div>
      ${NS.auditLog.length === 0 
        ? `<div style="padding:40px;text-align:center;color:var(--ink-faint)">No actions recorded yet. Use the Hedging Engine, Elasticity Engine, or Promo Decomposition to generate entries.</div>`
        : NS.auditLog.map(e => `
          <div class="audit-item">
            <div class="audit-dot" style="background:${e.type==='success'?'var(--green)':e.type==='error'?'var(--red)':e.type==='warning'?'var(--amber)':'var(--teal)'}"></div>
            <div class="audit-time">${e.time}</div>
            <div style="flex:1">
              <div class="audit-action">${e.action}</div>
              <div class="audit-detail">${e.detail}</div>
            </div>
            ${e.value ? `<div style="font-family:'JetBrains Mono';font-size:12px;font-weight:700;color:var(--green);flex-shrink:0">${e.value}</div>` : ''}
          </div>`).join('')
      }
    </div>
  </div>`;
}

// ══════════════════════════════════════════════════════════════════════════════
// PATCH: getModuleHTML + afterModuleRender + sidebar nav
// ══════════════════════════════════════════════════════════════════════════════
// Override getModuleHTML to add new modules
const _origGetModuleHTML = getModuleHTML;
getModuleHTML = function(m) {
  switch(m) {
    case 'hedging': return renderHedgingEngine();
    case 'elasticity': return renderElasticityEngine();
    case 'promo': return renderPromoDecomposition();
    case 'audit': return renderAuditLog();
    case 'gst': return renderGSTEngine();
    default: return _origGetModuleHTML(m);
  }
};

// Override afterModuleRender
const _origAfterModuleRender = afterModuleRender;
afterModuleRender = function(m) {
  switch(m) {
    case 'hedging': buildHedgingEngine(); break;
    case 'elasticity': buildElasticityEngine(); break;
    case 'promo': buildPromoDecomposition(); break;
    case 'audit': updateAuditBadge(); break;
    case 'gst': buildGSTEngine(); break;
    default: _origAfterModuleRender(m);
  }
};

// Override showModule breadcrumb labels
const _origShowModule = showModule;
showModule = function(module, navEl) {
  const extraLabels = {
    hedging: 'Hedging Engine',
    elasticity: 'Elasticity Engine',
    promo: 'Promo Decomposition',
    audit: 'Audit Log',
    gst: 'GST ITC Engine'
  };
  if (extraLabels[module]) {
    currentModule = module;
    document.querySelectorAll('.nav-item, .nav-sub-item').forEach(n => n.classList.remove('active'));
    if (navEl) navEl.classList.add('active');
    document.getElementById('topbar-breadcrumb').innerHTML = 
      `<span style="color:var(--ink-faint)">NERVURE</span>
       <span style="color:var(--ink-ghost)">›</span>
       <strong>${extraLabels[module]}</strong>`;
    document.getElementById('eu-ai-badge-wrap').style.display = 'none';
    
    // Destroy ALL Chart.js instances before switching modules
    Chart.helpers && Chart.helpers.each && Chart.helpers.each(Chart.instances, (c) => { try { c.destroy(); } catch(e){} });
    // Also destroy named instances
    [scenarioChart, hedgeFuturesChart, crossElasticityChart, promoDecompChart, promoChannelChart].forEach(c => {
      try { c && c.destroy(); } catch(e) {}
    });
    Object.values(activeCharts).forEach(c => { try { c && c.destroy(); } catch(e){} });
    activeCharts = {};
    hedgeFuturesChart = null; crossElasticityChart = null; promoDecompChart = null; promoChannelChart = null;
    
    requestAnimationFrame(() => {
      const content = document.getElementById('content');
      content.innerHTML = getModuleHTML(module);
      requestAnimationFrame(() => {
        afterModuleRender(module);
      });
    });
  } else {
    _origShowModule(module, navEl);
  }
};

// ── PATCH SIDEBAR: Add new nav items ─────────────────────────────────────────
const _origBuildSidebar = buildSidebar;
buildSidebar = function() {
  _origBuildSidebar();
  
  // Inject new nav items into Financial Planning section
  const priceOSItem = document.getElementById('nav-pricing-os');
  if (priceOSItem && priceOSItem.parentElement) {
    const parent = priceOSItem.parentElement;
    
    // Add Elasticity Engine after Pricing OS
    if (!document.getElementById('nav-elasticity')) {
      const elast = document.createElement('div');
      elast.className = 'nav-sub-item';
      elast.id = 'nav-elasticity';
      elast.innerHTML = `<span class="nav-icon" style="font-size:13px">🧮</span><span class="nav-label">Elasticity Engine</span><span class="pricing-os-badge" style="background:var(--blue)">NEW</span>`;
      elast.onclick = function() { showModule('elasticity', this); };
      priceOSItem.insertAdjacentElement('afterend', elast);
    }
    
    // Add Promo Decomposition
    if (!document.getElementById('nav-promo')) {
      const promo = document.createElement('div');
      promo.className = 'nav-sub-item';
      promo.id = 'nav-promo';
      promo.innerHTML = `<span class="nav-icon" style="font-size:13px">📦</span><span class="nav-label">Promo Decomposition</span><span class="pricing-os-badge" style="background:var(--pink)">NEW</span>`;
      promo.onclick = function() { showModule('promo', this); };
      const elastItem = document.getElementById('nav-elasticity');
      elastItem.insertAdjacentElement('afterend', promo);
    }
  }
  
  // Add Hedging Engine after Commodity Desk
  const commItem = document.getElementById('nav-commodity');
  if (commItem && !document.getElementById('nav-hedging')) {
    const hed = document.createElement('div');
    hed.className = 'nav-sub-item';
    hed.id = 'nav-hedging';
    hed.innerHTML = `<span class="nav-icon" style="font-size:13px">◈</span><span class="nav-label">Veridian · Hedging</span><span class="pricing-os-badge" style="background:var(--teal);color:#fff">+£4M</span>`;
    hed.onclick = function() { showModule('hedging', this); };
    commItem.insertAdjacentElement('afterend', hed);
  }
  
  // Add Audit Log before Settings
  const settingsItem = document.getElementById('nav-settings');
  if (settingsItem && !document.getElementById('nav-audit')) {
    const aud = document.createElement('div');
    aud.className = 'nav-item';
    aud.id = 'nav-audit';
    aud.innerHTML = `<span class="nav-icon">📋</span><span class="nav-label">Audit Log</span><span class="nav-badge teal" id="audit-badge">0</span>`;
    aud.onclick = function() { showModule('audit', this); };
    settingsItem.insertAdjacentElement('beforebegin', aud);
  }
  
  updateAuditBadge();
};

// ── PATCH PRICING OS: Show elasticity data if available ──────────────────────
// Override the live strip to derive numbers from state when elasticity is available
const _origBuildPricingOS = typeof buildPricingOS !== 'undefined' ? buildPricingOS : null;
if (_origBuildPricingOS) {
  buildPricingOS = function() {
    _origBuildPricingOS();
    // After DOM renders, refresh the live strip from real NS state
    requestAnimationFrame(() => {
      refreshPricingOSStrip();
      
      // Show data lineage badges if we have real data
      const hasElasticity = Object.keys(NS.elasticityCache || {}).length > 0;
      const hasApplied = Object.keys(NS.appliedPrices || {}).length > 0;
      const hasHedge = Object.keys(NS.hedgePositions || {}).length > 0;
      
      if (hasElasticity || hasApplied || hasHedge) {
        const strip = document.querySelector('.live-strip');
        if (strip && !document.getElementById('pos-data-lineage')) {
          const banner = document.createElement('div');
          banner.id = 'pos-data-lineage';
          banner.style.cssText = 'margin-bottom:14px;padding:10px 16px;background:rgba(13,148,136,.06);border:1px solid rgba(13,148,136,.15);border-radius:10px;display:flex;align-items:center;gap:10px;font-size:11.5px;color:var(--teal)';
          const sources = [];
          if (hasElasticity) sources.push('Elasticity Engine (' + Object.keys(NS.elasticityCache).length + ' SKUs)');
          if (hasApplied) sources.push('Applied Prices (' + Object.keys(NS.appliedPrices).length + ' SKUs)');
          if (hasHedge) sources.push('Hedge Engine (' + Object.keys(NS.hedgePositions).length + ' commodities)');
          banner.innerHTML = '<span style="font-size:16px">📡</span><span><strong>Live data from:</strong> ' + sources.join(' · ') + '</span>';
          strip.insertAdjacentElement('beforebegin', banner);
        }
      }
    });
  };
}


// ── ALERT() REPLACEMENTS — proper handlers ────────────────────────────────
function executeAllOracleRecs() {
  COMMODITIES.forEach(c => {
    const newCov = Math.min(90, c.cov + Math.round(Math.random()*8+3));
    c.cov = newCov;
    NS.hedgePositions[c.id] = NS.hedgePositions[c.id] || {};
    NS.hedgePositions[c.id].coverage = newCov;
    NS.hedgePositions[c.id].ts = Date.now();
  });
  saveState();
  logAudit('ORACLE: ALL RECS ACCEPTED', 'Coverage updated for ' + COMMODITIES.length + ' commodities via Oracle Engine', 'success');
  showAgentStatus('✓ All Oracle recommendations applied · ' + COMMODITIES.length + ' commodities updated', 6000);
  buildSidebar();
}

function executeOracleRec(id, newCov) {
  const c = COMMODITIES.find(x => x.id === id);
  if (c) { c.cov = newCov; }
  NS.hedgePositions[id] = NS.hedgePositions[id] || {};
  NS.hedgePositions[id].coverage = newCov;
  NS.hedgePositions[id].ts = Date.now();
  saveState();
  logAudit('ORACLE REC ACCEPTED', (c ? c.name : id) + ' → coverage ' + newCov + '%', 'success', newCov + '%');
  showAgentStatus('✓ Oracle recommendation accepted · ' + (c ? c.name : id) + ' → ' + newCov + '%', 5000);
  const btn = event.target;
  btn.textContent = '✓ Applied';
  btn.disabled = true;
  btn.style.opacity = '0.6';
}

function applyPricingOSAction(sku, price, action) {
  NS.appliedPrices[sku] = { price, change: 0, ts: Date.now(), time: new Date().toLocaleString('en-GB'), reason: 'PriceOS autopilot' };
  saveState();
  logAudit('PRICEOS ACTION APPLIED', sku + ': ' + action + ' → ' + price, 'success', price);
  showAgentStatus('✓ Price applied: ' + sku + ' → ' + price, 5000);
  refreshPricingOSStrip();
  const btn = event.target;
  btn.textContent = '✓ Applied';
  btn.style.background = 'var(--green)';
  btn.disabled = true;
}

function exportAllReports() {
  logAudit('BATCH EXPORT INITIATED', 'All reports queued for export · PDF + XLSX', 'info');
  showAgentStatus('⬇ Generating all reports… (demo: logged to audit trail)', 5000);
}

function exportReport(title) {
  logAudit('REPORT EXPORTED', title, 'info');
  showAgentStatus('⬇ ' + title + ' generated (demo mode)', 4000);
}

function downloadData(name) {
  logAudit('DATA DOWNLOAD', name, 'info');
  showAgentStatus('⬇ Downloading: ' + name + ' (demo mode)', 3000);
}

function saveSettings(btn) {
  logAudit('SETTINGS SAVED', 'User preferences updated', 'success');
  showAgentStatus('✓ Settings saved', 3000);
  if (btn) { btn.textContent = '✓ Saved'; setTimeout(() => { btn.textContent = 'Save Changes'; }, 2000); }
}

function lockPromoForecast() {
  NS.promoDecomp = {
    locked: true,
    ts: Date.now(),
    time: new Date().toLocaleString('en-GB'),
    wmape: 18.4,
    promoWeeks: 4,
    totalLift: 1950
  };
  saveState();
  logAudit('PROMO FORECAST LOCKED', 'Baseline/uplift decomposition locked · Wmape 18.4% · Propagated to Demand module', 'success');
  showAgentStatus('✓ Promo forecast locked · Demand module updated', 5000);
}
// ══════════════════════════════════════════════════════════════════════════════
// MODULE: GST ITC ENGINE — India's #1 CPG Cash Flow Pain Point
// ₹2-8 crore ITC locked per ₹100Cr revenue — Nervure unlocks it
// ══════════════════════════════════════════════════════════════════════════════
const GST_DATA = {
  itcSummary: {
    eligible: 14.2, claimed: 11.8, unclaimed: 2.4, blocked: 0.8,
    pendingMatch: 1.6, reversal: 0.3
  },
  mismatches: [
    { gstin: '27AADCK2516N1Z1', supplier: 'Hindustan Polymers Pvt Ltd', period: 'Jan 2026', gstr1: 48.2, gstr3b: 0, delta: 48.2, slab: '18%', risk: 'HIGH', category: 'Raw Material', action: 'GSTR-2B absent' },
    { gstin: '29AAACI2875F1ZK', supplier: 'Kerala Chemicals Ltd', period: 'Feb 2026', gstr1: 12.4, gstr3b: 12.4, delta: 0, slab: '12%', risk: 'CLEAR', category: 'Packaging', action: 'Matched' },
    { gstin: '07AABCP1234R1ZD', supplier: 'Delhi Fragrance House', period: 'Jan 2026', gstr1: 31.6, gstr3b: 28.0, delta: 3.6, slab: '18%', risk: 'MEDIUM', category: 'Actives', action: 'Partial mismatch' },
    { gstin: '33AAFCI4789M1ZP', supplier: 'Tamil Nadu Cartons', period: 'Feb 2026', gstr1: 8.7, gstr3b: 0, delta: 8.7, slab: '12%', risk: 'HIGH', category: 'Packaging', action: 'Supplier GSTR-1 not filed' },
    { gstin: '24AAACH2961G1ZA', supplier: 'Gujarat Surfactants', period: 'Mar 2026', gstr1: 22.1, gstr3b: 22.1, delta: 0, slab: '18%', risk: 'CLEAR', category: 'Raw Material', action: 'Matched' },
    { gstin: '09AABCP8891N1ZQ', supplier: 'UP Logistics Co', period: 'Feb 2026', gstr1: 5.2, gstr3b: 9.1, delta: -3.9, slab: '5%', risk: 'MEDIUM', category: 'Freight', action: 'Excess in 3B — reversal required' },
  ],
  workingCapital: {
    itcLocked: 2.4, avgReleaseDays: 47, potentialInterestSaved: 0.18, 
    suppliersPending: 23, highRiskSuppliers: 7
  },
  gstSlabs: [
    { slab: '28% + Cess', spend: 12.4, itc: 3.5, category: 'Luxury/Tobacco inputs' },
    { slab: '18%', spend: 84.2, itc: 15.2, category: 'Most CPG actives' },
    { slab: '12%', spend: 38.6, itc: 4.6, category: 'Packaging, processing' },
    { slab: '5%', spend: 22.1, itc: 1.1, category: 'Freight, basic materials' },
    { slab: '0%', spend: 14.8, itc: 0, category: 'Food items, exempted' },
  ]
};

function renderGSTEngine() {
  const d = GST_DATA;
  const riskColor = r => r==='HIGH'?'var(--red)':r==='MEDIUM'?'var(--amber)':'var(--green)';
  const riskBadge = r => r==='HIGH'?'badge-red':r==='MEDIUM'?'badge-amber':'badge-buy';

  return `
  <div class="animate-in">
    <div class="page-header">
      <div>
        <div class="page-title">🇮🇳 GST ITC Intelligence Engine</div>
        <div class="page-sub">GSTR-1 × GSTR-3B reconciliation · ITC blocking detection · Working capital unlock · India CPG compliance</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span style="padding:5px 12px;background:rgba(255,153,0,.08);border:1px solid rgba(255,153,0,.25);border-radius:8px;font-size:11px;font-weight:700;color:#ff9900">⚠ ₹2.4Cr ITC at risk</span>
        <button class="btn btn-primary" onclick="runGSTReconciliation()">⚡ Run Auto-Reconciliation</button>
      </div>
    </div>

    <!-- Pain point banner -->
    <div style="background:linear-gradient(135deg,#0a1a18 0%,#1a0a00 60%,#0d0a00 100%);border-radius:var(--r16);padding:22px 28px;margin-bottom:18px;position:relative;overflow:hidden;border:1px solid rgba(255,153,0,.2);box-shadow:0 8px 32px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.08)">
      <div style="position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(255,153,0,.14) 0%,transparent 70%);pointer-events:none"></div>
      <div style="position:relative;z-index:1">
        <div style="font-size:10.5px;color:#ffb347;font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px">India CPG — #1 Cash Flow Destroyer</div>
        <div style="font-size:19px;font-weight:800;color:white;line-height:1.25;margin-bottom:8px;letter-spacing:-.01em">
          Every ₹100Cr revenue = <span style="color:#ffb347">₹2–8Cr ITC locked</span> in GSTN mismatches
        </div>
        <div style="font-size:13px;color:rgba(255,255,255,.6);line-height:1.65;max-width:640px">
          Nervure cross-matches your purchase register against GSTR-2B in real-time, flags supplier non-filers before Section 16(2) denial kicks in, and orchestrates automated follow-up — releasing working capital 47 days faster than manual teams.
        </div>
      </div>
    </div>

    <!-- KPI Row -->
    <div class="g4 animate-in-delay-1" style="margin-bottom:16px">
      <div class="kpi" style="--kpi-accent:var(--red)">
        <div class="kpi-label">ITC Unclaimed / At-Risk</div>
        <div class="kpi-val" style="color:var(--red)">₹${d.itcSummary.unclaimed}Cr</div>
        <div class="kpi-delta down">↓ ${d.workingCapital.suppliersPending} suppliers pending</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--amber)">
        <div class="kpi-label">ITC Blocked (Section 17(5))</div>
        <div class="kpi-val" style="color:var(--amber)">₹${d.itcSummary.blocked}Cr</div>
        <div class="kpi-delta down">Ineligible inputs flagged</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--green)">
        <div class="kpi-label">ITC Successfully Claimed</div>
        <div class="kpi-val" style="color:var(--green)">₹${d.itcSummary.claimed}Cr</div>
        <div class="kpi-delta up">↑ ${Math.round(d.itcSummary.claimed/d.itcSummary.eligible*100)}% of eligible</div>
      </div>
      <div class="kpi" style="--kpi-accent:var(--teal)">
        <div class="kpi-label">Interest Saved (Est.)</div>
        <div class="kpi-val" style="color:var(--teal)">₹${d.workingCapital.potentialInterestSaved}Cr</div>
        <div class="kpi-sub">If released in 7 days vs 47 days · SBI CC rate 8.5%</div>
      </div>
    </div>

    <!-- Mismatch Table -->
    <div class="card animate-in-delay-2" style="overflow:hidden;margin-bottom:16px">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="card-title">GSTR-1 × GSTR-3B Mismatch Ledger</div>
          <div class="card-sub">Live reconciliation · Jan–Mar 2026 · Auto-sourced from GSTN API</div>
        </div>
        <div style="display:flex;gap:6px">
          <span class="badge badge-red">7 High Risk</span>
          <button class="btn btn-ghost btn-sm" onclick="showAgentStatus('⬇ ITC Mismatch Report exported (demo)', 4000)">⬇ Export</button>
        </div>
      </div>
      <div class="tbl-head" style="grid-template-columns:160px 1fr 80px 70px 70px 80px 80px 90px">
        <span>GSTIN</span><span>Supplier</span><span>Period</span><span>GSTR-1 ₹L</span><span>3B ₹L</span><span>Delta</span><span>Risk</span><span>Action</span>
      </div>
      ${d.mismatches.map(m => `
      <div class="tbl-row" style="grid-template-columns:160px 1fr 80px 70px 70px 80px 80px 90px;${m.risk==='HIGH'?'background:rgba(239,68,68,.03);':m.risk==='MEDIUM'?'background:rgba(245,158,11,.02);':''}">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--ink-soft)">${m.gstin}</div>
        <div>
          <div style="font-size:12.5px;font-weight:600">${m.supplier}</div>
          <div style="font-size:10.5px;color:var(--teal)">${m.category} · ${m.slab} GST</div>
        </div>
        <div style="font-size:12px;color:var(--ink-soft)">${m.period}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700">${m.gstr1}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700;color:${m.gstr3b===0?'var(--red)':'var(--ink)'}">${m.gstr3b||'—'}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:700;color:${Math.abs(m.delta)>0?riskColor(m.risk):'var(--green)'}">${m.delta>0?'+':''}${m.delta!==0?m.delta.toFixed(1):'✓'}</div>
        <span class="badge ${riskBadge(m.risk)}">${m.risk}</span>
        <div style="font-size:11px;color:var(--ink-soft)">${m.action}</div>
      </div>`).join('')}
    </div>

    <!-- 2-col: GST Slab Breakdown + Working Capital Impact -->
    <div class="g2 animate-in-delay-3">
      <div class="card" style="padding:20px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">ITC by GST Slab</div>
        <div style="font-size:12px;color:var(--ink-soft);margin-bottom:16px">Annual spend composition · Input tax eligible per slab</div>
        ${d.gstSlabs.map(s => `
        <div style="margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <div>
              <div style="font-size:12.5px;font-weight:700">${s.slab}</div>
              <div style="font-size:10.5px;color:var(--ink-faint)">${s.category}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--teal)">₹${s.itc}Cr ITC</div>
              <div style="font-size:10px;color:var(--ink-faint)">₹${s.spend}Cr spend</div>
            </div>
          </div>
          <div class="prog-bar"><div class="prog-fill" style="width:${Math.round(s.spend/172.1*100)}%;background:${s.slab.startsWith('28')?'var(--purple)':s.slab.startsWith('18')?'var(--teal)':s.slab.startsWith('12')?'var(--blue)':'var(--green)'}"></div></div>
        </div>`).join('')}
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card" style="padding:20px;background:linear-gradient(135deg,rgba(255,153,0,.03),rgba(16,185,129,.03));border-color:rgba(255,153,0,.15)">
          <div style="font-size:15px;font-weight:700;margin-bottom:14px">🏦 Working Capital Intelligence</div>
          ${[
            ['Avg ITC Release Time','47 days','vs 7-day target','var(--red)'],
            ['High-Risk Suppliers','7 of 23','Non-filers or mismatches','var(--amber)'],
            ['ITC Pending Match','₹1.6Cr','GSTR-2B not yet available','var(--amber)'],
            ['Reversal Required','₹0.3Cr','Rule 42 reversal on mixed supply','var(--red)'],
            ['Interest Opportunity','₹0.18Cr/yr','SBI CC rate 8.5% · 40-day lag','var(--green)'],
          ].map(([l,v,s,c])=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-s)">
              <div>
                <div style="font-size:12.5px;font-weight:600">${l}</div>
                <div style="font-size:10.5px;color:var(--ink-faint);margin-top:1px">${s}</div>
              </div>
              <div style="font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:800;color:${c}">${v}</div>
            </div>`).join('')}
        </div>

        <div class="card" style="padding:18px;border-color:var(--border-m);background:rgba(13,148,136,.02)">
          <div style="font-size:14px;font-weight:700;margin-bottom:6px">🤖 AI Reconciliation Actions</div>
          <div style="font-size:12.5px;color:var(--ink-soft);line-height:1.65;margin-bottom:14px">Nervure AI auto-drafted vendor notices for 7 high-risk suppliers and pre-computed Section 16(4) deadline alerts for Q4 FY26.</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn btn-primary" style="font-size:12px" onclick="showAgentStatus('✓ 7 vendor notices auto-drafted · Pending CFO approval · GSTN API synced', 6000)">⚡ Draft Vendor Notices (7)</button>
            <button class="btn btn-ghost" style="font-size:12px" onclick="showAgentStatus('📅 Section 16(4) deadline alerts set for all FY26 periods', 5000)">📅 Set Deadline Alerts</button>
            <button class="btn btn-ghost" style="font-size:12px" onclick="showAgentStatus('⬇ ITC Reconciliation Statement (Form GSTR-9) ready for export', 5000)">⬇ Export GSTR-9 Draft</button>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

let gstChartBuilt = false;
function buildGSTEngine() {
  gstChartBuilt = true;
  // Could add chart here — for now the module is data-rich without it
  logAudit('GST ENGINE LOADED', 'GSTR-1 × GSTR-3B reconciliation · Jan–Mar 2026 · 6 mismatches detected', 'info');
}

function runGSTReconciliation() {
  showAgentStatus('⚡ GST Reconciliation Agent running · GSTN API sync · 23 suppliers · GSTR-2B matching…', 7000);
  setTimeout(() => {
    logAudit('GST AUTO-RECONCILIATION RAN', '23 suppliers matched · 7 HIGH risk flagged · ₹2.4Cr ITC at risk identified · 7 vendor notices drafted', 'warning', '₹2.4Cr');
    showAgentStatus('✓ Reconciliation complete · 7 high-risk suppliers flagged · ₹2.4Cr ITC at risk · Audit logged', 8000);
    updateAuditBadge();
  }, 3000);
}
// ── INIT ─────────────────────────────────────────────────────────────────────
// Patch sidebar after original DOMContentLoaded fires
window.addEventListener('load', function() {
  setTimeout(() => {
    buildSidebar(); // patched version adds new nav items
    updateAuditBadge();
    if (NS.auditLog.length === 0) {
      setTimeout(() => showAgentStatus('🚀 Nervure v5 — Hedging Engine · Elasticity Backbone · Promo Decomposition now live', 7000), 1200);
    } else {
      setTimeout(() => showAgentStatus(`📋 ${NS.auditLog.length} decisions loaded from previous session — state persisted ✓`, 6000), 1200);
    }
  }, 200);
});
</script>
</body>
</html>
